<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Deciphering Life: One Bit at a Time</title>
<link>https://rmflight.github.io/index.html</link>
<atom:link href="https://rmflight.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.2.269</generator>
<lastBuildDate>Sun, 11 Jun 2023 04:00:00 GMT</lastBuildDate>
<item>
  <title>Transcribing A File Using carelesswhisper</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2023-06-11-transcribing-a-file-using-carelesswhisper/index.html</link>
  <description><![CDATA[ 




<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TL;DR</h2>
<p>You can iterate through an audio file and transcribe it using the new <code>carelesswhisper</code> package <span class="citation" data-cites="cool_whisper">(coolbutuseless 2023)</span>.</p>
</section>
<section id="carelesswhisper" class="level2">
<h2 class="anchored" data-anchor-id="carelesswhisper">carelesswhisper</h2>
<p>If you don’t follow coolbutuseless on Mastodon, you are missing out, especially if you want to know about really intriguing R packages <span class="citation" data-cites="cool_mastodon">(coolbutuseless, n.d.)</span>. Just this week, they released a new R package built upon the <code>whisper</code> C library <span class="citation" data-cites="cool_whisper">(coolbutuseless 2023)</span>. Although I don’t do any actual work with audio, especially human audio that one might want to do automatic speech recognition or transcription with, I dug into it to see if it would be possible to actually transcribe a full audio file.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>We are going to need a few packages besides <code>carelesswhisper</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;"># for transcription</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(carelesswhisper)</span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;"># for converting from m4a</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">library</span>(av)</span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;"># for audio processing</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;">library</span>(tuneR)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'tuneR'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:av':

    sine</code></pre>
</div>
</div>
<p>We also need an audio file. I decided to download an episode of Holderness Family Laughs <span class="citation" data-cites="holderness_vacation">(Family 2023)</span>, and see if we can transcribe it. I used yt-dlp to download and convert to audio <span class="citation" data-cites="yt_dlp">(<span>“YT-DLP”</span> 2023)</span>.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;">yt-dlp</span> https://youtu.be/DFM4Ey5oyhI <span class="at" style="color: #657422;">-x</span> <span class="at" style="color: #657422;">--audio-format</span><span class="op" style="color: #5E5E5E;">=</span>m4a</span></code></pre></div>
</section>
<section id="conversion" class="level2">
<h2 class="anchored" data-anchor-id="conversion">Conversion</h2>
<p>Now, we don’t want to convert the whole thing, because it creates a giant piece of audio that will then have to be loaded into memory. Just our 5 minute Holderness episode is 69 MB on disk. So for longer pieces of audio it would be even worse. However, we can do piecewise conversion and transcription over the length of the file.</p>
<p>When we do the conversion, we do have to keep a couple of things in mind about what <code>carelesswhisper</code> expects. It wants single channel, 16 KHz files. This can be done during conversion. The other thing it expects is a range of values between -1 and 1. This we can take care of after conversion.</p>
<p>So we will write a function to do the conversion, read in the file, and do the transcription. We will also overlap the time steps by 2 seconds, so that if we cut a word off in a previous conversion, then we should get the full thing in the next one.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;"># generate time indexes for transcription</span></span>
<span id="cb5-2">split_time <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(audio_length)</span>
<span id="cb5-3">{</span>
<span id="cb5-4">  n_piece <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">ceiling</span>(audio_length <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">30</span>) <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb5-5">  out_time <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">vector</span>(<span class="st" style="color: #20794D;">"list"</span>, n_piece)</span>
<span id="cb5-6">  start_time <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb5-7">  <span class="cf" style="color: #003B4F;">for</span> (i_piece <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">seq_len</span>(n_piece)) {</span>
<span id="cb5-8">    <span class="cf" style="color: #003B4F;">if</span> (start_time <span class="sc" style="color: #5E5E5E;">&gt;</span> audio_length) {</span>
<span id="cb5-9">      <span class="cf" style="color: #003B4F;">break</span>()</span>
<span id="cb5-10">    }</span>
<span id="cb5-11">    out_time[[i_piece]] <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="at" style="color: #657422;">start =</span> start_time,</span>
<span id="cb5-12">                                         <span class="at" style="color: #657422;">end =</span> <span class="fu" style="color: #4758AB;">min</span>(<span class="fu" style="color: #4758AB;">c</span>(start_time <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">30</span>, audio_length)))</span>
<span id="cb5-13">    start_time <span class="ot" style="color: #003B4F;">=</span> start_time <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">28</span></span>
<span id="cb5-14">  }</span>
<span id="cb5-15">  </span>
<span id="cb5-16">  not_null <span class="ot" style="color: #003B4F;">=</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map_lgl</span>(out_time, \(x){<span class="sc" style="color: #5E5E5E;">!</span><span class="fu" style="color: #4758AB;">is.null</span>(x)})</span>
<span id="cb5-17">  out_time[not_null]</span>
<span id="cb5-18">}</span>
<span id="cb5-19"></span>
<span id="cb5-20"><span class="co" style="color: #5E5E5E;"># rescale the values in the wav object</span></span>
<span id="cb5-21">rescale_wav <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(wav_object)</span>
<span id="cb5-22">{</span>
<span id="cb5-23">  wav_values <span class="ot" style="color: #003B4F;">=</span> wav_object<span class="sc" style="color: #5E5E5E;">@</span>left</span>
<span id="cb5-24">  wav_range <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">max</span>(<span class="fu" style="color: #4758AB;">abs</span>(wav_values))</span>
<span id="cb5-25">  wav_sign <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sign</span>(wav_values)</span>
<span id="cb5-26">  wav_fraction <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">abs</span>(wav_values) <span class="sc" style="color: #5E5E5E;">/</span> wav_range</span>
<span id="cb5-27">  wav_convert <span class="ot" style="color: #003B4F;">=</span> wav_sign <span class="sc" style="color: #5E5E5E;">*</span> wav_fraction</span>
<span id="cb5-28">  wav_convert</span>
<span id="cb5-29">}</span>
<span id="cb5-30"></span>
<span id="cb5-31"><span class="co" style="color: #5E5E5E;"># do the actual conversion and transcription</span></span>
<span id="cb5-32">inner_convert_transcribe <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(time_index, audio_file, whisper_model)</span>
<span id="cb5-33">{</span>
<span id="cb5-34">  out_wav <span class="ot" style="color: #003B4F;">=</span> av<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">av_audio_convert</span>(audio_file, <span class="at" style="color: #657422;">output =</span> <span class="st" style="color: #20794D;">"tmp.wav"</span>, <span class="at" style="color: #657422;">channels =</span> <span class="dv" style="color: #AD0000;">1</span>,</span>
<span id="cb5-35">                                 <span class="at" style="color: #657422;">sample_rate =</span> <span class="dv" style="color: #AD0000;">16000</span>, <span class="at" style="color: #657422;">start_time =</span> time_index[<span class="st" style="color: #20794D;">"start"</span>],</span>
<span id="cb5-36">                                 <span class="at" style="color: #657422;">total_time =</span> time_index[<span class="st" style="color: #20794D;">"end"</span>] <span class="sc" style="color: #5E5E5E;">-</span> time_index[<span class="st" style="color: #20794D;">"start"</span>],</span>
<span id="cb5-37">                                 <span class="at" style="color: #657422;">verbose =</span> <span class="cn" style="color: #8f5902;">FALSE</span>)</span>
<span id="cb5-38">  in_audio <span class="ot" style="color: #003B4F;">=</span> tuneR<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">readWave</span>(<span class="st" style="color: #20794D;">"tmp.wav"</span>)</span>
<span id="cb5-39">  scaled_audio <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">rescale_wav</span>(in_audio)</span>
<span id="cb5-40">  transcribed <span class="ot" style="color: #003B4F;">=</span> carelesswhisper<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">whisper</span>(whisper_model, scaled_audio)</span>
<span id="cb5-41">  transcribed</span>
<span id="cb5-42">}</span>
<span id="cb5-43"></span>
<span id="cb5-44"><span class="co" style="color: #5E5E5E;"># convert an actual file</span></span>
<span id="cb5-45">convert_transcribe <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(audio_file)</span>
<span id="cb5-46">{</span>
<span id="cb5-47">  <span class="co" style="color: #5E5E5E;"># audio_file = "posts/2023-06-10-transcribing-a-file-using-carelesswhisper/20s vs 40s Vacation [DFM4Ey5oyhI].m4a"</span></span>
<span id="cb5-48">  audio_info <span class="ot" style="color: #003B4F;">=</span> av<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">av_media_info</span>(audio_file)</span>
<span id="cb5-49">  audio_length <span class="ot" style="color: #003B4F;">=</span> audio_info<span class="sc" style="color: #5E5E5E;">$</span>duration</span>
<span id="cb5-50">  </span>
<span id="cb5-51">  time_splits <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">split_time</span>(audio_length)</span>
<span id="cb5-52">  whisper_model <span class="ot" style="color: #003B4F;">=</span> carelesswhisper<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">whisper_init</span>()</span>
<span id="cb5-53">  transcribed_data <span class="ot" style="color: #003B4F;">=</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map</span>(time_splits,</span>
<span id="cb5-54">                                inner_convert_transcribe,</span>
<span id="cb5-55">                                audio_file,</span>
<span id="cb5-56">                                whisper_model)</span>
<span id="cb5-57">  <span class="fu" style="color: #4758AB;">file.remove</span>(<span class="st" style="color: #20794D;">"tmp.wav"</span>)</span>
<span id="cb5-58">  transcribed_data</span>
<span id="cb5-59">}</span></code></pre></div>
</div>
<p>OK, so we have our four files, lets see if we can run through the entire 5 minutes. And see how long it takes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">tictoc<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">tic</span>()</span>
<span id="cb6-2">audio_file <span class="ot" style="color: #003B4F;">=</span> <span class="st" style="color: #20794D;">"20s vs 40s Vacation [DFM4Ey5oyhI].m4a"</span></span>
<span id="cb6-3">holderness_transcribed <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">convert_transcribe</span>(audio_file)</span>
<span id="cb6-4">tictoc<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">toc</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>344.642 sec elapsed</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">holderness_transcribed[<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">3</span>)]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "I've accrue 3.4 vacation days after working at my job for an entire year. If we stay up the entire time, that's like a 10 day vacation. Okay, so we have the whole week off, but really it's 2.5 days. Who are we kidding? It takes me a couple of days to unwind and I'd like to come back by Friday so I can go grocery shopping at the laundry done. I mean, I'm not going to just jump back into my workway. After being around all you people, I'm going to need a day alone on my phone just in the dark. Okay, three bikinis, a cover up, and some heels. I'll pack, to know how to eat!"

[[2]]
[1] "heels, I'll pack to know how to, I need this bag. These are my good hats, I can't just put my good hats in with clothes, it'll ruin. This is my supplement, that's the bag full of stuff I know the kids are gonna forget because they pack like it is. It's like 12 pair of underwear, one pair of socks, and a sweater. We're going to the beat. This is the snack bag, we're not buying snacks when we get to the beat. I'm at pain, $10 for a bag of chips. Yeah. Gotta bring my good shampoo, that travel shampoo does not cut it."

[[3]]
[1] "who does not cut it. We need a shampoo bag. Yes, I do. I price line this hotel. If we split this one room between the 12 of us, it'll be super affordable. Let's go girls. Let's just get the same house we went to last year. I mean, I know that it costs more than a car, but everyone will get their own bathroom. Everyone needs their own space. For their special morning time, right babe? If we sleep, shoulder to shoulder, we can at least get four people on the bed. And easily eight on the floor, right here. Cook on Housekeeping and get"</code></pre>
</div>
</div>
<p>So this took just longer than the time of the video itself, which honestly isn’t too bad. The conversion of small bits of file, and then re-scaling to work with <code>whisper</code>, doesn’t seem to be imposing much overhead. Is the transcription perfect? No. Is it pretty decent? I think so, especially given that we can do it all locally, from our own audio file. The only other free way I know to do this is using “Voice Typing” in Google Docs, which is only accessible from the Chrome browser, and means putting your audio through Google’s servers.</p>
<p>Also, <code>carelesswhisper</code> default is to use the smallest possible model. There may be other models that will work on your machine, depending on how much RAM you have available. The <code>carelesswhisper</code> README mentions how to use other speech recognition models from the <code>whisper</code> website <span class="citation" data-cites="cool_whisper">(coolbutuseless 2023)</span>.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-cool_whisper" class="csl-entry">
coolbutuseless. 2023. <span>“Carelesswhisper.”</span> <a href="https://github.com/coolbutuseless/carelesswhisper">https://github.com/coolbutuseless/carelesswhisper</a>.
</div>
<div id="ref-cool_mastodon" class="csl-entry">
———. n.d. <a href="https://fosstodon.org/@coolbutuseless">https://fosstodon.org/@coolbutuseless</a>.
</div>
<div id="ref-holderness_vacation" class="csl-entry">
Family, Holderness. 2023. <span>“20s Vs 40s Vaction.”</span> <a href="https://youtu.be/DFM4Ey5oyhI">https://youtu.be/DFM4Ey5oyhI</a>.
</div>
<div id="ref-yt_dlp" class="csl-entry">
<span>“YT-DLP.”</span> 2023. <a href="https://github.com/yt-dlp/yt-dlp">https://github.com/yt-dlp/yt-dlp</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2023,
  author = {Robert M Flight},
  title = {Transcribing {A} {File} {Using} Carelesswhisper},
  date = {2023-06-11},
  url = {https://rmflight.github.io/posts/2023-06-11-transcribing-a-file-using-carelesswhisper},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2023" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2023. <span>“Transcribing A File Using
Carelesswhisper.”</span> June 11, 2023. <a href="https://rmflight.github.io/posts/2023-06-11-transcribing-a-file-using-carelesswhisper">https://rmflight.github.io/posts/2023-06-11-transcribing-a-file-using-carelesswhisper</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <category>audio</category>
  <guid>https://rmflight.github.io/posts/2023-06-11-transcribing-a-file-using-carelesswhisper/index.html</guid>
  <pubDate>Sun, 11 Jun 2023 04:00:00 GMT</pubDate>
</item>
<item>
  <title>Fast Kendall-tau Correlation with Rcpp</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2023-05-29-fast-kendalltau-correlation-with-rcpp/index.html</link>
  <description><![CDATA[ 




<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TL;DR</h2>
<p>Check out our <code>{ICIKendallTau}</code> R package if you want access to a fast version of Kendall-tau correlation in R <span class="citation" data-cites="iciktflight">(Robert M. Flight and Moseley 2022b)</span> with only a few dependencies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;"># remotes::install_github("moseleybioinformaticslab/icikendalltau)</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;"># install.packages("microbenchmark")</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(ICIKendallTau)</span></code></pre></div>
</div>
</section>
<section id="kendall-tau" class="level2">
<h2 class="anchored" data-anchor-id="kendall-tau">Kendall Tau??</h2>
<p>Yes, Kendall-tau correlation! It is a rank based correlation based on the number of concordant and discordant <strong>pairs</strong> of points. This graphic from Wikipedia explains it really well <span class="citation" data-cites="kendallwikipedia">(Wikipedia, n.d.)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">knitr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">include_graphics</span>(<span class="st" style="color: #20794D;">"Concordant_Points_Kendall_Correlation.svg"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-wikipedia-points" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2023-05-29-fast-kendalltau-correlation-with-rcpp/Concordant_Points_Kendall_Correlation.svg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: All points in the gray area are concordant and all points in the white area are discordant with respect to point X1, Y1. With n = 30 points, there are a total of 435 possible point pairs. In this example there are 395 concordant point pairs and 40 discordant point pairs, leading to a Kendall rank correlation coefficient of 0.816. <span class="citation" data-cites="kendallfigure">(Retodomax 2021)</span></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>This is a really useful correlation to use if you don’t want to have to worry about how linearly related things are, just whether the points from two samples go in the same direction or not. In addition, we think there is a neat variant we can make to incorporate the presence of missing values when they are missing not at random, and we have a preprint on that that I am working on revising <span class="citation" data-cites="flightInformationContentInformedKendalltauCorrelation2022a">(Robert M. Flight, Bhatt, and Moseley 2022)</span>.</p>
</section>
<section id="need-for-speed" class="level2">
<h2 class="anchored" data-anchor-id="need-for-speed">Need for Speed!</h2>
<p>However, there is an issue with the basic Kendall-tau algorithm. It is slower than molasses going uphill in January (as my parents used to say). Especially as we increase to correlations calculated using tens of thousands of features in both <em>x</em> and <em>y</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">x_large <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">10000</span>)</span>
<span id="cb3-2">y_large <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">10000</span>)</span>
<span id="cb3-3">microbenchmark<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">microbenchmark</span>(<span class="fu" style="color: #4758AB;">cor</span>(x_large, y_large, <span class="at" style="color: #657422;">method =</span> <span class="st" style="color: #20794D;">"kendall"</span>),</span>
<span id="cb3-4">                               <span class="at" style="color: #657422;">times =</span> <span class="dv" style="color: #AD0000;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: seconds
                                      expr      min       lq     mean   median
 cor(x_large, y_large, method = "kendall") 1.086599 1.104935 1.146724 1.127946
       uq      max neval
 1.137544 1.417044    20</code></pre>
</div>
</div>
<p>That took a full second! And the size of things we frequently want to calculate for eukaryotic based transcriptomics are 2X - 4X that size, and across many, many samples.</p>
<p>So if we can speed it up, that would be awesome.</p>
<p>I will note through all of this work, that I’ve already been through this once in the development of our <code>{ICIKendallTau}</code> package, so I already know the answer. However, I felt it would be useful to work through all of this again to help others who might be looking at similar types of problems. And yes, some of the below code seems silly, but they are first stabs at an implementation.</p>
</section>
<section id="differences-of-signs" class="level2">
<h2 class="anchored" data-anchor-id="differences-of-signs">Differences of Signs</h2>
<p>The simplest way to find the concordant and discordant pairs is to generate all the possible pair indices of the points, and then compare their directions; the same direction of a pair in both X and Y means they are concordant, and different directions means they are discordant.</p>
<p>And in fact, that is exactly what is happening in the C code for R’s covariance / correlation code, iterating over each pair of points (<code>k</code> and <code>n1</code>; snippet shown here from lines 108 - 118 of file src/library/stats/src/cov.c in R-4.3.0).</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><span class="cf" style="color: #003B4F;">else</span> <span class="op" style="color: #5E5E5E;">{</span> <span class="co" style="color: #5E5E5E;">/* Kendall's tau */</span>                      \</span>
<span id="cb5-2">    <span class="cf" style="color: #003B4F;">for</span><span class="op" style="color: #5E5E5E;">(</span>n1<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span> <span class="op" style="color: #5E5E5E;">;</span> n1 <span class="op" style="color: #5E5E5E;">&lt;</span> k <span class="op" style="color: #5E5E5E;">;</span> n1<span class="op" style="color: #5E5E5E;">++)</span>                   \</span>
<span id="cb5-3">        <span class="cf" style="color: #003B4F;">if</span><span class="op" style="color: #5E5E5E;">(!(</span>ISNAN<span class="op" style="color: #5E5E5E;">(</span>xx<span class="op" style="color: #5E5E5E;">[</span>n1<span class="op" style="color: #5E5E5E;">])</span> <span class="op" style="color: #5E5E5E;">||</span> ISNAN<span class="op" style="color: #5E5E5E;">(</span>yy<span class="op" style="color: #5E5E5E;">[</span>n1<span class="op" style="color: #5E5E5E;">])))</span> <span class="op" style="color: #5E5E5E;">{</span> \</span>
<span id="cb5-4">            xm <span class="op" style="color: #5E5E5E;">=</span> sign<span class="op" style="color: #5E5E5E;">(</span>xx<span class="op" style="color: #5E5E5E;">[</span>k<span class="op" style="color: #5E5E5E;">]</span> <span class="op" style="color: #5E5E5E;">-</span> xx<span class="op" style="color: #5E5E5E;">[</span>n1<span class="op" style="color: #5E5E5E;">]);</span>          \</span>
<span id="cb5-5">            ym <span class="op" style="color: #5E5E5E;">=</span> sign<span class="op" style="color: #5E5E5E;">(</span>yy<span class="op" style="color: #5E5E5E;">[</span>k<span class="op" style="color: #5E5E5E;">]</span> <span class="op" style="color: #5E5E5E;">-</span> yy<span class="op" style="color: #5E5E5E;">[</span>n1<span class="op" style="color: #5E5E5E;">]);</span>          \</span>
<span id="cb5-6">                                                \</span>
<span id="cb5-7">            COV_SUM_UPDATE                      \</span>
<span id="cb5-8">        <span class="op" style="color: #5E5E5E;">}</span>                                       \</span>
<span id="cb5-9"><span class="op" style="color: #5E5E5E;">}</span>                                               \</span></code></pre></div>
<section id="r-based-copy-all-pairs" class="level3">
<h3 class="anchored" data-anchor-id="r-based-copy-all-pairs">R Based, Copy All Pairs</h3>
<p>What can we do in R that is similar? We can generate all the pairwise indices, create actual vectors, and then get the signs of the differences maybe?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">reference_ici <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(x, y)</span>
<span id="cb6-2">{</span>
<span id="cb6-3">  n_x <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">length</span>(x)</span>
<span id="cb6-4">  n_y <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">length</span>(y)</span>
<span id="cb6-5">  pairs <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">combn</span>(n_x, <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb6-6">  x_pairs <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">rbind</span>(x[pairs[<span class="dv" style="color: #AD0000;">1</span>, ]],</span>
<span id="cb6-7">                  x[pairs[<span class="dv" style="color: #AD0000;">2</span>, ]])</span>
<span id="cb6-8">  y_pairs <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">rbind</span>(y[pairs[<span class="dv" style="color: #AD0000;">1</span>, ]],</span>
<span id="cb6-9">                  y[pairs[<span class="dv" style="color: #AD0000;">2</span>, ]])</span>
<span id="cb6-10">  x_sign <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sign</span>(x_pairs[<span class="dv" style="color: #AD0000;">1</span>, ] <span class="sc" style="color: #5E5E5E;">-</span> x_pairs[<span class="dv" style="color: #AD0000;">2</span>, ])</span>
<span id="cb6-11">  y_sign <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sign</span>(y_pairs[<span class="dv" style="color: #AD0000;">1</span>, ] <span class="sc" style="color: #5E5E5E;">-</span> y_pairs[<span class="dv" style="color: #AD0000;">2</span>, ])</span>
<span id="cb6-12">  x_y_sign <span class="ot" style="color: #003B4F;">=</span> x_sign <span class="sc" style="color: #5E5E5E;">*</span> y_sign</span>
<span id="cb6-13">  sum_concordant <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sum</span>(x_y_sign <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb6-14">  sum_discordant <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sum</span>(x_y_sign <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb6-15">  </span>
<span id="cb6-16">  x_is_dup <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">duplicated</span>(x)</span>
<span id="cb6-17">  x_dup <span class="ot" style="color: #003B4F;">=</span> x[x_is_dup]</span>
<span id="cb6-18">  x_tied_values_t1 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">table</span>(x_dup) <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>;</span>
<span id="cb6-19">  y_is_dup <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">duplicated</span>(y)</span>
<span id="cb6-20">  y_dup <span class="ot" style="color: #003B4F;">=</span> y[y_is_dup]</span>
<span id="cb6-21">  y_tied_values_t2 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">table</span>(y_dup) <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-22">  </span>
<span id="cb6-23">  x_tied_sum_t1 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sum</span>(x_tied_values_t1 <span class="sc" style="color: #5E5E5E;">*</span> (x_tied_values_t1 <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb6-24">  y_tied_sum_t2 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sum</span>(y_tied_values_t2 <span class="sc" style="color: #5E5E5E;">*</span> (y_tied_values_t2 <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb6-25">  t_0 <span class="ot" style="color: #003B4F;">=</span> n_x <span class="sc" style="color: #5E5E5E;">*</span> (n_x <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb6-26">  </span>
<span id="cb6-27">  k_denominator <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sqrt</span>((t_0 <span class="sc" style="color: #5E5E5E;">-</span> x_tied_sum_t1) <span class="sc" style="color: #5E5E5E;">*</span> (t_0 <span class="sc" style="color: #5E5E5E;">-</span> y_tied_sum_t2))</span>
<span id="cb6-28">  k_numerator <span class="ot" style="color: #003B4F;">=</span> sum_concordant <span class="sc" style="color: #5E5E5E;">-</span> sum_discordant</span>
<span id="cb6-29">  </span>
<span id="cb6-30">  k_tau <span class="ot" style="color: #003B4F;">=</span> k_numerator <span class="sc" style="color: #5E5E5E;">/</span> k_denominator</span>
<span id="cb6-31">  </span>
<span id="cb6-32">  k_tau</span>
<span id="cb6-33">}</span></code></pre></div>
</div>
<p>Let’s see how long this takes as a baseline, and how it compares to the <code>{stats::cor}</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;">set.seed</span>(<span class="dv" style="color: #AD0000;">1234</span>)</span>
<span id="cb7-2">x <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">1000</span>)</span>
<span id="cb7-3">y <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">1000</span>)</span>
<span id="cb7-4">microbenchmark<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">microbenchmark</span>(<span class="fu" style="color: #4758AB;">cor</span>(x, y, <span class="at" style="color: #657422;">method =</span> <span class="st" style="color: #20794D;">"kendall"</span>),</span>
<span id="cb7-5">                               <span class="fu" style="color: #4758AB;">reference_ici</span>(x, y),</span>
<span id="cb7-6">                               <span class="at" style="color: #657422;">times =</span> <span class="dv" style="color: #AD0000;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                          expr       min        lq      mean    median
 cor(x, y, method = "kendall")  11.44744  12.47315  12.84324  13.07735
           reference_ici(x, y) 351.74901 368.20867 392.19704 387.35215
        uq       max neval
  13.28316  13.63687    20
 417.69942 432.55782    20</code></pre>
</div>
</div>
<p>Not so great. Not that surprising, given the main correlation algorithm in R is written in C. Let’s see if we can speed that up. Although our code <strong>seems</strong> vectorized here, there is significant time taken in creating the large matrices to hold the pair indices, and then create the pairs themselves. Therefore, if we can avoid the creation of those large matrices, we can probably improve the speed.</p>
</section>
<section id="r-based-increment-count" class="level3">
<h3 class="anchored" data-anchor-id="r-based-increment-count">R Based, Increment Count</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">iterators_ici <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(x, y)</span>
<span id="cb9-2">{</span>
<span id="cb9-3">  n_entry <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">length</span>(x)</span>
<span id="cb9-4">  sum_concordant <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb9-5">  sum_discordant <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb9-6">  <span class="cf" style="color: #003B4F;">for</span> (i <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">1</span>, n_entry <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)) {</span>
<span id="cb9-7">    <span class="cf" style="color: #003B4F;">for</span> (j <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">seq</span>(i <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>, n_entry)) {</span>
<span id="cb9-8">      sum_concordant <span class="ot" style="color: #003B4F;">=</span> sum_concordant <span class="sc" style="color: #5E5E5E;">+</span>  ((<span class="fu" style="color: #4758AB;">sign</span>(x[i] <span class="sc" style="color: #5E5E5E;">-</span> x[j]) <span class="sc" style="color: #5E5E5E;">*</span> <span class="fu" style="color: #4758AB;">sign</span>(y[i] <span class="sc" style="color: #5E5E5E;">-</span> y[j])) <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb9-9">      sum_discordant <span class="ot" style="color: #003B4F;">=</span> sum_discordant <span class="sc" style="color: #5E5E5E;">+</span> ((<span class="fu" style="color: #4758AB;">sign</span>(x[i] <span class="sc" style="color: #5E5E5E;">-</span> x[j]) <span class="sc" style="color: #5E5E5E;">*</span> <span class="fu" style="color: #4758AB;">sign</span>(y[i] <span class="sc" style="color: #5E5E5E;">-</span> y[j])) <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb9-10">    }</span>
<span id="cb9-11">  }</span>
<span id="cb9-12">  k_numerator <span class="ot" style="color: #003B4F;">=</span> sum_concordant <span class="sc" style="color: #5E5E5E;">-</span> sum_discordant</span>
<span id="cb9-13">  </span>
<span id="cb9-14">  x_is_dup <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">duplicated</span>(x)</span>
<span id="cb9-15">  x_dup <span class="ot" style="color: #003B4F;">=</span> x[x_is_dup]</span>
<span id="cb9-16">  x_tied_values_t1 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">table</span>(x_dup) <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>;</span>
<span id="cb9-17">  y_is_dup <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">duplicated</span>(y)</span>
<span id="cb9-18">  y_dup <span class="ot" style="color: #003B4F;">=</span> y[y_is_dup]</span>
<span id="cb9-19">  y_tied_values_t2 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">table</span>(y_dup) <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb9-20">  </span>
<span id="cb9-21">  x_tied_sum_t1 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sum</span>(x_tied_values_t1 <span class="sc" style="color: #5E5E5E;">*</span> (x_tied_values_t1 <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb9-22">  y_tied_sum_t2 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sum</span>(y_tied_values_t2 <span class="sc" style="color: #5E5E5E;">*</span> (y_tied_values_t2 <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb9-23">  t_0 <span class="ot" style="color: #003B4F;">=</span> n_entry <span class="sc" style="color: #5E5E5E;">*</span> (n_entry <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb9-24">  </span>
<span id="cb9-25">  k_denominator <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sqrt</span>((t_0 <span class="sc" style="color: #5E5E5E;">-</span> x_tied_sum_t1) <span class="sc" style="color: #5E5E5E;">*</span> (t_0 <span class="sc" style="color: #5E5E5E;">-</span> y_tied_sum_t2))</span>
<span id="cb9-26">  k_numerator <span class="ot" style="color: #003B4F;">=</span> sum_concordant <span class="sc" style="color: #5E5E5E;">-</span> sum_discordant</span>
<span id="cb9-27">  </span>
<span id="cb9-28">  k_tau <span class="ot" style="color: #003B4F;">=</span> k_numerator <span class="sc" style="color: #5E5E5E;">/</span> k_denominator</span>
<span id="cb9-29">  </span>
<span id="cb9-30">  k_tau</span>
<span id="cb9-31">}</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">microbenchmark<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">microbenchmark</span>(<span class="fu" style="color: #4758AB;">cor</span>(x, y, <span class="at" style="color: #657422;">method =</span> <span class="st" style="color: #20794D;">"kendall"</span>),</span>
<span id="cb10-2">                               <span class="fu" style="color: #4758AB;">reference_ici</span>(x, y),</span>
<span id="cb10-3">                               <span class="fu" style="color: #4758AB;">iterators_ici</span>(x, y),</span>
<span id="cb10-4">                               <span class="at" style="color: #657422;">times =</span> <span class="dv" style="color: #AD0000;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                          expr       min        lq      mean    median
 cor(x, y, method = "kendall")  11.55812  12.49837  12.83441  12.69495
           reference_ici(x, y) 357.29120 371.24522 387.07048 378.65192
           iterators_ici(x, y) 279.28479 283.04712 289.51380 284.79317
        uq       max neval
  13.19846  14.45556    20
 403.50524 438.96896    20
 290.43204 335.47143    20</code></pre>
</div>
</div>
<p>Allright! We’ve got some decent improvement over our base attempt. We also know, thanks to the SciPy project, that there is a better way to do get the number of concordant and discordant pairs (which is what we use in <code>{ICIKendallTau}</code>). Let’s see if we can manage that in pure R, and see if it helps us out any.</p>
</section>
<section id="r-based-sort" class="level3">
<h3 class="anchored" data-anchor-id="r-based-sort">R Based, Sort</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">sort_ici <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(x, y)</span>
<span id="cb12-2">{</span>
<span id="cb12-3"></span>
<span id="cb12-4">  get_sort <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(values)</span>
<span id="cb12-5">  {</span>
<span id="cb12-6">    value_order <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">order</span>(values, <span class="at" style="color: #657422;">method =</span> <span class="st" style="color: #20794D;">"radix"</span>)</span>
<span id="cb12-7">  }</span>
<span id="cb12-8">  </span>
<span id="cb12-9">  compare_self <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(x){</span>
<span id="cb12-10">    n_entry <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">length</span>(x)</span>
<span id="cb12-11">    match_self <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">vector</span>(<span class="st" style="color: #20794D;">"integer"</span>, n_entry)</span>
<span id="cb12-12">    match_self[<span class="dv" style="color: #AD0000;">1</span>] <span class="ot" style="color: #003B4F;">=</span> 1L</span>
<span id="cb12-13">  </span>
<span id="cb12-14">    idx <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb12-15">  </span>
<span id="cb12-16">    <span class="cf" style="color: #003B4F;">for</span> (i <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">2</span>, n_entry)) {</span>
<span id="cb12-17">      <span class="cf" style="color: #003B4F;">if</span> (x[i] <span class="sc" style="color: #5E5E5E;">!=</span> x[(i <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)]) {</span>
<span id="cb12-18">        match_self[idx] <span class="ot" style="color: #003B4F;">=</span> 1L;</span>
<span id="cb12-19">      } <span class="cf" style="color: #003B4F;">else</span> {</span>
<span id="cb12-20">        match_self[idx] <span class="ot" style="color: #003B4F;">=</span> 0L;</span>
<span id="cb12-21">      }</span>
<span id="cb12-22">      idx <span class="ot" style="color: #003B4F;">=</span> idx <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb12-23">    }</span>
<span id="cb12-24">    <span class="fu" style="color: #4758AB;">return</span>(match_self)</span>
<span id="cb12-25">  }</span>
<span id="cb12-26">  </span>
<span id="cb12-27">  compare_both <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(x, y)</span>
<span id="cb12-28">  {</span>
<span id="cb12-29">    n_entry <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">length</span>(x)</span>
<span id="cb12-30">    match_self <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">vector</span>(<span class="st" style="color: #20794D;">"integer"</span>, n_entry <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb12-31">    match_self[<span class="dv" style="color: #AD0000;">1</span>] <span class="ot" style="color: #003B4F;">=</span> 1L</span>
<span id="cb12-32">    </span>
<span id="cb12-33">    idx <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb12-34">    </span>
<span id="cb12-35">    <span class="cf" style="color: #003B4F;">for</span> (i <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">2</span>, n_entry)) {</span>
<span id="cb12-36">      <span class="cf" style="color: #003B4F;">if</span> ((x[i] <span class="sc" style="color: #5E5E5E;">!=</span> x[(i <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)]) <span class="sc" style="color: #5E5E5E;">||</span> (y[i] <span class="sc" style="color: #5E5E5E;">!=</span> y[(i <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)])) {</span>
<span id="cb12-37">        match_self[idx] <span class="ot" style="color: #003B4F;">=</span> 1L</span>
<span id="cb12-38">      } <span class="cf" style="color: #003B4F;">else</span> {</span>
<span id="cb12-39">        match_self[idx] <span class="ot" style="color: #003B4F;">=</span> 0L</span>
<span id="cb12-40">      }</span>
<span id="cb12-41">      idx <span class="ot" style="color: #003B4F;">=</span> idx <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb12-42">    }</span>
<span id="cb12-43">    match_self[n_entry <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>] <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb12-44">    <span class="fu" style="color: #4758AB;">return</span>(match_self)</span>
<span id="cb12-45">  }</span>
<span id="cb12-46"></span>
<span id="cb12-47">  count_rank_tie <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(ranks)</span>
<span id="cb12-48">  {</span>
<span id="cb12-49">  </span>
<span id="cb12-50">    dup_ranks <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">duplicated</span>(ranks)</span>
<span id="cb12-51">    ranks2 <span class="ot" style="color: #003B4F;">=</span> ranks[dup_ranks]</span>
<span id="cb12-52">    number_tied <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">table</span>(ranks2) <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb12-53">    </span>
<span id="cb12-54">    <span class="fu" style="color: #4758AB;">return</span>(<span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">ntie =</span> <span class="fu" style="color: #4758AB;">sum</span>(number_tied <span class="sc" style="color: #5E5E5E;">*</span> (number_tied <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">2</span>,</span>
<span id="cb12-55">                <span class="at" style="color: #657422;">t0 =</span> <span class="fu" style="color: #4758AB;">sum</span>(number_tied <span class="sc" style="color: #5E5E5E;">*</span> (number_tied <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">*</span> (number_tied <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">2</span>)) <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">2</span>,</span>
<span id="cb12-56">                <span class="at" style="color: #657422;">t1 =</span> <span class="fu" style="color: #4758AB;">sum</span>(number_tied <span class="sc" style="color: #5E5E5E;">*</span> (number_tied <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">*</span> (<span class="dv" style="color: #AD0000;">2</span> <span class="sc" style="color: #5E5E5E;">*</span> number_tied <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">5</span>))))</span>
<span id="cb12-57">  }</span>
<span id="cb12-58">  </span>
<span id="cb12-59">  which_notzero <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(x){</span>
<span id="cb12-60">    notzero <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">vector</span>(<span class="st" style="color: #20794D;">"integer"</span>, <span class="fu" style="color: #4758AB;">length</span>(x))</span>
<span id="cb12-61">    idx <span class="ot" style="color: #003B4F;">=</span> 1L</span>
<span id="cb12-62">    </span>
<span id="cb12-63">    <span class="cf" style="color: #003B4F;">for</span> (i <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="fu" style="color: #4758AB;">length</span>(x))) {</span>
<span id="cb12-64">      <span class="cf" style="color: #003B4F;">if</span> (x[i] <span class="sc" style="color: #5E5E5E;">!=</span> <span class="dv" style="color: #AD0000;">0</span>) {</span>
<span id="cb12-65">        notzero[idx] <span class="ot" style="color: #003B4F;">=</span> i <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb12-66">        idx <span class="ot" style="color: #003B4F;">=</span> idx <span class="sc" style="color: #5E5E5E;">+</span> 1L</span>
<span id="cb12-67">      }</span>
<span id="cb12-68">    }</span>
<span id="cb12-69">    keep_loc <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">1</span>, idx <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb12-70">    notzero <span class="ot" style="color: #003B4F;">=</span> notzero[keep_loc]</span>
<span id="cb12-71">    <span class="fu" style="color: #4758AB;">return</span>(notzero)</span>
<span id="cb12-72">  }</span>
<span id="cb12-73">  </span>
<span id="cb12-74">  kendall_discordant <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(x, y){</span>
<span id="cb12-75">    <span class="co" style="color: #5E5E5E;">#x = x4</span></span>
<span id="cb12-76">    <span class="co" style="color: #5E5E5E;">#y = y4</span></span>
<span id="cb12-77">    sup <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">max</span>(y)</span>
<span id="cb12-78">    </span>
<span id="cb12-79">    arr <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">vector</span>(<span class="st" style="color: #20794D;">"integer"</span>, sup)</span>
<span id="cb12-80">    i <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb12-81">    k <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb12-82">    n <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">length</span>(x)</span>
<span id="cb12-83">    idx <span class="ot" style="color: #003B4F;">=</span> 1L</span>
<span id="cb12-84">    dis <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb12-85">    </span>
<span id="cb12-86">    <span class="cf" style="color: #003B4F;">while</span> (i <span class="sc" style="color: #5E5E5E;">&lt;</span> n) {</span>
<span id="cb12-87">      <span class="cf" style="color: #003B4F;">while</span> ((k <span class="sc" style="color: #5E5E5E;">&lt;</span> n) <span class="sc" style="color: #5E5E5E;">&amp;&amp;</span> (x[i <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>] <span class="sc" style="color: #5E5E5E;">==</span> x[k <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>])) {</span>
<span id="cb12-88">        dis <span class="ot" style="color: #003B4F;">=</span> dis <span class="sc" style="color: #5E5E5E;">+</span> i</span>
<span id="cb12-89">        idx <span class="ot" style="color: #003B4F;">=</span> y[k <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb12-90">        <span class="cf" style="color: #003B4F;">while</span> (idx <span class="sc" style="color: #5E5E5E;">!=</span> <span class="dv" style="color: #AD0000;">0</span>) {</span>
<span id="cb12-91">          dis <span class="ot" style="color: #003B4F;">=</span> dis <span class="sc" style="color: #5E5E5E;">-</span> arr[idx <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb12-92">          idx <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">bitwAnd</span>(idx, idx <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb12-93">        }</span>
<span id="cb12-94">        k <span class="ot" style="color: #003B4F;">=</span> k <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb12-95">      }</span>
<span id="cb12-96">      <span class="cf" style="color: #003B4F;">while</span> (i <span class="sc" style="color: #5E5E5E;">&lt;</span> k) {</span>
<span id="cb12-97">        idx <span class="ot" style="color: #003B4F;">=</span> y[i <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb12-98">        <span class="cf" style="color: #003B4F;">while</span> (idx <span class="sc" style="color: #5E5E5E;">&lt;</span> sup) {</span>
<span id="cb12-99">          arr[idx <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>] <span class="ot" style="color: #003B4F;">=</span> arr[idx <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>] <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb12-100">          idx <span class="ot" style="color: #003B4F;">=</span> idx <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">bitwAnd</span>(idx, (<span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">*</span>idx))</span>
<span id="cb12-101">        }</span>
<span id="cb12-102">        i <span class="ot" style="color: #003B4F;">=</span> i <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb12-103">      }</span>
<span id="cb12-104">    }</span>
<span id="cb12-105">    dis</span>
<span id="cb12-106">  }</span>
<span id="cb12-107"></span>
<span id="cb12-108"></span>
<span id="cb12-109">  n_entry <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">length</span>(x)</span>
<span id="cb12-110">  perm_y <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">get_sort</span>(y)</span>
<span id="cb12-111">  x <span class="ot" style="color: #003B4F;">=</span> x[perm_y]</span>
<span id="cb12-112">  y <span class="ot" style="color: #003B4F;">=</span> y[perm_y]</span>
<span id="cb12-113">  y3 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">compare_self</span>(y)</span>
<span id="cb12-114">  y4 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">cumsum</span>(y3)</span>
<span id="cb12-115">  </span>
<span id="cb12-116">  perm_x <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">get_sort</span>(x);</span>
<span id="cb12-117">  x <span class="ot" style="color: #003B4F;">=</span> x[perm_x]</span>
<span id="cb12-118">  y4 <span class="ot" style="color: #003B4F;">=</span> y4[perm_x]</span>
<span id="cb12-119">  x3 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">compare_self</span>(x)</span>
<span id="cb12-120">  x4 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">cumsum</span>(x3)</span>
<span id="cb12-121">  </span>
<span id="cb12-122">  obs <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">compare_both</span>(x4, y4)</span>
<span id="cb12-123">  sum_obs <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sum</span>(obs)</span>
<span id="cb12-124">  cnt <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">diff</span>(<span class="fu" style="color: #4758AB;">which_notzero</span>(obs))</span>
<span id="cb12-125">  dis <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">kendall_discordant</span>(x4, y4)</span>
<span id="cb12-126">  </span>
<span id="cb12-127">  ntie <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">sum</span>((cnt <span class="sc" style="color: #5E5E5E;">*</span> (cnt <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb12-128">  x_counts <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">count_rank_tie</span>(x4)</span>
<span id="cb12-129">  xtie <span class="ot" style="color: #003B4F;">=</span> x_counts[[<span class="dv" style="color: #AD0000;">1</span>]]</span>
<span id="cb12-130">  x0 <span class="ot" style="color: #003B4F;">=</span> x_counts[[<span class="dv" style="color: #AD0000;">2</span>]]</span>
<span id="cb12-131">  x1 <span class="ot" style="color: #003B4F;">=</span> x_counts[[<span class="dv" style="color: #AD0000;">3</span>]]</span>
<span id="cb12-132">  </span>
<span id="cb12-133">  y_counts <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">count_rank_tie</span>(y4)</span>
<span id="cb12-134">  ytie <span class="ot" style="color: #003B4F;">=</span> y_counts[[<span class="dv" style="color: #AD0000;">1</span>]]</span>
<span id="cb12-135">  y0 <span class="ot" style="color: #003B4F;">=</span> y_counts[[<span class="dv" style="color: #AD0000;">2</span>]]</span>
<span id="cb12-136">  y1 <span class="ot" style="color: #003B4F;">=</span> y_counts[[<span class="dv" style="color: #AD0000;">3</span>]]</span>
<span id="cb12-137">  </span>
<span id="cb12-138">  tot <span class="ot" style="color: #003B4F;">=</span> (n_entry <span class="sc" style="color: #5E5E5E;">*</span> (n_entry <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb12-139">  con_minus_dis <span class="ot" style="color: #003B4F;">=</span> tot <span class="sc" style="color: #5E5E5E;">-</span> xtie <span class="sc" style="color: #5E5E5E;">-</span> ytie <span class="sc" style="color: #5E5E5E;">+</span> ntie <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">2</span> <span class="sc" style="color: #5E5E5E;">*</span> dis</span>
<span id="cb12-140">  tau <span class="ot" style="color: #003B4F;">=</span> con_minus_dis <span class="sc" style="color: #5E5E5E;">/</span> <span class="fu" style="color: #4758AB;">sqrt</span>((tot <span class="sc" style="color: #5E5E5E;">-</span> xtie) <span class="sc" style="color: #5E5E5E;">*</span> (tot <span class="sc" style="color: #5E5E5E;">-</span> ytie))</span>
<span id="cb12-141">  <span class="fu" style="color: #4758AB;">return</span>(tau)</span>
<span id="cb12-142">}</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">microbenchmark<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">microbenchmark</span>(<span class="fu" style="color: #4758AB;">cor</span>(x, y, <span class="at" style="color: #657422;">method =</span> <span class="st" style="color: #20794D;">"kendall"</span>),</span>
<span id="cb13-2">                               <span class="fu" style="color: #4758AB;">reference_ici</span>(x, y),</span>
<span id="cb13-3">                               <span class="fu" style="color: #4758AB;">iterators_ici</span>(x, y),</span>
<span id="cb13-4">                               <span class="fu" style="color: #4758AB;">sort_ici</span>(x, y),</span>
<span id="cb13-5">                               <span class="at" style="color: #657422;">times =</span> <span class="dv" style="color: #AD0000;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                          expr        min        lq      mean     median
 cor(x, y, method = "kendall")  11.709530  12.33871  12.63373  12.488732
           reference_ici(x, y) 355.224637 367.46692 387.70370 374.809739
           iterators_ici(x, y) 273.673038 276.02535 280.80801 281.919287
                sort_ici(x, y)   8.760096   8.98937  13.48845   9.395173
        uq       max neval
  12.87524  14.06242    20
 421.60254 441.29727    20
 283.32639 289.62743    20
  10.02100  87.38422    20</code></pre>
</div>
</div>
<p>So, I thought I could implement the sorting method in R, and it would help. It helps, in that it looks like it gets back to C speed, in R. Which isn’t bad, but still isn’t great. This is more than likely because I don’t actually understand the sort based Kendall-tau algorithm on a theoretical level. I was able to copy it from the Python into <code>{Rcpp}</code>, and use a lot of debugging and test cases to make sure I had it implemented correctly, but there are things it is doing that I don’t understand algorithmically, which means I don’t know the best way to create an R-centric method for them. For this example, I literally just translated my previous <code>{Rcpp}</code> code into R, which of course doesn’t necessarily make for fast code.</p>
</section>
<section id="c-based-differences" class="level3">
<h3 class="anchored" data-anchor-id="c-based-differences">C++ Based, Differences</h3>
<p>As a reference, I also implemented the iterating differences algorithm in <code>{Rcpp}</code>. Note that this is not meant to be called by normal users of <code>{ICIKendallTau}</code>, we have it there as a reference to make sure that everything else is working properly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">microbenchmark<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">microbenchmark</span>(<span class="fu" style="color: #4758AB;">cor</span>(x, y, <span class="at" style="color: #657422;">method =</span> <span class="st" style="color: #20794D;">"kendall"</span>),</span>
<span id="cb15-2">                               <span class="fu" style="color: #4758AB;">reference_ici</span>(x, y),</span>
<span id="cb15-3">                               <span class="fu" style="color: #4758AB;">iterators_ici</span>(x, y),</span>
<span id="cb15-4">                               <span class="fu" style="color: #4758AB;">sort_ici</span>(x, y),</span>
<span id="cb15-5">                               ICIKendallTau<span class="sc" style="color: #5E5E5E;">:::</span><span class="fu" style="color: #4758AB;">ici_kt_pairs</span>(x, y),</span>
<span id="cb15-6">                               <span class="at" style="color: #657422;">times =</span> <span class="dv" style="color: #AD0000;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                               expr        min         lq       mean     median
      cor(x, y, method = "kendall")  11.829116  12.051790  12.872894  12.815848
                reference_ici(x, y) 347.066153 382.616886 400.650147 395.033647
                iterators_ici(x, y) 271.020774 273.111584 284.668516 274.988955
                     sort_ici(x, y)   8.978789   9.393873  10.498460  10.161402
 ICIKendallTau:::ici_kt_pairs(x, y)   4.336266   4.493440   4.806514   4.771994
         uq        max neval
  13.380157  14.977161    20
 418.945940 465.485468    20
 292.175271 342.778833    20
  11.554007  13.605138    20
   4.891025   6.397218    20</code></pre>
</div>
</div>
<p>We can see that is faster than the C-based <code>cor</code> by maybe 2X for 1000 long vectors. Given that <code>ici_kt_pairs</code> has only the single iterator logic for the one correlation method, that makes sense.</p>
</section>
<section id="c-based-sort" class="level3">
<h3 class="anchored" data-anchor-id="c-based-sort">C++ Based, Sort</h3>
<p>Let’s compare the actual sort-based function that is implemented in the <code>{ICIKendallTau}</code> package (which you can see in <span class="citation" data-cites="iciktcode">(Robert M. Flight and Moseley 2022a)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">microbenchmark<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">microbenchmark</span>(<span class="fu" style="color: #4758AB;">cor</span>(x, y, <span class="at" style="color: #657422;">method =</span> <span class="st" style="color: #20794D;">"kendall"</span>),</span>
<span id="cb17-2">                               <span class="fu" style="color: #4758AB;">reference_ici</span>(x, y),</span>
<span id="cb17-3">                               <span class="fu" style="color: #4758AB;">iterators_ici</span>(x, y),</span>
<span id="cb17-4">                               <span class="fu" style="color: #4758AB;">sort_ici</span>(x, y),</span>
<span id="cb17-5">                               <span class="fu" style="color: #4758AB;">ici_kt</span>(x, y),</span>
<span id="cb17-6">                               <span class="at" style="color: #657422;">times =</span> <span class="dv" style="color: #AD0000;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
                          expr        min          lq        mean     median
 cor(x, y, method = "kendall")  11922.472  12154.2850  12992.5719  12916.488
           reference_ici(x, y) 352612.664 380621.5915 399187.5410 393977.078
           iterators_ici(x, y) 266384.200 270873.1345 286840.9181 273214.937
                sort_ici(x, y)   8862.455   9607.5720  10356.4879  10301.072
                  ici_kt(x, y)    216.761    245.6465    273.3186    265.784
         uq        max neval
  13522.521  16085.135    20
 424152.088 444856.163    20
 289494.598 338773.242    20
  11140.300  12458.339    20
    291.693    367.443    20</code></pre>
</div>
</div>
<p>That’s fast! Notice the time moved from <em>milliseconds</em> to <em>microseconds</em>, and the <code>{ICIKendallTau}</code> version is ~ 50X faster than the base R version. Let’s increase the size of our vectors by 10X and compare the run times again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">x_large <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">10000</span>)</span>
<span id="cb19-2">y_large <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">10000</span>)</span>
<span id="cb19-3">microbenchmark<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">microbenchmark</span>(<span class="fu" style="color: #4758AB;">cor</span>(x, y, <span class="at" style="color: #657422;">method =</span> <span class="st" style="color: #20794D;">"kendall"</span>),</span>
<span id="cb19-4">                               <span class="fu" style="color: #4758AB;">cor</span>(x_large, y_large, <span class="at" style="color: #657422;">method =</span> <span class="st" style="color: #20794D;">"kendall"</span>),</span>
<span id="cb19-5">                               <span class="fu" style="color: #4758AB;">ici_kt</span>(x, y),</span>
<span id="cb19-6">                               <span class="fu" style="color: #4758AB;">ici_kt</span>(x_large, y_large),</span>
<span id="cb19-7">                               <span class="at" style="color: #657422;">times =</span> <span class="dv" style="color: #AD0000;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
                                      expr         min           lq
             cor(x, y, method = "kendall")   11654.425   11757.9275
 cor(x_large, y_large, method = "kendall") 1134471.513 1149212.6425
                              ici_kt(x, y)     211.174     228.8565
                  ici_kt(x_large, y_large)    2341.995    2370.5770
         mean      median          uq         max neval
   12088.3777   11816.745   12018.914   15825.794    20
 1201616.7482 1168728.874 1243587.177 1456530.477    20
     259.2706     247.703     265.988     531.182    20
    2643.4572    2392.539    2453.216    4024.673    20</code></pre>
</div>
</div>
<p>The base R method increases time taken by 100X, but the sort based method of <code>{ICIKendallTau}</code> increases only 10X. This is the advantage of the sort method, it’s complexity is <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BO%7D(n%5Clog%7B%7Dn))">, <em>vs</em> <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BO%7D(n%5E2)">.</p>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-flightInformationContentInformedKendalltauCorrelation2022a" class="csl-entry">
Flight, Robert M., Praneeth S. Bhatt, and Hunter NB Moseley. 2022. <span>“Information-<span>Content</span>-<span>Informed</span> <span>Kendall</span>-Tau <span>Correlation</span>: <span>Utilizing</span> <span>Missing</span> <span>Values</span>.”</span> <a href="https://doi.org/10.1101/2022.02.24.481854">https://doi.org/10.1101/2022.02.24.481854</a>.
</div>
<div id="ref-iciktcode" class="csl-entry">
Flight, Robert M, and Hunter NB Moseley. 2022a. <span>“Ici_kt Code.”</span> <a href="https://github.com/MoseleyBioinformaticsLab/ICIKendallTau/blob/main/src/kendallc.cpp#L131">https://github.com/MoseleyBioinformaticsLab/ICIKendallTau/blob/main/src/kendallc.cpp#L131</a>.
</div>
<div id="ref-iciktflight" class="csl-entry">
———. 2022b. <span>“ICI-Kt r Package.”</span> <a href="https://github.com/moseleybioinformaticslab/icikendalltau">https://github.com/moseleybioinformaticslab/icikendalltau</a>.
</div>
<div id="ref-kendallfigure" class="csl-entry">
Retodomax. 2021. <span>“Kendall-Tau Example Image.”</span> <a href="https://commons.wikimedia.org/wiki/File:Concordant_Points_Kendall_Correlation.svg">https://commons.wikimedia.org/wiki/File:Concordant_Points_Kendall_Correlation.svg</a>.
</div>
<div id="ref-kendallwikipedia" class="csl-entry">
Wikipedia. n.d. <span>“Kendall Rank Correlation Coefficient.”</span> <a href="https://en.wikipedia.org/wiki/Kendall_rank_correlation_coefficient">https://en.wikipedia.org/wiki/Kendall_rank_correlation_coefficient</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2023,
  author = {Robert M Flight},
  title = {Fast {Kendall-tau} {Correlation} with {Rcpp}},
  date = {2023-05-29},
  url = {https://rmflight.github.io/posts/2023-05-29-fast-kendalltau-correlation-with-rcpp},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2023" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2023. <span>“Fast Kendall-Tau Correlation with
Rcpp.”</span> May 29, 2023. <a href="https://rmflight.github.io/posts/2023-05-29-fast-kendalltau-correlation-with-rcpp">https://rmflight.github.io/posts/2023-05-29-fast-kendalltau-correlation-with-rcpp</a>.
</div></div></section></div> ]]></description>
  <category>c++</category>
  <category>R</category>
  <category>packages</category>
  <guid>https://rmflight.github.io/posts/2023-05-29-fast-kendalltau-correlation-with-rcpp/index.html</guid>
  <pubDate>Mon, 29 May 2023 04:00:00 GMT</pubDate>
</item>
<item>
  <title>targets and Safe Functions</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2023-05-08-targets-and-safe-functions/index.html</link>
  <description><![CDATA[ 




<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TL;DR</h2>
<p>If you are using the <code>{targets}</code> workflow manager for your analyses, and also using <code>{purrr::safely}</code> (or others) to control possible errors, do not do the simplest version of function replacement to make your function <code>safe</code>. See here for the final versions.</p>
</section>
<section id="targets" class="level2">
<h2 class="anchored" data-anchor-id="targets">targets</h2>
<p>A bit of an introduction, <code>{targets}</code> is a workflow manager written and managed completely in <code>R</code> <span class="citation" data-cites="wlandautargets">(Landau 2021)</span>. It is the second workfow manager written by the amazing William Landau. It keeps track of all the interdependencies amongst function inputs and outputs, files, etc, for you, and only reruns things that need to be rerun. This makes it easier to modularize a script into separate functions, and not worry about the order that things get run in, or which bits need to be rerun when you change things without rerunning the entire script.</p>
<p>If you are familiar with <code>{knitr}</code> cache’ing, it’s somewhat like that, but very beefed up, and not dependent on the document at all. Also, in my opinion, much smarter than <code>{knitr}</code> caches <span class="citation" data-cites="yihuicache">(Yihui Xie 2022)</span>.</p>
</section>
<section id="safely" class="level2">
<h2 class="anchored" data-anchor-id="safely">safely?</h2>
<p>Outside of iterations, another subset of functionality in <code>{purrr}</code> are various adverbs, or functions that modify the effect of another function <span class="citation" data-cites="hadleypurrr">(Wickham and Henry 2023)</span>. One of these is <code>safely</code>. From the help page:</p>
<blockquote class="blockquote">
<p>Creates a modified version of .f that always succeeds. It returns a list with components result and error. If the function succeeds, result contains the returned value and error is NULL. If an error occurred, error is an error object and result is either NULL or otherwise.</p>
</blockquote>
<p>As you can imagine, this is incredibly useful for handling error conditions without explicitly handling it within your own function. By the way, it is worth looking at the help page for <code>{purrr::safely}</code> just to see all the adverbs that <code>{purrr}</code> provides, some may be useful for you in other contexts.</p>
</section>
<section id="the-issue" class="level2">
<h2 class="anchored" data-anchor-id="the-issue">The Issue</h2>
<p>So, what happens if you try to use <code>{purrr::safely}</code> to modify a user defined function from within a <code>{targets}</code> workflow? It turns out, you have to be very careful <strong>how</strong> you incorporate <code>{purrr::safely}</code> into your workflow. If you do it wrong, then <code>{targets}</code> can’t tell you changed the underlying function, and won’t rerun the workflow. I do want to thank Neil Wright for bringing this up on Mastodon, as it’s not obvious what the best solution is or <strong>why</strong> this happens <span class="citation" data-cites="neilpost">(Wright 2023)</span>. I also note that Neil does post the solution in their next post.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>So this post assumes you have a recent version of <code>{targets}</code> installed (I’m using 1.0.0) as well as <code>{purrr}</code> (using 1.0.1). We are not going to setup a full <code>{targets}</code> workflow, but will use the functions <code>tar_deparse_safe</code> and <code>digest_obj64</code> (internal to <code>{targets}</code>), as that will illuminate the issues for us.</p>
</section>
<section id="initial-functions" class="level2">
<h2 class="anchored" data-anchor-id="initial-functions">Initial Functions</h2>
<p>So we need a few functions for this, ideally ones that will generate the same output, but that we can implement in a couple of different ways. Thanks to the fact that R is a statistical language, we can do that fairly easily. For example, we can make two functions for calculating the mean of a set of values. One doing the actual calculation, and another that simply wraps the built-in <code>mean</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">mean_by_hand <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(values)</span>
<span id="cb1-2">{</span>
<span id="cb1-3">  <span class="fu" style="color: #4758AB;">return</span>(</span>
<span id="cb1-4">    <span class="fu" style="color: #4758AB;">sum</span>(values) <span class="sc" style="color: #5E5E5E;">/</span> <span class="fu" style="color: #4758AB;">length</span>(values)</span>
<span id="cb1-5">  )</span>
<span id="cb1-6">}</span>
<span id="cb1-7"></span>
<span id="cb1-8">mean_builtin <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(values)</span>
<span id="cb1-9">{</span>
<span id="cb1-10">  <span class="fu" style="color: #4758AB;">return</span>(</span>
<span id="cb1-11">    <span class="fu" style="color: #4758AB;">mean</span>(values)</span>
<span id="cb1-12">  )</span>
<span id="cb1-13">}</span></code></pre></div>
</div>
<p>From these we can then wrap them in <code>safely</code> to make them better able to handle a possible error.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">safe_by_hand <span class="ot" style="color: #003B4F;">=</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">safely</span>(mean_by_hand)</span>
<span id="cb2-2"></span>
<span id="cb2-3">safe_builtin <span class="ot" style="color: #003B4F;">=</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">safely</span>(mean_builtin)</span></code></pre></div>
</div>
</section>
<section id="hashes" class="level2">
<h2 class="anchored" data-anchor-id="hashes">Hashes</h2>
<p>Now, for all of these, we can get the object hash that <code>{targets}</code> would use to tell when things changed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">hash_values <span class="ot" style="color: #003B4F;">=</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"by-hand"</span> <span class="ot" style="color: #003B4F;">=</span> mean_by_hand,</span>
<span id="cb3-2">                           <span class="st" style="color: #20794D;">"built-in"</span> <span class="ot" style="color: #003B4F;">=</span> mean_builtin,</span>
<span id="cb3-3">                           <span class="st" style="color: #20794D;">"safe-by-hand"</span> <span class="ot" style="color: #003B4F;">=</span> safe_by_hand,</span>
<span id="cb3-4">                           <span class="st" style="color: #20794D;">"safe-built-in"</span> <span class="ot" style="color: #003B4F;">=</span> safe_builtin),</span>
<span id="cb3-5">                         <span class="cf" style="color: #003B4F;">function</span>(.x){</span>
<span id="cb3-6">                           targets<span class="sc" style="color: #5E5E5E;">:::</span><span class="fu" style="color: #4758AB;">tar_deparse_safe</span>(.x) <span class="sc" style="color: #5E5E5E;">|&gt;</span> targets<span class="sc" style="color: #5E5E5E;">:::</span><span class="fu" style="color: #4758AB;">digest_chr64</span>()</span>
<span id="cb3-7">                         })</span>
<span id="cb3-8">hash_table <span class="ot" style="color: #003B4F;">=</span> tibble<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">as_tibble_row</span>(hash_values) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb3-9">  tidyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">pivot_longer</span>(<span class="at" style="color: #657422;">cols =</span> tidyselect<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">everything</span>(), <span class="at" style="color: #657422;">names_to =</span> <span class="st" style="color: #20794D;">"which"</span>, <span class="at" style="color: #657422;">values_to =</span> <span class="st" style="color: #20794D;">"hash"</span>)</span>
<span id="cb3-10">gt<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">gt</span>(hash_table)</span></code></pre></div>
<div class="cell-output-display">
<div id="tbl-initial-hashes" class="anchored">

<div id="toanicdput" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#toanicdput table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#toanicdput thead, #toanicdput tbody, #toanicdput tfoot, #toanicdput tr, #toanicdput td, #toanicdput th {
  border-style: none;
}

#toanicdput p {
  margin: 0;
  padding: 0;
}

#toanicdput .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#toanicdput .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#toanicdput .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#toanicdput .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#toanicdput .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#toanicdput .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#toanicdput .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#toanicdput .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#toanicdput .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#toanicdput .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#toanicdput .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#toanicdput .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#toanicdput .gt_spanner_row {
  border-bottom-style: hidden;
}

#toanicdput .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#toanicdput .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#toanicdput .gt_from_md > :first-child {
  margin-top: 0;
}

#toanicdput .gt_from_md > :last-child {
  margin-bottom: 0;
}

#toanicdput .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#toanicdput .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#toanicdput .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#toanicdput .gt_row_group_first td {
  border-top-width: 2px;
}

#toanicdput .gt_row_group_first th {
  border-top-width: 2px;
}

#toanicdput .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#toanicdput .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#toanicdput .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#toanicdput .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#toanicdput .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#toanicdput .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#toanicdput .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#toanicdput .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#toanicdput .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#toanicdput .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#toanicdput .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#toanicdput .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#toanicdput .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#toanicdput .gt_left {
  text-align: left;
}

#toanicdput .gt_center {
  text-align: center;
}

#toanicdput .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#toanicdput .gt_font_normal {
  font-weight: normal;
}

#toanicdput .gt_font_bold {
  font-weight: bold;
}

#toanicdput .gt_font_italic {
  font-style: italic;
}

#toanicdput .gt_super {
  font-size: 65%;
}

#toanicdput .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#toanicdput .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#toanicdput .gt_indent_1 {
  text-indent: 5px;
}

#toanicdput .gt_indent_2 {
  text-indent: 10px;
}

#toanicdput .gt_indent_3 {
  text-indent: 15px;
}

#toanicdput .gt_indent_4 {
  text-indent: 20px;
}

#toanicdput .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false"><caption>Table&nbsp;1:  Initial hashes of the various functions. </caption>
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="which">which</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="hash">hash</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="which" class="gt_row gt_left">by-hand</td>
<td headers="hash" class="gt_row gt_left">b3f5384d3554e21a</td></tr>
    <tr><td headers="which" class="gt_row gt_left">built-in</td>
<td headers="hash" class="gt_row gt_left">35321f32205c905b</td></tr>
    <tr><td headers="which" class="gt_row gt_left">safe-by-hand</td>
<td headers="hash" class="gt_row gt_left">00758262fad8ce25</td></tr>
    <tr><td headers="which" class="gt_row gt_left">safe-built-in</td>
<td headers="hash" class="gt_row gt_left">00758262fad8ce25</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
</div>
<p>As we can see from Table&nbsp;1, the two <code>safe</code> variants have <strong>identical</strong> hashes. If you look at the help page for <code>tar_cue</code>, you might see why:</p>
<blockquote class="blockquote">
<p>User-defined functions are hashed in the following way:</p>
<ol type="1">
<li><p>Deparse the function with <strong>targets:::tar_deparse_safe().</strong> This function computes a string representation of the function body and arguments. This string representation is invariant to changes in comments and whitespace, which means trivial changes to formatting do not cue targets to rerun.</p></li>
<li><p>Manually remove any literal pointers from the function string using targets:::mask_pointers(). Such pointers arise from inline compiled C/C++ functions.</p></li>
<li><p>Using static code analysis (i.e.&nbsp;tar_deps(), which is based on codetools::findGlobals()) identify any user-defined functions and global objects that the current function depends on. Append the hashes of those dependencies to the string representation of the current function.</p></li>
<li><p>Compute the hash of the final string representation using <strong>targets:::digest_chr64()</strong>.</p></li>
</ol>
</blockquote>
<p>See that bit about <strong>deparsing</strong> the function in step 1. What does that look like for the <code>safe</code> versions?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">targets<span class="sc" style="color: #5E5E5E;">:::</span><span class="fu" style="color: #4758AB;">tar_deparse_safe</span>(safe_by_hand)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "function (...) \ncapture_error(.f(...), otherwise, quiet)"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">targets<span class="sc" style="color: #5E5E5E;">:::</span><span class="fu" style="color: #4758AB;">tar_deparse_safe</span>(safe_builtin)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "function (...) \ncapture_error(.f(...), otherwise, quiet)"</code></pre>
</div>
</div>
<p>They have the same output! Now, I understand why the functions should look this way due to how they work, and I also understand why Will implemented the hashing of user defined functions this way as well. However, for our purposes, it makes things a teensy bit harder.</p>
</section>
<section id="better-functions" class="level2">
<h2 class="anchored" data-anchor-id="better-functions">Better Functions</h2>
<p>If we still want to use the magic of <code>safely</code> (and any likely some of the other <code>{purrr}</code> adverbs) while using <code>{targets}</code>, then we need to think about this problem a little more. One way to make sure that any changes to the function will be reflected in the hash is to embed the <code>safely</code> call <strong>within</strong> the function body.</p>
<p>In the next two functions, we can see that we’ve done just that. Note that right now, we are concentrating on making functions that do the same thing, in a <em>safe</em> way, but their deparsed hash will be different.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">safe_by_hand_v2 <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(values)</span>
<span id="cb8-2">{</span>
<span id="cb8-3">  internal_byhand <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(values)</span>
<span id="cb8-4">  {</span>
<span id="cb8-5">    <span class="fu" style="color: #4758AB;">sum</span>(values) <span class="sc" style="color: #5E5E5E;">/</span> <span class="fu" style="color: #4758AB;">length</span>(values)</span>
<span id="cb8-6">  }</span>
<span id="cb8-7">  safe_internal <span class="ot" style="color: #003B4F;">=</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">safely</span>(internal_byhand)</span>
<span id="cb8-8">  <span class="fu" style="color: #4758AB;">return</span>(</span>
<span id="cb8-9">    <span class="fu" style="color: #4758AB;">safe_internal</span>(values)</span>
<span id="cb8-10">  )</span>
<span id="cb8-11">}</span>
<span id="cb8-12"></span>
<span id="cb8-13">safe_builtin_v2 <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(values)</span>
<span id="cb8-14">{</span>
<span id="cb8-15">  safe_builtin <span class="ot" style="color: #003B4F;">=</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">safely</span>(mean)</span>
<span id="cb8-16">  <span class="fu" style="color: #4758AB;">return</span>(</span>
<span id="cb8-17">    <span class="fu" style="color: #4758AB;">safe_builtin</span>(values)</span>
<span id="cb8-18">  )</span>
<span id="cb8-19">}</span></code></pre></div>
</div>
</section>
<section id="more-hashes" class="level2">
<h2 class="anchored" data-anchor-id="more-hashes">More Hashes</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">hash_values2 <span class="ot" style="color: #003B4F;">=</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"safe-by-hand-v2"</span> <span class="ot" style="color: #003B4F;">=</span> safe_by_hand_v2,</span>
<span id="cb9-2">                           <span class="st" style="color: #20794D;">"safe-built-in-v2"</span> <span class="ot" style="color: #003B4F;">=</span> safe_builtin_v2),</span>
<span id="cb9-3">                         <span class="cf" style="color: #003B4F;">function</span>(.x){</span>
<span id="cb9-4">                           targets<span class="sc" style="color: #5E5E5E;">:::</span><span class="fu" style="color: #4758AB;">tar_deparse_safe</span>(.x) <span class="sc" style="color: #5E5E5E;">|&gt;</span> targets<span class="sc" style="color: #5E5E5E;">:::</span><span class="fu" style="color: #4758AB;">digest_chr64</span>()</span>
<span id="cb9-5">                         })</span>
<span id="cb9-6">hash_table2 <span class="ot" style="color: #003B4F;">=</span> tibble<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">as_tibble_row</span>(hash_values2) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb9-7">  tidyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">pivot_longer</span>(<span class="at" style="color: #657422;">cols =</span> tidyselect<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">everything</span>(), <span class="at" style="color: #657422;">names_to =</span> <span class="st" style="color: #20794D;">"which"</span>, <span class="at" style="color: #657422;">values_to =</span> <span class="st" style="color: #20794D;">"hash"</span>)</span>
<span id="cb9-8">gt<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">gt</span>(dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">bind_rows</span>(hash_table, hash_table2))</span></code></pre></div>
<div class="cell-output-display">
<div id="tbl-more-hashes" class="anchored">

<div id="mdfaqlbccq" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#mdfaqlbccq table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#mdfaqlbccq thead, #mdfaqlbccq tbody, #mdfaqlbccq tfoot, #mdfaqlbccq tr, #mdfaqlbccq td, #mdfaqlbccq th {
  border-style: none;
}

#mdfaqlbccq p {
  margin: 0;
  padding: 0;
}

#mdfaqlbccq .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#mdfaqlbccq .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#mdfaqlbccq .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#mdfaqlbccq .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#mdfaqlbccq .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#mdfaqlbccq .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mdfaqlbccq .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#mdfaqlbccq .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#mdfaqlbccq .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#mdfaqlbccq .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#mdfaqlbccq .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#mdfaqlbccq .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#mdfaqlbccq .gt_spanner_row {
  border-bottom-style: hidden;
}

#mdfaqlbccq .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#mdfaqlbccq .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#mdfaqlbccq .gt_from_md > :first-child {
  margin-top: 0;
}

#mdfaqlbccq .gt_from_md > :last-child {
  margin-bottom: 0;
}

#mdfaqlbccq .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#mdfaqlbccq .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#mdfaqlbccq .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#mdfaqlbccq .gt_row_group_first td {
  border-top-width: 2px;
}

#mdfaqlbccq .gt_row_group_first th {
  border-top-width: 2px;
}

#mdfaqlbccq .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#mdfaqlbccq .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#mdfaqlbccq .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#mdfaqlbccq .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mdfaqlbccq .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#mdfaqlbccq .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#mdfaqlbccq .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#mdfaqlbccq .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#mdfaqlbccq .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mdfaqlbccq .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#mdfaqlbccq .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#mdfaqlbccq .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#mdfaqlbccq .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#mdfaqlbccq .gt_left {
  text-align: left;
}

#mdfaqlbccq .gt_center {
  text-align: center;
}

#mdfaqlbccq .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#mdfaqlbccq .gt_font_normal {
  font-weight: normal;
}

#mdfaqlbccq .gt_font_bold {
  font-weight: bold;
}

#mdfaqlbccq .gt_font_italic {
  font-style: italic;
}

#mdfaqlbccq .gt_super {
  font-size: 65%;
}

#mdfaqlbccq .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#mdfaqlbccq .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#mdfaqlbccq .gt_indent_1 {
  text-indent: 5px;
}

#mdfaqlbccq .gt_indent_2 {
  text-indent: 10px;
}

#mdfaqlbccq .gt_indent_3 {
  text-indent: 15px;
}

#mdfaqlbccq .gt_indent_4 {
  text-indent: 20px;
}

#mdfaqlbccq .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false"><caption>Table&nbsp;2:  More hashes of the safe variants from the above functions. </caption>
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="which">which</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="hash">hash</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="which" class="gt_row gt_left">by-hand</td>
<td headers="hash" class="gt_row gt_left">b3f5384d3554e21a</td></tr>
    <tr><td headers="which" class="gt_row gt_left">built-in</td>
<td headers="hash" class="gt_row gt_left">35321f32205c905b</td></tr>
    <tr><td headers="which" class="gt_row gt_left">safe-by-hand</td>
<td headers="hash" class="gt_row gt_left">00758262fad8ce25</td></tr>
    <tr><td headers="which" class="gt_row gt_left">safe-built-in</td>
<td headers="hash" class="gt_row gt_left">00758262fad8ce25</td></tr>
    <tr><td headers="which" class="gt_row gt_left">safe-by-hand-v2</td>
<td headers="hash" class="gt_row gt_left">8259616adc47b8cc</td></tr>
    <tr><td headers="which" class="gt_row gt_left">safe-built-in-v2</td>
<td headers="hash" class="gt_row gt_left">b35ae69ffbd4ec65</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
</div>
<p>As shown in Table&nbsp;2, now we see different hashes, even though our functions are <code>safe</code>, and generate the same results, as long as we don’t have any overflow or underflow issues.</p>
</section>
<section id="changing-the-referenced-function" class="level2">
<h2 class="anchored" data-anchor-id="changing-the-referenced-function">Changing the Referenced Function</h2>
<p>The <code>{targets}</code> documentation notes that it is also examining the dependent user defined functions and then concatenating the hashes together to check for changes to the overall set of functions being called. This is hard to show here in our simple post, but I’ve verified that it does indeed work for our specific case <span class="citation" data-cites="rmflightdiff">(Flight 2023)</span>.</p>
<p>We can imagine this pair of functions to make a safe version:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">mean_function <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(values)</span>
<span id="cb10-2">{</span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;">return</span>(</span>
<span id="cb10-4">    <span class="fu" style="color: #4758AB;">mean</span>(values)</span>
<span id="cb10-5">  )</span>
<span id="cb10-6">}</span>
<span id="cb10-7"></span>
<span id="cb10-8">safe_mean <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(values)</span>
<span id="cb10-9">{</span>
<span id="cb10-10">  safe_version <span class="ot" style="color: #003B4F;">=</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">safely</span>(mean_function)</span>
<span id="cb10-11">  <span class="fu" style="color: #4758AB;">return</span>(</span>
<span id="cb10-12">    <span class="fu" style="color: #4758AB;">safe_version</span>(values)</span>
<span id="cb10-13">  )</span>
<span id="cb10-14">}</span></code></pre></div>
</div>
<p>If we change our <code>mean_function</code> to something different, <code>{targets}</code> will pick up the changes and change the hash accordingly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">mean_function <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(values)</span>
<span id="cb11-2">{</span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;">return</span>(</span>
<span id="cb11-4">    <span class="fu" style="color: #4758AB;">sum</span>(values) <span class="sc" style="color: #5E5E5E;">/</span> <span class="fu" style="color: #4758AB;">length</span>(values)</span>
<span id="cb11-5">  )</span>
<span id="cb11-6">}</span></code></pre></div>
</div>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>If you want <code>{targets}</code> to pick up on changes to your functions, it helps to understand exactly how <code>{targets}</code> is generating hashable representations of your user defined functions, and what gets returned by them. Thankfully, it does not require much more in terms of lines of code to make sure that <code>{targets}</code> picks up on your changed function definition.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-rmflightdiff" class="csl-entry">
Flight, Robert M. 2023. <span>“Diff of Two Commits in a Targets Workflow.”</span> <a href="https://fediscience.org/@neilstats/110312534619119343">https://fediscience.org/@neilstats/110312534619119343</a>.
</div>
<div id="ref-wlandautargets" class="csl-entry">
Landau, William Michael. 2021. <span>“The Targets r Package: A Dynamic Make-Like Function-Oriented Pipeline Toolkit for Reproducibility and High-Performance Computing.”</span> <em>Journal of Open Source Software</em> 6 (57): 2959. <a href="https://doi.org/10.21105/joss.02959">https://doi.org/10.21105/joss.02959</a>.
</div>
<div id="ref-hadleypurrr" class="csl-entry">
Wickham, Hadley, and Lionel Henry. 2023. <em>Purrr: Functional Programming Tools</em>. <a href="https://CRAN.R-project.org/package=purrr">https://CRAN.R-project.org/package=purrr</a>.
</div>
<div id="ref-neilpost" class="csl-entry">
Wright, Neil. 2023. <span>“Neil Wright on Fedi Science.”</span> <a href="https://fediscience.org/@neilstats/110312534619119343">https://fediscience.org/@neilstats/110312534619119343</a>.
</div>
<div id="ref-yihuicache" class="csl-entry">
Yihui Xie, Emily Riederer, Christophe Dervieux. 2022. <em>R Markdown Cookbook</em>. <a href="https://bookdown.org/yihui/rmarkdown-cookbook/cache.html">https://bookdown.org/yihui/rmarkdown-cookbook/cache.html</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2023,
  author = {Robert M Flight},
  title = {Targets and {Safe} {Functions}},
  date = {2023-05-08},
  url = {https://rmflight.github.io/posts/2023-05-08-targets-and-safe-functions},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2023" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2023. <span>“Targets and Safe Functions.”</span> May 8,
2023. <a href="https://rmflight.github.io/posts/2023-05-08-targets-and-safe-functions">https://rmflight.github.io/posts/2023-05-08-targets-and-safe-functions</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <category>targets</category>
  <category>workflow</category>
  <category>purrr</category>
  <guid>https://rmflight.github.io/posts/2023-05-08-targets-and-safe-functions/index.html</guid>
  <pubDate>Mon, 08 May 2023 04:00:00 GMT</pubDate>
</item>
<item>
  <title>Blog Posts as Email Newsletters</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2023-01-19-blog-posts-as-email-newsletters/index.html</link>
  <description><![CDATA[ 




<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TL;DR</h2>
<p>Want to be able to have people subscribe to your blog via email? Check out the <code>{blog2newsletter}</code> package on GitHub <span class="citation" data-cites="blog2newsletter">(Flight, n.d.)</span>.</p>
</section>
<section id="a-newsletter-really" class="level2">
<h2 class="anchored" data-anchor-id="a-newsletter-really">A Newsletter? Really?</h2>
<p>OK, so hear me out. For some reason, if a newsletter shows up in my email inbox, I’m much more likely to read it. For example, I subscribe to Bob Rudis awesome Daily Drops <span class="citation" data-cites="dailydrop">(Rudis, n.d.)</span>, and they almost always get read right when they come in. Let’s be honest, SubStack has definitely made email newsletters popular. However, while I’m interested in making my blog available to people in other ways, I’m not going to use something like SubStack’s platform to do it (Bob Rudis has frequently complained about the formatting options in the SubStack editor, for instance).</p>
</section>
<section id="the-power-of-r-to-the-rescue" class="level2">
<h2 class="anchored" data-anchor-id="the-power-of-r-to-the-rescue">The Power of R to the Rescue!</h2>
<p>Now, I’ll admit, Google is another “platform”, but it’s one with a well known and documented API, with awesome R packages to interact with the APIs. For example, <code>{gmailr}</code> lets us compose, draft, and send emails from our GMail accounts <span class="citation" data-cites="gmailr">(Hester and Bryan, n.d.)</span>. <code>{googlesheets4}</code> provides access to Google Sheets, like those used to store reponses to Google Forms <span class="citation" data-cites="googlesheets4">(Bryan, n.d.)</span>.</p>
<p>With these packages, we can cobble together another package that provides functions to send blog posts as email newsletters! And thus my holiday break project was born!</p>
<p>Caveats, I don’t know the API limits for GMail, but I’m sure there isn’t really a limit to how many people can be <code>bcc'ed</code> on a single email. Also, Google could theoretically shut down API access to GMail and Google Sheets tomorrow, but that seems really, really unlikely.</p>
</section>
<section id="blog2newsletter-package" class="level2">
<h2 class="anchored" data-anchor-id="blog2newsletter-package">blog2newsletter Package</h2>
<p>It’s taken longer than I wanted to finish it off, but I think <code>{blog2newsletter}</code> is finally ready for primetime (and if you are one of the two subscribers to my blog, then you know it is because you received this post as an email) <span class="citation" data-cites="blog2newsletter">(Flight, n.d.)</span>. The <a href="https://rmflight.github.io/blog2newsletter/">README</a> of the package goes into great detail of how to set up all the prerequisites and use it.</p>
<p>The basic workflow, is this:</p>
<ul>
<li>have a blog with an RSS feed with full posts included in the RSS (default for <code>{quarto}</code> blogs with RSS enabled);</li>
<li>have a Google project that you have the secrets for;</li>
<li>authorize <code>{gmailr}</code> and <code>{googlesheets4}</code> to access the Google API for your Google project;</li>
<li>have a Google Sheet storing subscriber information from a Google Form (like <a href="https://forms.gle/yEJ8gdzPHLQUmzpdA">this form</a>);</li>
<li>create a script that checks for subscribers, gets the post, and composes and sends the email.</li>
</ul>
<p>The package doesn’t have that many functions, honestly. I’m very thankful that <code>{gmailr}</code> and <code>{googlesheets4}</code> handled all the Google specific stuff, and then <code>{tidyRSS}</code> provides all the functionality I needed for taking a blog post and putting it in a format that emails nicely <span class="citation" data-cites="tidyrss">(McDonnell 2022)</span>!</p>
<p>The use of <code>{tidyrss}</code> also means that you don’t have to actually use an R based blogging platform either to use <code>{blog2newsletter}</code>! You just need an RSS feed with the full posts in it! That can be a local file in the case of a statically generated blog, or the URL of your RSS feed for something generated / hosted by WordPress, for example.</p>
<p>The other major consideration was being able to cache a local copy of the subscriber list, as well as what newsletters were previously sent so that you don’t accidentally resend the same blog post 20 times. We use simple <code>rds</code> files in a cache directory for this.</p>
</section>
<section id="example-script" class="level2">
<h2 class="anchored" data-anchor-id="example-script">Example Script</h2>
<p>Here I’m going to break down the example script <code>_blog2newsletter.R</code> from the README. In a real directory / project being used to manage this, this is what we would run using <code>b2n_run()</code>.</p>
<p>At the top, we load the needed packages, and set a bunch of variables, including where the Google project secrets are stored, and where <code>{gargle}</code> should be putting the oauth tokens, and then loading the authorization tokens:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(gmailr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(googlesheets4)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(blog2newsletter)</span>
<span id="cb1-4">secrets_path <span class="ot" style="color: #003B4F;">=</span> <span class="st" style="color: #20794D;">"secrets/client_secret_file_googleusercontent.com.json"</span></span>
<span id="cb1-5">oauth_cache <span class="ot" style="color: #003B4F;">=</span> <span class="st" style="color: #20794D;">"secrets/gargle_cache/"</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;"># don't forget to use your actual email</span></span>
<span id="cb1-8">my_gmail <span class="ot" style="color: #003B4F;">=</span> <span class="st" style="color: #20794D;">"my-gmail@gmail.com"</span></span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;">options</span>(</span>
<span id="cb1-11">  <span class="at" style="color: #657422;">gargle_oauth_cache =</span> oauth_cache,</span>
<span id="cb1-12">  <span class="at" style="color: #657422;">gargle_oauth_email =</span> secrets_path</span>
<span id="cb1-13">)</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="fu" style="color: #4758AB;">gm_auth_configure</span>(<span class="at" style="color: #657422;">path  =</span> secrets_path)</span>
<span id="cb1-16"><span class="fu" style="color: #4758AB;">gm_auth</span>(<span class="at" style="color: #657422;">scopes =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"compose"</span>, <span class="st" style="color: #20794D;">"send"</span>), </span>
<span id="cb1-17">        <span class="at" style="color: #657422;">email =</span> my_gmail)</span>
<span id="cb1-18"></span>
<span id="cb1-19"><span class="fu" style="color: #4758AB;">gs4_auth_configure</span>(<span class="at" style="color: #657422;">path =</span> secrets_path)</span>
<span id="cb1-20"><span class="fu" style="color: #4758AB;">gs4_auth</span>(</span>
<span id="cb1-21">  <span class="at" style="color: #657422;">scopes =</span> <span class="st" style="color: #20794D;">"https://www.googleapis.com/auth/spreadsheets.readonly"</span>,</span>
<span id="cb1-22">  <span class="at" style="color: #657422;">email =</span> my_gmail)</span></code></pre></div>
<p>The bottom half starts with setting a variable for the blog directory (for <code>{quarto}</code> blogs) or alternatively where to find the RSS file directly. Then setting the Google Sheet id and grabbing the subscribers. Finally, what should be pre-pended to the email subject before the blog post title.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;"># switch from directory, full path to index.xml, or url as needed</span></span>
<span id="cb2-2">blog_dir <span class="ot" style="color: #003B4F;">=</span> <span class="st" style="color: #20794D;">"blog/directory"</span></span>
<span id="cb2-3"></span>
<span id="cb2-4">subscribers_id <span class="ot" style="color: #003B4F;">=</span> <span class="st" style="color: #20794D;">"your-sheet-id"</span></span>
<span id="cb2-5">subscriber_data <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">b2n_fetch_subscribers</span>(subscribers_id)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;"># newsletter subject</span></span>
<span id="cb2-8">extra_subject <span class="ot" style="color: #003B4F;">=</span> <span class="st" style="color: #20794D;">"my newsletter"</span></span>
<span id="cb2-9"></span>
<span id="cb2-10">blog_dir <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb2-11">  <span class="fu" style="color: #4758AB;">b2n_post_to_email</span>() <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb2-12">  <span class="fu" style="color: #4758AB;">b2n_add_subscribers</span>(subscriber_data) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb2-13">  <span class="fu" style="color: #4758AB;">b2n_from</span>(my_gmail) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb2-14">  <span class="fu" style="color: #4758AB;">b2n_add_subject</span>(extra_subject) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb2-15">  <span class="fu" style="color: #4758AB;">b2n_send_newsletter</span>()</span></code></pre></div>
<p>If you want to see what the composed email looks like <strong>before</strong> sending it, then you can use the <code>b2n_draft_email</code> instead of <code>b2n_send_newsletter</code>, and if you’ve got the right authorizations setup, then the email will show up in your GMail drafts.</p>
</section>
<section id="semi-automatic" class="level2">
<h2 class="anchored" data-anchor-id="semi-automatic">Semi-Automatic</h2>
<p>Finally, something like this would be a pain to type all that out everytime you wanted to send a new newsletter. This is part of the reason the default post to grab is the <strong>latest</strong> post that is available in the RSS feed. With that, it’s trivial to have a single script that is run each time you want to send out your latest available blog post. To help with this, there is the <code>b2n_run</code> function, that by default looks for <code>_blog2newsletter.R</code>, and <code>source</code>’s it.</p>
<p>Therefore, you just need a project / directory for the subscription management, with the cache and the above script, and when you have a new blog post up, just do <code>blog2newsletter::b2n_run()</code>, and the post will be sent out if there are subscribers with matching categories.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-googlesheets4" class="csl-entry">
Bryan, Jenny. n.d. <span>“Googlesheets4 Package.”</span> <a href="https://googlesheets4.tidyverse.org/">https://googlesheets4.tidyverse.org/</a>.
</div>
<div id="ref-blog2newsletter" class="csl-entry">
Flight, Robert M. n.d. <span>“Blog2newsletter Package.”</span> <a href="https://rmflight.github.io/blog2newsletter">https://rmflight.github.io/blog2newsletter</a>.
</div>
<div id="ref-gmailr" class="csl-entry">
Hester, Jim, and Jenny Bryan. n.d. <span>“Gmailr Package.”</span> <a href="https://gmailr.r-lib.org/">https://gmailr.r-lib.org/</a>.
</div>
<div id="ref-tidyrss" class="csl-entry">
McDonnell, Robert Myles. 2022. <span>“tidyRSS: Tidy RSS for r.”</span> <a href="https://CRAN.R-project.org/package=tidyRSS">https://CRAN.R-project.org/package=tidyRSS</a>.
</div>
<div id="ref-dailydrop" class="csl-entry">
Rudis, Bob. n.d. <span>“Hrbrmstr’s Daily Drop.”</span> <a href="https://dailyfinds.hrbrmstr.dev/">https://dailyfinds.hrbrmstr.dev/</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2023,
  author = {Robert M Flight},
  title = {Blog {Posts} as {Email} {Newsletters}},
  date = {2023-01-19},
  url = {https://rmflight.github.io/posts/2023-01-19-blog-posts-as-email-newsletters},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2023" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2023. <span>“Blog Posts as Email Newsletters.”</span>
January 19, 2023. <a href="https://rmflight.github.io/posts/2023-01-19-blog-posts-as-email-newsletters">https://rmflight.github.io/posts/2023-01-19-blog-posts-as-email-newsletters</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <category>newsletters</category>
  <guid>https://rmflight.github.io/posts/2023-01-19-blog-posts-as-email-newsletters/index.html</guid>
  <pubDate>Thu, 19 Jan 2023 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Climate Data to Analyze Days by Low Temperatures</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-12-27-climate-data-to-analyze-days-by-low-temperatures/index.html</link>
  <description><![CDATA[ 




<section id="xkcd" class="level2">
<h2 class="anchored" data-anchor-id="xkcd">XKCD?</h2>
<p>In the past few years I’ve seen a lot of spiral graphs of temperature anomolies, temperature records knit into scarves, among others. But, hats off to Randall Munroe’s XKCD, I think this is one of the more useful graphics about local temperature records (full comic in Figure&nbsp;1, and inset blown up in Figure&nbsp;2) <span class="citation" data-cites="xkcdclimate2022">(Munroe 2022)</span>. I’m not sure why I’m just seeing this comic, as it is listed as comic 1321, and XKCD is up to 2717 as of 2022-12-27, but better late than never!</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-cold" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-12-27-climate-data-to-analyze-days-by-low-temperatures/cold.png" class="img-fluid figure-img" style="width:8in"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Randall Monroe XKCD comic 1321, “Cold”.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-inset" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-12-27-climate-data-to-analyze-days-by-low-temperatures/cold_inset.png" class="img-fluid figure-img" style="width:8in"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: Inset from XKCD comic 1321, “Cold”.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>This very, very quickly shows people that the lows since 2000 have not gone below 0F until very recently, and the frequency of days below 0F in a given year were quickly decreasing. I think it’s a very effective graphic (and comic).</p>
<p>But what if we want to generate our own for another location?</p>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>In the comic, Randall lists the <strong>rcc-acis</strong> as the source of the data. I managed to find <a href="https://www.rcc-acis.org/" class="uri">https://www.rcc-acis.org/</a> as the likely source. I looked for an API, and found this page <span class="citation" data-cites="rccapi">(<span>“RCC-ACIS API”</span> 2022)</span>.</p>
<p>The description of the various API end points seems reasonable enough, except we really want to know where and what we are looking for.</p>
<p>I live in Lexington, KY, USA, so I’m going to use that for the following code.</p>
<p>First, we need to find the census code for the county we want to search for weather stations in.</p>
<p>We can find the county codes from the census.gov website <span class="citation" data-cites="censusdotgov">(<span>“Census.gov County Codes”</span> 2022)</span>. In my case, Fayette Co KY is <code>21,067</code>, which we will input into the API as <code>21067</code> (without the comma).</p>
<p>Then I can go to the rcc-acis API at <a href="http://data.rcc-acis.org/StnMeta?county=21067" class="uri">http://data.rcc-acis.org/StnMeta?county=21067</a> and see the list of stations.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb1-1"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"meta"</span><span class="fu" style="color: #4758AB;">:</span><span class="ot" style="color: #003B4F;">[</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">8251</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.4994</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.1336</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"154748 2"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"LSFK2 7"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">930.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON SPINDLETOP FARM"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">8252</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.5</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.03333</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"154741 2"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">1030.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON SOLAR RAD"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">8253</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.61138</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.03391</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"93820 1"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"154746 2"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"LEX 3"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"72422 4"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KLEX 5"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"USW00093820 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"LEX 7"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">962.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON BLUEGRASS AP"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">8387</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.53333</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.1</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"153408 2"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"USC00153408 6"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">947.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"GREENDALE"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">31507</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.52694</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.01556</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"154736 2"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"LEXK2 7"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">987.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 3 SE"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">40338</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.36667</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.0</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"151548 2"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"CHILESBURGH"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">53409</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.5097</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">37.98434</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0001 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0001 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">951.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 4.9 SW"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">53410</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.48511</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">37.96729</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0002 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0002 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">981.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON-FAYETTE 6.3 S"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">53411</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.51874</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.01625</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0003 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0003 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">1004.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 3.7 WSW"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">53412</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.49503</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.02486</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0009 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0009 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">1010.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 1.7 SSE"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">53413</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.4816</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">37.9876</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0012 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0012 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">929.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON-FAYETTE 4.0 SSW"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-13"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">53414</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.51935</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.01643</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0014 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0014 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">999.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 1.7 SW"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-14"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">69236</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.53672</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.05231</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0019 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0019 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">957.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 4.3 W"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-15"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">82402</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.45337</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">37.99841</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0023 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0023 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">1045.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 4.2 SSE"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-16"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">86252</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.41615</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.04699</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0027 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0027 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">947.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 4.7 E"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-17"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">86818</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.51712</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">37.97325</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0029 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0029 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">974.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 5.7 SSW"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-18"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">89211</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.55495</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">37.97623</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0032 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0032 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">975.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 6.9 SW"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-19"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">93426</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.52242</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">37.98129</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0036 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0036 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">993.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 4.8 S"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-20"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">101642</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.44324</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">38.05104</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0040 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0040 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">953.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 3.3 E"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">,</span></span>
<span id="cb1-21"><span class="fu" style="color: #4758AB;">{</span><span class="dt" style="color: #AD0000;">"uid"</span><span class="fu" style="color: #4758AB;">:</span> <span class="dv" style="color: #AD0000;">102039</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"ll"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="fl" style="color: #AD0000;">-84.54735</span><span class="ot" style="color: #003B4F;">,</span> <span class="fl" style="color: #AD0000;">37.9821</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"sids"</span><span class="fu" style="color: #4758AB;">:</span> <span class="ot" style="color: #003B4F;">[</span><span class="st" style="color: #20794D;">"US1KYFY0041 6"</span><span class="ot" style="color: #003B4F;">,</span> <span class="st" style="color: #20794D;">"KYFY0041 10"</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"state"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"KY"</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"elev"</span><span class="fu" style="color: #4758AB;">:</span> <span class="fl" style="color: #AD0000;">996.0</span><span class="fu" style="color: #4758AB;">,</span> <span class="dt" style="color: #AD0000;">"name"</span><span class="fu" style="color: #4758AB;">:</span> <span class="st" style="color: #20794D;">"LEXINGTON 4.5 SSW"</span><span class="fu" style="color: #4758AB;">}</span><span class="ot" style="color: #003B4F;">]</span><span class="fu" style="color: #4758AB;">}</span></span></code></pre></div>
<p>The easiest, and likely most consistent location for me to use is the Bluegrass Airport, which has UID <code>8253</code>.</p>
<p>Let’s pull the json data for daily maximum and minimum temperatures since 1970 to yesterday (2022-12-25) using this json query:</p>
<pre><code>http://data.rcc-acis.org/StnData?uid=8253&amp;sdate=1970-01-01&amp;edate=2022-12-25&amp;elems=1,2</code></pre>
<p>We can pull all that data into R directly using:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">temp_data <span class="ot" style="color: #003B4F;">=</span> jsonlite<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">fromJSON</span>(<span class="st" style="color: #20794D;">"http://data.rcc-acis.org/StnData?uid=8253&amp;sdate=1970-01-01&amp;edate=2022-12-25&amp;elems=1,2"</span>)</span></code></pre></div>
</div>
<p>I’m actually going to cache that data in a local file, so I’m not making 20 pulls while I’m writing this blog post.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">temp_data <span class="ot" style="color: #003B4F;">=</span> jsonlite<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">fromJSON</span>(<span class="st" style="color: #20794D;">"bluegrass_dailytemps.json"</span>)</span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;">str</span>(temp_data)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ meta:List of 6
  ..$ uid  : int 8253
  ..$ ll   : num [1:2] -84.6 38
  ..$ sids : chr [1:7] "93820 1" "154746 2" "LEX 3" "72422 4" ...
  ..$ state: chr "KY"
  ..$ elev : num 962
  ..$ name : chr "LEXINGTON BLUEGRASS AP"
 $ data: chr [1:19352, 1:3] "1970-01-01" "1970-01-02" "1970-01-03" "1970-01-04" ...</code></pre>
</div>
</div>
<p>We’ve got some metadata about the station we pulled from, and then a matrix of dates and daily maximum and minimum recorded temperatures. We’ll turn that into a <code>tibble</code> and convert the dates to something more useful. I’m going to aggregate by year to make this easy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;">library</span>(lubridate)</span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;">library</span>(ggplot2)</span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;">theme_set</span>(cowplot<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">theme_cowplot</span>())</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">bluegrass_df <span class="ot" style="color: #003B4F;">=</span> tibble<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">as_tibble</span>(temp_data<span class="sc" style="color: #5E5E5E;">$</span>data)</span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;">names</span>(bluegrass_df) <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"date"</span>, <span class="st" style="color: #20794D;">"max"</span>, <span class="st" style="color: #20794D;">"min"</span>)</span>
<span id="cb7-3">bluegrass_df <span class="ot" style="color: #003B4F;">=</span> bluegrass_df <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb7-4">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">date2 =</span> lubridate<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">as_date</span>(date),</span>
<span id="cb7-5">                <span class="at" style="color: #657422;">year =</span> lubridate<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">year</span>(date2),</span>
<span id="cb7-6">                <span class="at" style="color: #657422;">month =</span> lubridate<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">month</span>(date2),</span>
<span id="cb7-7">                <span class="at" style="color: #657422;">ym =</span> <span class="fu" style="color: #4758AB;">paste0</span>(year, <span class="st" style="color: #20794D;">"-"</span>, month))</span>
<span id="cb7-8">bluegrass_df</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19,352 × 7
   date       max   min   date2       year month ym    
   &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; 
 1 1970-01-01 33    23    1970-01-01  1970     1 1970-1
 2 1970-01-02 34    23    1970-01-02  1970     1 1970-1
 3 1970-01-03 26    15    1970-01-03  1970     1 1970-1
 4 1970-01-04 35    14    1970-01-04  1970     1 1970-1
 5 1970-01-05 44    23    1970-01-05  1970     1 1970-1
 6 1970-01-06 34    11    1970-01-06  1970     1 1970-1
 7 1970-01-07 11    -6    1970-01-07  1970     1 1970-1
 8 1970-01-08 3     -5    1970-01-08  1970     1 1970-1
 9 1970-01-09 8     -3    1970-01-09  1970     1 1970-1
10 1970-01-10 18    -6    1970-01-10  1970     1 1970-1
# … with 19,342 more rows</code></pre>
</div>
</div>
<p>Let’s count how many days a year a minimum was below a set temperature. Similar to XKCD, I’ll try a cutoff of 0F (see Figure&nbsp;3).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">cutoff <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb9-2">bluegrass_0 <span class="ot" style="color: #003B4F;">=</span> bluegrass_df <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb9-3">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">below_cutoff =</span> min <span class="sc" style="color: #5E5E5E;">&lt;</span> cutoff) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb9-4">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">group_by</span>(year) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb9-5">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">summarize</span>(<span class="at" style="color: #657422;">nday =</span> <span class="fu" style="color: #4758AB;">sum</span>(below_cutoff)) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb9-6">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">ungroup</span>() <span class="co" style="color: #5E5E5E;">#|&gt;</span></span>
<span id="cb9-7">  <span class="co" style="color: #5E5E5E;">#dplyr::mutate(ym = lubridate::ym(ym))</span></span>
<span id="cb9-8"></span>
<span id="cb9-9"></span>
<span id="cb9-10">bluegrass_0 <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb9-11">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> year, <span class="at" style="color: #657422;">y =</span> nday)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb9-12">  <span class="fu" style="color: #4758AB;">geom_col</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb9-13">  <span class="fu" style="color: #4758AB;">labs</span>(<span class="at" style="color: #657422;">subtitle =</span> <span class="st" style="color: #20794D;">"No. days &lt; 0F at Bluegrass Airport Lexington."</span>,</span>
<span id="cb9-14">       <span class="at" style="color: #657422;">x =</span> <span class="st" style="color: #20794D;">"Year"</span>, <span class="at" style="color: #657422;">y =</span> <span class="st" style="color: #20794D;">"No. of Days &lt; 0F"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-lex-below_0" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-12-27-climate-data-to-analyze-days-by-low-temperatures/index_files/figure-html/fig-lex-below_0-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;3: Number of days &lt; 0F at Bluegrass International Airport (LEX) by year since 1970.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Nice. Definitely fewer days at less than 0F in more recent times than previously.</p>
</section>
<section id="double-check-using-lambert-airport-in-st.-louis" class="level2">
<h2 class="anchored" data-anchor-id="double-check-using-lambert-airport-in-st.-louis">Double Check Using Lambert Airport in St.&nbsp;Louis</h2>
<p>But how do I know it’s probably right? We can double check if I get a very similar plot to the XKCD one when using the data from St.&nbsp;Louis’ Lambert Airport, as shown in Figure&nbsp;4. I went through the same procedure as above to find the county code for St.&nbsp;Louis, and then the UID for Lambert Airport, and saved the JSON.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">temp_lambert <span class="ot" style="color: #003B4F;">=</span> jsonlite<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">fromJSON</span>(<span class="st" style="color: #20794D;">"lambert_stlous_dailytemps.json"</span>)</span>
<span id="cb10-2">lambert_df <span class="ot" style="color: #003B4F;">=</span> tibble<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">as_tibble</span>(temp_lambert<span class="sc" style="color: #5E5E5E;">$</span>data)</span>
<span id="cb10-3"><span class="fu" style="color: #4758AB;">names</span>(lambert_df) <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"date"</span>, <span class="st" style="color: #20794D;">"max"</span>, <span class="st" style="color: #20794D;">"min"</span>)</span>
<span id="cb10-4">lambert_df <span class="ot" style="color: #003B4F;">=</span> lambert_df <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb10-5">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">date2 =</span> lubridate<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">as_date</span>(date),</span>
<span id="cb10-6">                <span class="at" style="color: #657422;">year =</span> lubridate<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">year</span>(date2),</span>
<span id="cb10-7">                <span class="at" style="color: #657422;">month =</span> lubridate<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">month</span>(date2),</span>
<span id="cb10-8">                <span class="at" style="color: #657422;">ym =</span> <span class="fu" style="color: #4758AB;">paste0</span>(year, <span class="st" style="color: #20794D;">"-"</span>, month))</span>
<span id="cb10-9">lambert_0 <span class="ot" style="color: #003B4F;">=</span> lambert_df <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb10-10">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">below_cutoff =</span> min <span class="sc" style="color: #5E5E5E;">&lt;</span> cutoff) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb10-11">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">group_by</span>(year) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb10-12">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">summarize</span>(<span class="at" style="color: #657422;">nday =</span> <span class="fu" style="color: #4758AB;">sum</span>(below_cutoff)) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb10-13">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">ungroup</span>()</span>
<span id="cb10-14"></span>
<span id="cb10-15"></span>
<span id="cb10-16">lambert_0 <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb10-17">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> year, <span class="at" style="color: #657422;">y =</span> nday)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb10-18">  <span class="fu" style="color: #4758AB;">geom_col</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb10-19">  <span class="fu" style="color: #4758AB;">labs</span>(<span class="at" style="color: #657422;">subtitle =</span> <span class="st" style="color: #20794D;">"No. days &lt; 0F at Lambert Airport St. Louis."</span>,</span>
<span id="cb10-20">       <span class="at" style="color: #657422;">x =</span> <span class="st" style="color: #20794D;">"Year"</span>, <span class="at" style="color: #657422;">y =</span> <span class="st" style="color: #20794D;">"No. of Days &lt; 0F"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-lambert" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-12-27-climate-data-to-analyze-days-by-low-temperatures/index_files/figure-html/fig-lambert-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;4: Number of days &lt; 0F at Lambert Airport by month since 1970.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>So Figure&nbsp;4 is <strong>similar</strong> to the one from XKCD, but I’d really like to see the data file they used and which station. I also think they probably used only the fall and winter months for a given year, like December to February, and that was the count for that particular year, excluding the next December. Regardless, the frequency of days where the minimum was below 0F has dropped significantly since the 80’s and 90’s, whether here in Lexington or St.&nbsp;Louis.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-censusdotgov" class="csl-entry">
<span>“Census.gov County Codes.”</span> 2022. <a href="https://www.census.gov/library/reference/code-lists/ansi.html#county" class="uri">https://www.census.gov/library/reference/code-lists/ansi.html#county</a>; Web.
</div>
<div id="ref-xkcdclimate2022" class="csl-entry">
Munroe, Randall. 2022. <span>“Cold.”</span> <a href="https://xkcd.com/1321/" class="uri">https://xkcd.com/1321/</a>; Web.
</div>
<div id="ref-rccapi" class="csl-entry">
<span>“RCC-ACIS API.”</span> 2022. <a href="https://www.rcc-acis.org/docs_webservices.html" class="uri">https://www.rcc-acis.org/docs_webservices.html</a>; Web.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Climate {Data} to {Analyze} {Days} by {Low} {Temperatures}},
  date = {2022-12-27},
  url = {https://rmflight.github.io/posts/2022-12-27-climate-data-to-analyze-days-by-low-temperatures},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Climate Data to Analyze Days by Low
Temperatures.”</span> December 27, 2022. <a href="https://rmflight.github.io/posts/2022-12-27-climate-data-to-analyze-days-by-low-temperatures">https://rmflight.github.io/posts/2022-12-27-climate-data-to-analyze-days-by-low-temperatures</a>.
</div></div></section></div> ]]></description>
  <category>xkcd</category>
  <category>climate-data</category>
  <guid>https://rmflight.github.io/posts/2022-12-27-climate-data-to-analyze-days-by-low-temperatures/index.html</guid>
  <pubDate>Tue, 27 Dec 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Journal Impact Factor Distributions</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-12-25-journal-impact-factor-distributions/index.html</link>
  <description><![CDATA[ 




<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TL;DR</h2>
<p>Journal impact factor distributions seem to be log-normal. If we <strong>decide</strong> they should be used, then at the very least, they should be log-transformed before doing any calculations with them.</p>
</section>
<section id="journal-impact-factor" class="level2">
<h2 class="anchored" data-anchor-id="journal-impact-factor">Journal Impact Factor</h2>
<p>At some point in history, someone decided that we could <strong>measure</strong> how important a journal is by the number of citations the manuscripts within it get. Of course this is ridiculous on it’s face, but over time those journals with higher impact factors have become <strong>more important</strong> and <strong>prestigous</strong> to publish in. In fact, instead of judging each others work on the publications themselves, academia started doing this thing where we instead judge papers (and academics) by <strong>where</strong> they are published and the publications journal impact factors (JIF). Most publishers make a big deal out of announcing their journals JIF and report them to the 3rd decimal place. Stupid, I know, but here we are. Even more ridiculous, Thomson Reuters makes big money counting all of these citations, calculating the JIF and selling the data to others.</p>
</section>
<section id="lariviere-et-al" class="level2">
<h2 class="anchored" data-anchor-id="lariviere-et-al">Larivi{`e}re et al</h2>
<p>Way back in 2016, Larivi`ere et al published a nice paper on the distributions of journal impact factors and how to compare them <span class="citation" data-cites="Lariviere062109">(Larivière et al. 2016)</span>. I heartily recommend you check that publication out. I’m not going to discuss this manuscript in particular, except to note two things:</p>
<ol type="1">
<li>that they provided a very nice description of how to acquire and calculate citation counts from a service such as Thomson Reuters Web of Science.</li>
<li>when I look at their graphs, I thought they looked likely to be log-normal (see Figure&nbsp;1).</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div id="fig-larivier-graph" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-12-25-journal-impact-factor-distributions/leviervre-F1.large.jpg" class="img-fluid figure-img" width="513"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Figure 1 from Lariviere et al: Citation distributions of 11 different science journals. Citations are to citable documents as classified by Thomson Reuters, which include standard research articles and reviews. The distributions contain citations accumulated in 2015 to citable documents published in 2013 and 2014 in order to be comparable to the 2015 JIFs published by Thomson Reuters. To facilitate direct comparison, distributions are plotted with the same range of citations (0-100) in each plot; articles with more than 100 citations are shown as a single bar at the right of each plot.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="getting-data" class="level2">
<h2 class="anchored" data-anchor-id="getting-data">Getting Data</h2>
<p>Unfortunately, Larivi{`e}re et al didn’t provide their data. Which makes sense, it’s from a closed source. However, I used their description of getting the data from Web of Science, and went and created my own version of the data for a set of journals so I could do my own analysis.</p>
<p>Following the guide provided in the Appendix of <span class="citation" data-cites="Lariviere062109">(Larivière et al. 2016)</span>, I went into Web Of Science and produced citation reports for 7 journals (eLife, EMBO Journal, Nature, Nature Communications, PLOS Biology, PLOS Genetics, and Science), and saved them. Unfortunately, the preprint shows data for publications published in 2013-2014, but the guide showed 2012-2013, so I ended up downloading the citation data for publications published in 2012-2013, which would have influenced the 2014 JIF. However, I think the conclusions are the same.</p>
<p>If you want the original data I acquired, you can go check out <span class="citation" data-cites="Flight2021">(Flight 2021)</span>.</p>
</section>
<section id="raw-plots" class="level2">
<h2 class="anchored" data-anchor-id="raw-plots">Raw Plots</h2>
<p>So lets load up the data and plot the citation counts for each journal, as shown in Figure&nbsp;2.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-raw-counts" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-12-25-journal-impact-factor-distributions/index_files/figure-html/fig-raw-counts-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: Raw citation counts for chosen journals for 2012-2013.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>I think these still look pretty similar to those shown in Figure&nbsp;1. We can see that the means are heavily influenced by the very long tails in these graphs.</p>
</section>
<section id="log-transform" class="level2">
<h2 class="anchored" data-anchor-id="log-transform">Log Transform</h2>
<p>Now, lets log-transform them, and calculate summary statistics on the log-transformed data, as shown in Figure&nbsp;3.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-log-counts" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-12-25-journal-impact-factor-distributions/index_files/figure-html/fig-log-counts-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;3: Log citation counts for chosen journals for 2012-2013</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>These look much more normal, at least for some of the heavily cited journals like Nature and Science.</p>
<p>So, if we are going to continue using these kinds of metrics, we should either adopt the metrics that Larivi`ere propose, or at the very least log-transform the citation counts.</p>
<p>Or we could drop them altogher.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Flight2021" class="csl-entry">
Flight, R. M. 2021. <span>“Curry JIF Analysis.”</span> <em>GitHub Repository</em>. <a href="https://github.com/rmflight/curry_jif_paper" class="uri">https://github.com/rmflight/curry_jif_paper</a>; GitHub.
</div>
<div id="ref-Lariviere062109" class="csl-entry">
Larivière, Vincent, Véronique Kiermer, Catriona J. MacCallum, Marcia McNutt, Mark Patterson, Bernd Pulverer, Sowmya Swaminathan, Stuart Taylor, and Stephen Curry. 2016. <span>“A Simple Proposal for the Publication of Journal Citation Distributions.”</span> <em>bioRxiv</em>. <a href="https://doi.org/10.1101/062109">https://doi.org/10.1101/062109</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Journal {Impact} {Factor} {Distributions}},
  date = {2022-12-25},
  url = {https://rmflight.github.io/posts/2022-12-25-journal-impact-factor-distributions},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Journal Impact Factor
Distributions.”</span> December 25, 2022. <a href="https://rmflight.github.io/posts/2022-12-25-journal-impact-factor-distributions">https://rmflight.github.io/posts/2022-12-25-journal-impact-factor-distributions</a>.
</div></div></section></div> ]]></description>
  <category>impact-factor</category>
  <guid>https://rmflight.github.io/posts/2022-12-25-journal-impact-factor-distributions/index.html</guid>
  <pubDate>Sun, 25 Dec 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>targets and Child Documents</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-12-22-targets-and-child-documents/index.html</link>
  <description><![CDATA[ 




<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TL;DR</h2>
<p>Make sure the child document is a target of the workflow, and that the child document target is loaded in the main.</p>
</section>
<section id="the-setup" class="level2">
<h2 class="anchored" data-anchor-id="the-setup">The Setup</h2>
<p>So you’ve gone and decided to use the awesome <code>{targets}</code> workflow manager for your project, including generating your final reports. In a bid to keep things manageable, you are also using child documents. This allows you to keep different pieces of the report separated as needed. However, how do you make sure that <code>{targets}</code> knows that the main document needs to be re-rendered when the child document is modified?</p>
</section>
<section id="the-workflow" class="level2">
<h2 class="anchored" data-anchor-id="the-workflow">The Workflow</h2>
<p>Our workflow for this example is <strong>just</strong> the child document and the main document. The child is <strong>only</strong> a file target (as opposed to a fully rendered document), because we just need to know if it changed or not, and not render it again before it gets included in the main.</p>
<p>So, <code>_targets.R</code> looks something like this:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">tar_plan</span>(</span>
<span id="cb1-2">  </span>
<span id="cb1-3">  <span class="fu" style="color: #4758AB;">tar_target</span>(child_doc,</span>
<span id="cb1-4">             <span class="st" style="color: #20794D;">"path/to/child.qmd"</span>,</span>
<span id="cb1-5">             <span class="at" style="color: #657422;">format =</span> <span class="st" style="color: #20794D;">"file"</span>),</span>
<span id="cb1-6">             </span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;">tar_quarto</span>(main_doc,</span>
<span id="cb1-8">            <span class="st" style="color: #20794D;">"path/to/main.qmd"</span>)</span>
<span id="cb1-9">             </span>
<span id="cb1-10">)</span></code></pre></div>
</section>
<section id="the-main" class="level2">
<h2 class="anchored" data-anchor-id="the-main">The Main</h2>
<p>In the main document we need to do two things:</p>
<ol type="1">
<li>load the <code>child_doc</code> target,</li>
<li>include the <code>child_doc</code> as an actual child document</li>
</ol>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"></span>
<span id="cb2-2"><span class="in" style="color: #5E5E5E;">```{r}</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;">#| label: setup</span></span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;">library</span>(targets)</span>
<span id="cb2-5">...</span>
<span id="cb2-6"><span class="in" style="color: #5E5E5E;">```</span></span>
<span id="cb2-7"></span>
<span id="cb2-8">Some text ...</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="in" style="color: #5E5E5E;">```{r}</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;">#| label: load_targets</span></span>
<span id="cb2-12"><span class="fu" style="color: #4758AB;">tar_load</span>(child_doc)</span>
<span id="cb2-13"><span class="in" style="color: #5E5E5E;">```</span></span>
<span id="cb2-14"></span>
<span id="cb2-15">More text</span>
<span id="cb2-16"></span>
<span id="cb2-17"><span class="in" style="color: #5E5E5E;">```{r}</span></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;">#| label: include_child</span></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;">#| child: !expr child_doc</span></span>
<span id="cb2-20"><span class="in" style="color: #5E5E5E;">```</span></span>
<span id="cb2-21"></span>
<span id="cb2-22">Even more text</span></code></pre></div>
<p>Notice the <code>!expr child_doc</code> in the second code block. We are taking advantage of the fact that the <code>child_doc</code> actually encodes the <strong>location</strong> of the child document, and the <code>!expr</code> is how we tell <code>{quarto}</code> that we want to evaluate an expression.</p>
</section>
<section id="include" class="level2">
<h2 class="anchored" data-anchor-id="include">Include</h2>
<p>The <code>{quarto}</code> <a href="https://quarto.org/docs/authoring/includes.html">docs</a> also suggest using <code>include</code>d documents. However, I don’t know how those would work with the path of an object, and I don’t really want to test it. Given we are using <code>tar_quarto</code> to control the rendering here, I think it is safer to use <code>child</code> over <code>include</code>.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Targets and {Child} {Documents}},
  date = {2022-12-22},
  url = {https://rmflight.github.io/posts/2022-12-22-targets-and-child-documents},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Targets and Child Documents.”</span>
December 22, 2022. <a href="https://rmflight.github.io/posts/2022-12-22-targets-and-child-documents">https://rmflight.github.io/posts/2022-12-22-targets-and-child-documents</a>.
</div></div></section></div> ]]></description>
  <category>random-code-snippets</category>
  <category>quarto</category>
  <category>rmarkdown</category>
  <category>targets</category>
  <guid>https://rmflight.github.io/posts/2022-12-22-targets-and-child-documents/index.html</guid>
  <pubDate>Thu, 22 Dec 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Customizing the Displayed Date in Quarto Pubs</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-12-08-customizing-the-displayed-date-in-quarto-pubs/index.html</link>
  <description><![CDATA[ 




<p>If you want to change how the date is displayed in your <code>{quarto}</code> documents, this is handy.</p>
<p>One, decide <strong>what</strong> <a href="https://quarto.org/docs/authoring/title-blocks.html#date">date</a> you want included:</p>
<ul>
<li>now</li>
<li>today</li>
<li>last-modified (this is my favorite, because I can tell if I’ve got the most recent version)</li>
</ul>
<p>Then, you can change how the date is displayed using the <code>date-format</code> <a href="https://quarto.org/docs/reference/dates.html">option</a>.</p>
<p>My personal preference is for something like 2022-12-08 13:42, to avoid any ambiguity when I’m generating reports for others.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb1-1"><span class="pp" style="color: #AD0000;">---</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">date</span><span class="kw" style="color: #003B4F;">:</span><span class="at" style="color: #657422;"> last-modified</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">date-format</span><span class="kw" style="color: #003B4F;">:</span><span class="at" style="color: #657422;"> YYYY-MM-DD HH:mm</span></span>
<span id="cb1-4"><span class="pp" style="color: #AD0000;">---</span></span></code></pre></div>



<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Customizing the {Displayed} {Date} in {Quarto} {Pubs}},
  date = {2022-12-08},
  url = {https://rmflight.github.io/posts/2022-12-08-customizing-the-displayed-date-in-quarto-pubs},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Customizing the Displayed Date in Quarto
Pubs.”</span> December 8, 2022. <a href="https://rmflight.github.io/posts/2022-12-08-customizing-the-displayed-date-in-quarto-pubs">https://rmflight.github.io/posts/2022-12-08-customizing-the-displayed-date-in-quarto-pubs</a>.
</div></div></section></div> ]]></description>
  <category>quarto</category>
  <category>R</category>
  <category>random-code-snippets</category>
  <guid>https://rmflight.github.io/posts/2022-12-08-customizing-the-displayed-date-in-quarto-pubs/index.html</guid>
  <pubDate>Thu, 08 Dec 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Measuring Changes in Height Over Time</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-12-07-measuring-changes-in-height-over-time/index.html</link>
  <description><![CDATA[ 




<section id="why-measure-height-over-time" class="level2">
<h2 class="anchored" data-anchor-id="why-measure-height-over-time">Why Measure Height Over Time?</h2>
<p>I have a possibly really weird theory, that I’ve not been able to find any literature on. I think that over the course of a full menstrual cycle, that some women’s height changes. The reason I think this happens, is that my spouse and I are almost exactly the same height, 99% of the time we look at each other directly in the eyes. However, there are regularly certain days of the month when we both notice that she is either slightly taller or slightly shorter than usual.</p>
<p>So, it would be really, really cool if we could record heights daily and see if it changes in any measurable way. Even neater would be if we could get a <strong>large sample</strong> of people at various life stages and genders to measure their height daily and compare amongst all of them to see if this change in height is specific to people who are regularly menstruating.</p>
</section>
<section id="ideal-method" class="level2">
<h2 class="anchored" data-anchor-id="ideal-method">Ideal Method</h2>
<p>Ideally we need to be able to do this anywhere in the world, and people should be able to do it themselves, without needing a partner or to travel anywhere. If we can do it with photos that do not involve taking a photo of the person themselves, nor use any other photo data except the date the photo was taken (if we want to be able to line up changes in height with stages of the menstrual cycle), that would also be ideal to help protect participants identity.</p>
</section>
<section id="what-i-came-up-with" class="level2">
<h2 class="anchored" data-anchor-id="what-i-came-up-with">What I Came Up With</h2>
<p>Just FYI, last winter I tried a method that involved printed lines on paper, selfies, and eye detection using OpenCV. It was a total bust.</p>
<p>A month ago, I was hashing this over in my mind again, and realized if only we could get someone else to measure people with a mark on the wall every day it might possibly work. And then I realized that if there were permanent marks on the wall (using permanent marker), and the person marked their own height with a pencil in between them, then the pencil mark location in between the two lines might possibly be used to detect changes in height.</p>
<p>Figure&nbsp;1 shows me measuring my own height, and Figure&nbsp;2 an actual photo of one of my own pencil marks to test this on the right.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-making-marks" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-12-07-measuring-changes-in-height-over-time/hcc_making_a_mark_lores.jpg" class="img-fluid figure-img" width="1632"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Author taking a selfie while pretending to mark their own height.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-example-mark" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-12-07-measuring-changes-in-height-over-time/hcc_example_lores.jpg" class="img-fluid figure-img" width="888"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: An actual height mark on the wall.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="testing-it" class="level2">
<h2 class="anchored" data-anchor-id="testing-it">Testing It</h2>
<p>To test the idea, I bought some relatively thin pegboard that has a thickness of 4mm (see Figure&nbsp;3). I then marked my own height 4 times, with no pegboard (0), 1 (4 mm), and 2 (8 mm). Each marking was a full replicate of:</p>
<ul>
<li>standing up against the wall,</li>
<li>making a pencil mark,</li>
<li>moving away from the wall,</li>
<li>taking a photo,</li>
<li>erasing the pencil mark,</li>
<li>repeat</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pegboard" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-12-07-measuring-changes-in-height-over-time/hcc_lifts_lores.jpg" class="img-fluid figure-img" width="2016"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;3: The pegboard I used to vary my own height.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>I then cropped the photos to just include the pencil mark and the lines, and then used <code>{stringr}</code> to generate random names for each of the photos so I wouldn’t know which height photo I was annotating.</p>
<p>For this test, I opened each photo in <a href="https://glimpse-editor.org/">Glimpse</a>, and measured the distance in pixels from the pencil mark to the top line, and then the pencil mark to the bottom line using the measure tool, and recorded them in an quarto-doc.</p>
<p>Finally, I calculated the ratio of the distances in pixels between the top and bottom measured values.</p>
<p>Figure&nbsp;4 shows the distributions for each height. We can see that there is a fair bit of variance in the ratios of top / bottom distances, however, the variance <strong>between</strong> heights is larger than the variance <strong>within</strong> heights, even at a difference of 4mm.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-ratios" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-12-07-measuring-changes-in-height-over-time/hcc_ratios.png" class="img-fluid figure-img" width="1200"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;4: Plot of top to bottom distance ratios for the three heights, with 4 replicate measurements for each height.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Therefore, I think this is doable. Even more so, if the lines are made a standard distance apart (say 5 cm or 2 in), then we should be able to calculate <strong>actuall</strong> changes in height. And I think we could easily make a Shiny app that loads a photo, and records three mouse clicks to annotate the top line location, height location, and bottom location, making it easier to extract measurements from a given photo.</p>
<p>So people anywhere in the world, with at least a digital camera, could make the permanent lines, self measure using a pencil and photograph every day (erasing the pencil mark). We could use a form to upload their photos, and then take information on reproductive status, age, and dates of menses (if they are open to providing them). To do this right we would want people of various genders / sexes, and at multiple stages of life: pre-pubescent, puberty, pregnant, with and without birth control, post-menopausal, etc.</p>
<p>I’m open to other ideas, but I think Figure&nbsp;4 shows that it could possibly work. I do plan to try taking my own height and my spouses (peri-menopausal) for a couple of months and see what we get for preliminary data.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Measuring {Changes} in {Height} {Over} {Time}},
  date = {2022-12-07},
  url = {https://rmflight.github.io/posts/2022-12-07-measuring-changes-in-height-over-time},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Measuring Changes in Height Over
Time.”</span> December 7, 2022. <a href="https://rmflight.github.io/posts/2022-12-07-measuring-changes-in-height-over-time">https://rmflight.github.io/posts/2022-12-07-measuring-changes-in-height-over-time</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <category>development</category>
  <category>citizen-science</category>
  <category>height</category>
  <guid>https://rmflight.github.io/posts/2022-12-07-measuring-changes-in-height-over-time/index.html</guid>
  <pubDate>Wed, 07 Dec 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Using Academicons in Your Quarto Blog</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-12-03-using-academicons-in-your-quarto-blog/index.html</link>
  <description><![CDATA[ 




<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TL;DR</h2>
<p>Install the academicons extension in your Quarto project, and then use the “text” option.</p>
</section>
<section id="academicons" class="level2">
<h2 class="anchored" data-anchor-id="academicons">Academicons??</h2>
<p><a href="https://jpswalsh.github.io/academicons/">Academicons</a> are an awesome set of academic project themed icons in the same spirit as the <a href="https://github.com/FortAwesome/Font-Awesome">Font-Awesome</a> icon collection. In particular, they include a variety of icons related to various academic projects and software. The one I really wanted access to, was the ORCID icon, <i class="ai  ai-orcid" title="" style="color:"></i>.</p>
</section>
<section id="using-in-quarto" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="using-in-quarto">Using in Quarto</h2>
<p>You can download the academicons for use in Latex, HTML, and also in Quarto projects.</p>
<p>For quarto in particular, you need to <strong>install the extension in the particular project!</strong></p>

<div class="no-row-height column-margin column-container"><div class="">
<p>I was using the instructions on the academicons site, and didn’t see that I needed to <code>cd</code> into my blog directory first to have the extension installed into the project. I do appreciate that the default for quarto is on a project basis.</p>
</div></div><pre><code>cd myblog
quarto install extension schochastics/academicons</code></pre>
<p>Then including any of the academicons in your document is easily accomplished using the short codes, like we can include the ORCID icon <i class="ai  ai-orcid" title="" style="color:"></i> using:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode md code-with-copy"><code class="sourceCode markdown"><span id="cb2-1">{{&lt; source icon &gt;}}</span></code></pre></div>
<p>where <code>source = ai</code> and <code>icon = orcid</code> or whatever other icon you want to use.</p>
</section>
<section id="including-the-icon-in-navbar" class="level2">
<h2 class="anchored" data-anchor-id="including-the-icon-in-navbar">Including the Icon in Navbar</h2>
<p>It’s often nice to include various icons in the navigation bar (navbar) or footer of your site. If you want to use it in the navbar, you will have to use</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><span class="co" style="color: #5E5E5E;"># this would be an item under the navbar</span></span>
<span id="cb3-2"><span class="at" style="color: #657422;">  </span><span class="kw" style="color: #003B4F;">-</span><span class="at" style="color: #657422;"> </span><span class="fu" style="color: #4758AB;">text</span><span class="kw" style="color: #003B4F;">:</span><span class="at" style="color: #657422;"> </span><span class="st" style="color: #20794D;">"{{&lt; source icon &gt;}}"</span></span>
<span id="cb3-3"><span class="at" style="color: #657422;">    </span><span class="fu" style="color: #4758AB;">href</span><span class="kw" style="color: #003B4F;">:</span><span class="at" style="color: #657422;"> link</span></span></code></pre></div>
<p>I hope this helps someone else!</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Using {Academicons} in {Your} {Quarto} {Blog}},
  date = {2022-12-03},
  url = {https://rmflight.github.io/posts/2022-12-03-using-academicons-in-your-quarto-blog},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Using Academicons in Your Quarto
Blog.”</span> December 3, 2022. <a href="https://rmflight.github.io/posts/2022-12-03-using-academicons-in-your-quarto-blog">https://rmflight.github.io/posts/2022-12-03-using-academicons-in-your-quarto-blog</a>.
</div></div></section></div> ]]></description>
  <category>random-code-snippets</category>
  <category>quarto</category>
  <guid>https://rmflight.github.io/posts/2022-12-03-using-academicons-in-your-quarto-blog/index.html</guid>
  <pubDate>Sat, 03 Dec 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Creating an Analysis With a targets Workflow</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-09-27-creating-an-analysis-using-targets/index.html</link>
  <description><![CDATA[ 




<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TL;DR</h2>
<p>Setting up an analysis workflow using <code>{targets}</code> can be a little confusing without worked examples. This is my attempt to provide such an example.</p>
</section>
<section id="example-repo" class="level2">
<h2 class="anchored" data-anchor-id="example-repo">Example Repo</h2>
<p>I’ve set up a <a href="https://github.com/rmflight/example_targets_workflow">GitHub repo</a> that contains the data and scripts used for this analysis.</p>
</section>
<section id="packages" class="level2">
<h2 class="anchored" data-anchor-id="packages">Packages</h2>
<p>For this example, if you want to follow along yourself, you will need Miles McBain’s <code>{tflow}</code> package, which sets up an opinionated but loose directory / file structure. You will also need the <code>{targets}</code> package, and <code>{tarchetypes}</code>, and <code>{rmarkdown}</code>, as well as a few others.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">install.packages</span>(</span>
<span id="cb1-2"> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"conflicted"</span>,</span>
<span id="cb1-3">   <span class="st" style="color: #20794D;">"dotenv"</span>,</span>
<span id="cb1-4">   <span class="st" style="color: #20794D;">"targets"</span>,</span>
<span id="cb1-5">   <span class="st" style="color: #20794D;">"tarchetypes"</span>,</span>
<span id="cb1-6">   <span class="st" style="color: #20794D;">"BiocManager"</span>,</span>
<span id="cb1-7">   <span class="st" style="color: #20794D;">"viridis"</span>)</span>
<span id="cb1-8">)</span>
<span id="cb1-9"></span>
<span id="cb1-10">BiocManager<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">install</span>(<span class="st" style="color: #20794D;">"limma"</span>)</span>
<span id="cb1-11"></span>
<span id="cb1-12">remotes<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">install_github</span>(</span>
<span id="cb1-13">  <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"milesmcbain/tflow"</span>,</span>
<span id="cb1-14">    <span class="st" style="color: #20794D;">"moseleyBioinformaticsLab/ICIKendallTau"</span>,</span>
<span id="cb1-15">    <span class="st" style="color: #20794D;">"moseleyBioinformaticsLab/visualizationQualityControl"</span>))</span></code></pre></div>
</section>
<section id="example-analysis" class="level2">
<h2 class="anchored" data-anchor-id="example-analysis">Example Analysis</h2>
<p>The example we will work through is a lipidomics data analysis. This data is based on real data, but sample IDs have been completely anonymized. I’m going to walk through all the steps I do to set up the analysis, mostly by commenting the example <code>_targets.R</code> file, and leaving the objects in the order they were created.</p>
<section id="create-new-project" class="level3">
<h3 class="anchored" data-anchor-id="create-new-project">Create New Project</h3>
<p>We start by creating a brand new RStudio project to work in, or any new directory.</p>
</section>
<section id="initialize-tflow" class="level3">
<h3 class="anchored" data-anchor-id="initialize-tflow">Initialize tflow</h3>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">tflow<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">use_tflow</span>()</span>
<span id="cb2-2">✔ Setting active project to <span class="st" style="color: #20794D;">'/home/rmflight/Projects/personal/example_targets_workflow'</span></span>
<span id="cb2-3">✔ Creating <span class="st" style="color: #20794D;">'R/'</span></span>
<span id="cb2-4">✔ Writing <span class="st" style="color: #20794D;">'packages.R'</span></span>
<span id="cb2-5">✔ Writing <span class="st" style="color: #20794D;">'_targets.R'</span></span>
<span id="cb2-6">✔ Writing <span class="st" style="color: #20794D;">'.env'</span></span></code></pre></div>
<p>In addition to this, I’ve created a <code>data</code> directory, and added the measurements CSV and metadata CSV to that directory.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;">dir</span>(<span class="st" style="color: #20794D;">"data"</span>)</span>
<span id="cb3-2">[<span class="dv" style="color: #AD0000;">1</span>] <span class="st" style="color: #20794D;">"sample_measurements.csv"</span> <span class="st" style="color: #20794D;">"sample_metadata.csv"</span></span></code></pre></div>
<p>Some important things about using <code>{tflow}</code> in this project:</p>
<ul>
<li><code>{tflow}</code> uses the <code>targets::tar_plan()</code> function to contain the various targets in the workflow.</li>
<li>This means you don’t have to have a list of targets at the end of <code>_targets.R</code>.</li>
<li>It also means you can use <code>{drake}</code> style targets of the form:</li>
</ul>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"> out_target <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">function_name</span>(in_target),</span>
<span id="cb4-2"> ...</span></code></pre></div>
<p>I personally think it makes the workflow much more readable than the default targets style of:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">tar_target</span>(</span>
<span id="cb5-2">  out_target</span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;">function_name</span>(in_target)</span>
<span id="cb5-4">)</span></code></pre></div>
</section>
<section id="setup-packages" class="level3">
<h3 class="anchored" data-anchor-id="setup-packages">Setup Packages</h3>
<p>We modify the <code>packages.R</code> file to add anything else we need.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="do" style="color: #5E5E5E;
font-style: italic;">## library() calls go here</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;">library</span>(conflicted)</span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;">library</span>(dotenv)</span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;">library</span>(targets)</span>
<span id="cb6-5"><span class="fu" style="color: #4758AB;">library</span>(tarchetypes)</span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;"># our extra packages for this analysis</span></span>
<span id="cb6-7"><span class="fu" style="color: #4758AB;">library</span>(visualizationQualityControl)</span>
<span id="cb6-8"><span class="fu" style="color: #4758AB;">library</span>(ggplot2)</span>
<span id="cb6-9"><span class="fu" style="color: #4758AB;">library</span>(ICIKendallTau)</span>
<span id="cb6-10"><span class="fu" style="color: #4758AB;">library</span>(dplyr)</span>
<span id="cb6-11"><span class="fu" style="color: #4758AB;">library</span>(limma)</span></code></pre></div>
</section>
<section id="initial-_targets.r" class="level3">
<h3 class="anchored" data-anchor-id="initial-_targets.r">Initial _targets.R</h3>
<p>This is what <code>{tflow}</code> sets up to run when you start.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Load your packages, e.g. library(targets).</span></span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;">source</span>(<span class="st" style="color: #20794D;">"./packages.R"</span>)</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Load your R files</span></span>
<span id="cb7-5"><span class="fu" style="color: #4758AB;">lapply</span>(<span class="fu" style="color: #4758AB;">list.files</span>(<span class="st" style="color: #20794D;">"./R"</span>, <span class="at" style="color: #657422;">full.names =</span> <span class="cn" style="color: #8f5902;">TRUE</span>), source)</span>
<span id="cb7-6"></span>
<span id="cb7-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">## tar_plan supports drake-style targets and also tar_target()</span></span>
<span id="cb7-8"><span class="fu" style="color: #4758AB;">tar_plan</span>(</span>
<span id="cb7-9"></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;"># target = function_to_make(arg), ## drake style</span></span>
<span id="cb7-11"></span>
<span id="cb7-12"><span class="co" style="color: #5E5E5E;"># tar_target(target2, function_to_make2(arg)) ## targets style</span></span>
<span id="cb7-13"></span>
<span id="cb7-14">)</span></code></pre></div>
<p>Notice that the first thing that happens is that the <code>packages.R</code> file gets sourced, so that all your packages are loaded. Second, it runs through all of the files in <code>R</code>, and sources them to load all the functions. <code>{tflow}</code> and <code>{targets}</code> expound a functional workflow, where we put things in functions. Finally, it uses <code>tar_plan()</code> to run each of the targets.</p>
<p>We will specify each of the targets in turn to fill out the analysis we want to do.</p>
</section>
<section id="load-data" class="level3">
<h3 class="anchored" data-anchor-id="load-data">Load Data</h3>
<p>Lets first <strong>declare</strong> the measurement file and metadata file as actual targets, so if they change, then any dependent targets will be re-run as well.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;">tar_plan</span>(</span>
<span id="cb8-2"></span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;">tar_target</span>(measurement_file,</span>
<span id="cb8-4">             <span class="st" style="color: #20794D;">"data/sample_measurements.csv"</span>,</span>
<span id="cb8-5">             <span class="at" style="color: #657422;">format =</span> <span class="st" style="color: #20794D;">"file"</span>),</span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;">tar_target</span>(metadata_file,</span>
<span id="cb8-7">             <span class="st" style="color: #20794D;">"data/sample_metadata.csv"</span>,</span>
<span id="cb8-8">             <span class="at" style="color: #657422;">format =</span> <span class="st" style="color: #20794D;">"file"</span>)</span>
<span id="cb8-9"></span>
<span id="cb8-10">)</span></code></pre></div>
<p>Running it with <code>tar_make()</code> results in:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;">tar_make</span>()</span>
<span id="cb9-2">• start target measurement_file</span>
<span id="cb9-3">• built target measurement_file [<span class="fl" style="color: #AD0000;">0.001</span> seconds]</span>
<span id="cb9-4">• start target metadata_file</span>
<span id="cb9-5">• built target metadata_file [<span class="fl" style="color: #AD0000;">0.001</span> seconds]</span>
<span id="cb9-6">• end pipeline [<span class="fl" style="color: #AD0000;">0.078</span> seconds]</span></code></pre></div>
<p>Then we add in actually reading in the data.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;">tar_plan</span>(</span>
<span id="cb10-2"></span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;">tar_target</span>(measurement_file,</span>
<span id="cb10-4">             <span class="st" style="color: #20794D;">"data/sample_measurements.csv"</span>,</span>
<span id="cb10-5">             <span class="at" style="color: #657422;">format =</span> <span class="st" style="color: #20794D;">"file"</span>),</span>
<span id="cb10-6">  <span class="fu" style="color: #4758AB;">tar_target</span>(metadata_file,</span>
<span id="cb10-7">             <span class="st" style="color: #20794D;">"data/sample_metadata.csv"</span>,</span>
<span id="cb10-8">             <span class="at" style="color: #657422;">format =</span> <span class="st" style="color: #20794D;">"file"</span>)</span>
<span id="cb10-9"></span>
<span id="cb10-10">  <span class="at" style="color: #657422;">lipid_measurements =</span> readr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">read_csv</span>(measurement_file),</span>
<span id="cb10-11">  <span class="at" style="color: #657422;">lipid_metadata =</span> readr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">read_csv</span>(metadata_file),</span>
<span id="cb10-12"></span>
<span id="cb10-13">)</span></code></pre></div>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;">tar_make</span>()</span>
<span id="cb11-2">✔ skip target measurement_file</span>
<span id="cb11-3">✔ skip target metadata_file</span>
<span id="cb11-4">• start target lipid_measurements</span>
<span id="cb11-5">Rows<span class="sc" style="color: #5E5E5E;">:</span> <span class="dv" style="color: #AD0000;">1012</span> Columns<span class="sc" style="color: #5E5E5E;">:</span> <span class="dv" style="color: #AD0000;">16</span></span>
<span id="cb11-6">── Column specification ────────────────────────────────────────────────────────</span>
<span id="cb11-7">Delimiter<span class="sc" style="color: #5E5E5E;">:</span> <span class="st" style="color: #20794D;">","</span></span>
<span id="cb11-8"><span class="fu" style="color: #4758AB;">chr</span>  (<span class="dv" style="color: #AD0000;">4</span>)<span class="sc" style="color: #5E5E5E;">:</span> class, name, group_units, feature_id</span>
<span id="cb11-9"><span class="fu" style="color: #4758AB;">dbl</span> (<span class="dv" style="color: #AD0000;">12</span>)<span class="sc" style="color: #5E5E5E;">:</span> WT_1, WT_2, WT_3, WT_4, WT_5, WT_6, KO_1, KO_2, KO_3, KO_4, KO_5, ...</span>
<span id="cb11-10"><span class="sc" style="color: #5E5E5E;">|</span></span>
<span id="cb11-11">ℹ Use <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">spec()</span><span class="st" style="color: #20794D;">`</span> to retrieve the full column specification <span class="cf" style="color: #003B4F;">for</span> this data.</span>
<span id="cb11-12">ℹ Specify the column types or set <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">show_col_types = FALSE</span><span class="st" style="color: #20794D;">`</span> to quiet this message.</span>
<span id="cb11-13">• built target lipid_measurements [<span class="fl" style="color: #AD0000;">0.305</span> seconds]</span>
<span id="cb11-14">• start target lipid_metadata</span>
<span id="cb11-15">Rows<span class="sc" style="color: #5E5E5E;">:</span> <span class="dv" style="color: #AD0000;">12</span> Columns<span class="sc" style="color: #5E5E5E;">:</span> <span class="dv" style="color: #AD0000;">18</span></span>
<span id="cb11-16">── Column specification ────────────────────────────────────────────────────────</span>
<span id="cb11-17">Delimiter<span class="sc" style="color: #5E5E5E;">:</span> <span class="st" style="color: #20794D;">","</span></span>
<span id="cb11-18"><span class="fu" style="color: #4758AB;">chr</span> (<span class="dv" style="color: #AD0000;">10</span>)<span class="sc" style="color: #5E5E5E;">:</span> parent_sample_name, assay, cell_line, client_matrix, client_sample...</span>
<span id="cb11-19"><span class="fu" style="color: #4758AB;">dbl</span>  (<span class="dv" style="color: #AD0000;">8</span>)<span class="sc" style="color: #5E5E5E;">:</span> client_identifier, client_sample_number, group_number, sample_amou...</span>
<span id="cb11-20"><span class="sc" style="color: #5E5E5E;">/</span></span>
<span id="cb11-21">ℹ Use <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">spec()</span><span class="st" style="color: #20794D;">`</span> to retrieve the full column specification <span class="cf" style="color: #003B4F;">for</span> this data.</span>
<span id="cb11-22">ℹ Specify the column types or set <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">show_col_types = FALSE</span><span class="st" style="color: #20794D;">`</span> to quiet this message.</span>
<span id="cb11-23">• built target lipid_metadata [<span class="fl" style="color: #AD0000;">0.07</span> seconds]</span>
<span id="cb11-24">• end pipeline [<span class="fl" style="color: #AD0000;">0.47</span> seconds]</span></code></pre></div>
</section>
<section id="exploratory-data-analysis" class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory Data Analysis</h3>
<p>For the exploratory data analysis (EDA), I like to put that into a report. You set those up using <code>tflow::use_rmd("document_name")</code> or <code>tflow::use_qmd("document_name)</code>. An example <a href="https://github.com/rmflight/example_targets_workflow/blob/main/doc/exploration.Rmd">EDA report</a> is available at the actual repo.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">tflow<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">use_rmd</span>(<span class="st" style="color: #20794D;">"exploration"</span>)</span>
<span id="cb12-2">✔ Setting active project to <span class="st" style="color: #20794D;">'/home/rmflight/Projects/personal/example_targets_workflow'</span></span>
<span id="cb12-3">✔ Writing <span class="st" style="color: #20794D;">'doc/exploration.Rmd'</span></span>
<span id="cb12-4">Add this target to your <span class="fu" style="color: #4758AB;">tar_plan</span>()<span class="sc" style="color: #5E5E5E;">:</span></span>
<span id="cb12-5"></span>
<span id="cb12-6"><span class="fu" style="color: #4758AB;">tar_render</span>(exploration, <span class="st" style="color: #20794D;">"doc/exploration.Rmd"</span>)</span></code></pre></div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;">tar_plan</span>(</span>
<span id="cb13-2"></span>
<span id="cb13-3">  <span class="fu" style="color: #4758AB;">tar_target</span>(measurement_file,</span>
<span id="cb13-4">             <span class="st" style="color: #20794D;">"data/sample_measurements.csv"</span>,</span>
<span id="cb13-5">             <span class="at" style="color: #657422;">format =</span> <span class="st" style="color: #20794D;">"file"</span>),</span>
<span id="cb13-6">  <span class="fu" style="color: #4758AB;">tar_target</span>(metadata_file,</span>
<span id="cb13-7">             <span class="st" style="color: #20794D;">"data/sample_metadata.csv"</span>,</span>
<span id="cb13-8">             <span class="at" style="color: #657422;">format =</span> <span class="st" style="color: #20794D;">"file"</span>)</span>
<span id="cb13-9"></span>
<span id="cb13-10">  <span class="at" style="color: #657422;">lipid_measurements =</span> readr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">read_csv</span>(measurement_file),</span>
<span id="cb13-11">  <span class="at" style="color: #657422;">lipid_metadata =</span> readr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">read_csv</span>(metadata_file),</span>
<span id="cb13-12">  </span>
<span id="cb13-13">  <span class="fu" style="color: #4758AB;">tar_render</span>(exploration, <span class="st" style="color: #20794D;">"doc/exploration.Rmd"</span>)</span>
<span id="cb13-14">)</span></code></pre></div>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="sc" style="color: #5E5E5E;">&gt;</span> targets<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">tar_make</span>()</span>
<span id="cb14-2">✔ skip target measurement_file</span>
<span id="cb14-3">✔ skip target metadata_file</span>
<span id="cb14-4">✔ skip target lipid_measurements</span>
<span id="cb14-5">✔ skip target lipid_metadata</span>
<span id="cb14-6">• start target exploration</span>
<span id="cb14-7">• built target exploration [<span class="fl" style="color: #AD0000;">2.829</span> seconds]</span>
<span id="cb14-8">• end pipeline [<span class="fl" style="color: #AD0000;">2.922</span> seconds]</span></code></pre></div>
<p>Note we could have put these bits in their own functions instead of keeping them in the document proper:</p>
<ul>
<li>ICI-Kt correlations;</li>
<li>Heatmap figure;</li>
<li>PCA decomposition;</li>
<li>PCA visualization</li>
</ul>
<p>These are left as an exercise for the reader.</p>
</section>
<section id="differential-analysis" class="level3">
<h3 class="anchored" data-anchor-id="differential-analysis">Differential Analysis</h3>
<p>Following EDA, we need to do the differential analysis. But for that, we need to do normalization and imputation of missing values first. Each one of those should be their own functions. <a href="https://github.com/rmflight/example_targets_workflow/blob/main/R/differential.R#L1">Here</a> is the normalization function, <a href="https://github.com/rmflight/example_targets_workflow/blob/main/R/differential.R#L26">here</a> is the imputation, and <a href="https://github.com/rmflight/example_targets_workflow/blob/main/R/differential.R#L41">here</a> is the differential analysis function.</p>
<p>And here is the output of running each step.</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;"># normalization</span></span>
<span id="cb15-2"><span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="fu" style="color: #4758AB;">tar_make</span>()</span>
<span id="cb15-3">✔ skip target measurement_file</span>
<span id="cb15-4">✔ skip target metadata_file</span>
<span id="cb15-5">✔ skip target lipid_measurements</span>
<span id="cb15-6">✔ skip target lipid_metadata</span>
<span id="cb15-7">• start target lipid_normalized</span>
<span id="cb15-8">New names<span class="sc" style="color: #5E5E5E;">:</span></span>
<span id="cb15-9">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...1</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-10">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...2</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-11">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...3</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-12">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...4</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-13">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...5</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-14">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...6</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-15">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...7</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-16">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...8</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-17">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...9</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-18">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...10</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-19">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...11</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-20">• <span class="st" style="color: #20794D;">``</span> <span class="ot" style="color: #003B4F;">-&gt;</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">...12</span><span class="st" style="color: #20794D;">`</span></span>
<span id="cb15-21">• built target lipid_normalized [<span class="fl" style="color: #AD0000;">0.449</span> seconds]</span>
<span id="cb15-22">✔ skip target exploration</span>
<span id="cb15-23">• end pipeline [<span class="fl" style="color: #AD0000;">0.562</span> seconds]</span></code></pre></div>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;"># imputing missing values</span></span>
<span id="cb16-2"><span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="fu" style="color: #4758AB;">tar_make</span>()</span>
<span id="cb16-3">✔ skip target measurement_file</span>
<span id="cb16-4">✔ skip target metadata_file</span>
<span id="cb16-5">✔ skip target lipid_measurements</span>
<span id="cb16-6">✔ skip target lipid_metadata</span>
<span id="cb16-7">✔ skip target lipid_normalized</span>
<span id="cb16-8">✔ skip target exploration</span>
<span id="cb16-9">• start target lipid_imputed</span>
<span id="cb16-10">• built target lipid_imputed [<span class="fl" style="color: #AD0000;">0.05</span> seconds]</span>
<span id="cb16-11">• end pipeline [<span class="fl" style="color: #AD0000;">0.169</span> seconds]</span></code></pre></div>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="co" style="color: #5E5E5E;"># differential analysis</span></span>
<span id="cb17-2"><span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="fu" style="color: #4758AB;">tar_make</span>()</span>
<span id="cb17-3">✔ skip target measurement_file</span>
<span id="cb17-4">✔ skip target metadata_file</span>
<span id="cb17-5">✔ skip target lipid_measurements</span>
<span id="cb17-6">✔ skip target lipid_metadata</span>
<span id="cb17-7">✔ skip target lipid_normalized</span>
<span id="cb17-8">✔ skip target exploration</span>
<span id="cb17-9">✔ skip target lipid_imputed</span>
<span id="cb17-10">• start target lipids_differential</span>
<span id="cb17-11">• built target lipids_differential [<span class="fl" style="color: #AD0000;">0.198</span> seconds]</span>
<span id="cb17-12">• end pipeline [<span class="fl" style="color: #AD0000;">0.312</span> seconds]</span></code></pre></div>
<p>I <strong>try</strong> to build it up piecewise like this because it lets me easily load the previous target into the next function. Most of my functions will have <code>tar_load(previous_target)</code> at the top as a comment, or <code>varname = tar_read(previous_target)</code>, if I’ve got a more generic variable name I want to use that doesn’t match the name of the target coming into the function. For example, here is the top of the normalization function.</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">normalize_samples <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(lipid_measurements){</span>
<span id="cb18-2">  <span class="co" style="color: #5E5E5E;"># do normalization in here and return the df</span></span>
<span id="cb18-3">  <span class="co" style="color: #5E5E5E;"># tar_load(lipid_measurements)</span></span>
<span id="cb18-4">...</span></code></pre></div>
<p>This strategy lets me easily load the variables I need in that function space and develop the actual code of the function. I will very often couple this with restarting the R session, <code>source("./packages.R")</code>, and if needed <code>lapply(...)</code> sourcing the R function files, and then load the necessary variables and start writing the code for the function.</p>
</section>
<section id="final-report" class="level3">
<h3 class="anchored" data-anchor-id="final-report">Final Report</h3>
<p>Finally, we can put the differential results in our final report. So that they are together, we can make the EDA report a <strong>child document</strong> of the differential report, and include it as well. Let’s actually make a copy, and include it as a child document.</p>
<p>We add it to the plan as another target using the <code>tar_target</code> syntax, because as far as I know that is the only way to include something as a file dependency. If we want the <strong>differential_report</strong> target to get rerun when the <em>exploration</em> one is changed, this is the way to do it, have a target in the <code>tar_plan</code>, and then make sure to load the target in the <em>differential_report</em> itself.</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="co" style="color: #5E5E5E;"># on the command line / terminal / console</span></span>
<span id="cb19-2"><span class="sc" style="color: #5E5E5E;">&gt;</span>tflow<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">use_rmd</span>(<span class="st" style="color: #20794D;">"differential_report"</span>)</span>
<span id="cb19-3">✔ Writing <span class="st" style="color: #20794D;">'doc/differential_report.Rmd'</span></span>
<span id="cb19-4">Add this target to your <span class="fu" style="color: #4758AB;">tar_plan</span>()<span class="sc" style="color: #5E5E5E;">:</span></span>
<span id="cb19-5"></span>
<span id="cb19-6"><span class="fu" style="color: #4758AB;">tar_render</span>(differential_report2, <span class="st" style="color: #20794D;">"doc/differential_report.Rmd"</span>)</span></code></pre></div>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="co" style="color: #5E5E5E;"># in the _targets.R file</span></span>
<span id="cb20-2"><span class="co" style="color: #5E5E5E;"># add the child target</span></span>
<span id="cb20-3"><span class="fu" style="color: #4758AB;">tar_target</span>(exploration_child,</span>
<span id="cb20-4">             <span class="st" style="color: #20794D;">"doc/exploration_child.Rmd"</span>,</span>
<span id="cb20-5">             <span class="at" style="color: #657422;">format =</span> <span class="st" style="color: #20794D;">"file"</span>),</span>
<span id="cb20-6">             </span>
<span id="cb20-7"><span class="co" style="color: #5E5E5E;"># and then generate final report</span></span>
<span id="cb20-8"><span class="fu" style="color: #4758AB;">tar_render</span>(differential_report, <span class="st" style="color: #20794D;">"doc/differential_report.Rmd"</span>)</span></code></pre></div>
<p>In the rmarkdown:</p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb21-1"><span class="in" style="color: #5E5E5E;">```{r eda child='doc/exploration_child.Rmd'}</span></span>
<span id="cb21-2"><span class="fu" style="color: #4758AB;">plot</span>(cars)</span>
<span id="cb21-3"><span class="in" style="color: #5E5E5E;">```</span></span></code></pre></div>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="co" style="color: #5E5E5E;"># run the differential report</span></span>
<span id="cb22-2"><span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="fu" style="color: #4758AB;">tar_make</span>()</span>
<span id="cb22-3">✔ skip target measurement_file</span>
<span id="cb22-4">✔ skip target metadata_file</span>
<span id="cb22-5">✔ skip target exploration_child</span>
<span id="cb22-6">✔ skip target lipid_measurements</span>
<span id="cb22-7">✔ skip target lipid_metadata</span>
<span id="cb22-8">✔ skip target lipid_normalized</span>
<span id="cb22-9">✔ skip target exploration</span>
<span id="cb22-10">✔ skip target lipid_imputed</span>
<span id="cb22-11">✔ skip target lipids_differential</span>
<span id="cb22-12">• start target differential_report</span>
<span id="cb22-13">• built target differential_report [<span class="fl" style="color: #AD0000;">3.018</span> seconds]</span>
<span id="cb22-14">• end pipeline [<span class="fl" style="color: #AD0000;">3.14</span> seconds]</span></code></pre></div>
</section>
</section>
<section id="notes-about-rmarkdown-and-quarto" class="level2">
<h2 class="anchored" data-anchor-id="notes-about-rmarkdown-and-quarto">Notes About Rmarkdown and Quarto</h2>
<p>If you want to be able to interactively mess with your Rmarkdown / Quarto docs while under <code>{targets}</code>, then you need to change the setting <strong>Chunk Output Inline</strong> to <strong>Chunk Output in Console</strong>.</p>
<p>If you want to run a full render of the document <strong>outside</strong> of the <code>{targets}</code> workflow, then you have to add an option to the <strong>interactive</strong> (shell, console) calls to <code>{rmarkdown}</code> and <code>{quarto}</code> to either use the <code>knit_root_dir</code> or <code>execute_dir</code> arguments, respectively. Both of those should be in the top level directory of the <code>{targets}</code> project, which most often at the console can be gotten by using <code>getwd()</code>, as shown in the examples below.</p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="co" style="color: #5E5E5E;"># for rmarkdown</span></span>
<span id="cb23-2">rmarkdown<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">render</span>(<span class="st" style="color: #20794D;">"doc/document.Rmd"</span>, <span class="at" style="color: #657422;">knit_root_dir =</span> <span class="fu" style="color: #4758AB;">getwd</span>())</span>
<span id="cb23-3"><span class="co" style="color: #5E5E5E;"># for quarto</span></span>
<span id="cb23-4">quarto<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">quarto_render</span>(<span class="st" style="color: #20794D;">"doc/document.qmd"</span>, <span class="at" style="color: #657422;">execute_dir =</span> <span class="fu" style="color: #4758AB;">getwd</span>())</span></code></pre></div>
<p>There is also currently an issue with using <code>{gt}</code> tables in Quarto -&gt; Word documents within <code>{targets}</code> workflows that as of 2022-09-27, is not quite resolved.</p>
<p><em>Edited 2022-11-30:</em> Added a couple of notes on the use of <code>{tflow}</code> and subsequently <code>tar_plan()</code></p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Creating an {Analysis} {With} a Targets {Workflow}},
  date = {2022-09-27},
  url = {https://rmflight.github.io/posts/2022-09-27-creating-an-analysis-using-targets},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Creating an Analysis With a Targets
Workflow.”</span> September 27, 2022. <a href="https://rmflight.github.io/posts/2022-09-27-creating-an-analysis-using-targets">https://rmflight.github.io/posts/2022-09-27-creating-an-analysis-using-targets</a>.
</div></div></section></div> ]]></description>
  <category>analysis</category>
  <category>development</category>
  <category>mass-spectrometry</category>
  <category>targets</category>
  <guid>https://rmflight.github.io/posts/2022-09-27-creating-an-analysis-using-targets/index.html</guid>
  <pubDate>Tue, 27 Sep 2022 04:00:00 GMT</pubDate>
</item>
<item>
  <title>Compiling Against Python.h</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-06-22-compiling-against-pythonh/index.html</link>
  <description><![CDATA[ 




<p>Sometimes, the installed version of Python on your linux system isn’t what you need, and you can’t easily install a newer version system-wide. Of course, you can download, extract, and configure and then make Python that lives in it’s own directory. But then you don’t have all the pointers to the <code>Include</code> directories that are useful for linking stuff against. And you don’t want to change symlinks at the system level, that might break things, a lot of things.</p>
<p>If you are using <code>cython</code> to speed up your code, then it needs to know where exactly to find those extra header files. Unfortunately, it needs both the C++ and the C versions, it seems.</p>
<p>Lets go through the steps of setting up a new python, and then linking it for compiling cythonized programs.</p>
<section id="download-and-make" class="level2">
<h2 class="anchored" data-anchor-id="download-and-make">Download and Make</h2>
<p>Download <a href="https://www.python.org/downloads/">python</a>, and navigate to where you saved it. I’ll assume we downloaded version 10 to <code>~/software</code></p>
<pre><code>cd ~/software
tar -xzf Python-3.10.5.tgz
cd Python-3.10.5
./configure --enable-optimizations
make</code></pre>
</section>
<section id="setup-new-virtualenv-with-it" class="level2">
<h2 class="anchored" data-anchor-id="setup-new-virtualenv-with-it">Setup New Virtualenv With It</h2>
<p>Make sure you have <code>virtualenv</code> installed, its necessary if you want to specify a specific version of python. Yes, you could probably get around this with <code>conda</code> or <code>docker</code>, but we are doing things the painful way.</p>
<pre><code>virtualenv -p ~/software/Python-3.10.5/python ~/py10_venv
source ~/py10_venv/activate</code></pre>
</section>
<section id="add-it-to-environment" class="level2">
<h2 class="anchored" data-anchor-id="add-it-to-environment">Add It to Environment</h2>
<pre><code>export C_INCLUDE_PATH=/home/rmflight/software/Python-3.10.5:$C_INCLUDE_PATH</code></pre>
</section>
<section id="install-something-cython" class="level2">
<h2 class="anchored" data-anchor-id="install-something-cython">Install Something Cython</h2>
<p>We are going to install a package that needs only a <em>few</em> python deps, our labs <code>icikt</code> package.</p>
<pre><code># check that you are using the right version in the venv
python3 --version
python3 -m pip install docopt
python3 -m pip install scipy
python3 -m pip install cython</code></pre>
<pre><code>cd ~/software
git clone git@github.com:MoseleyBioinformaticsLab/icikt.git</code></pre>
<pre><code>python3 -m pip install --global-option=build_ext --global-option="-I/home/rmflight/software/Python-3.10.5/Include" ~/software/icikt</code></pre>
<p>Notice we’ve done two very important things overall:</p>
<ol type="1">
<li>Added a path, <code>C_INCLUDE_PATH</code></li>
<li>Added two <code>--global-option</code> in the call to build our local package</li>
</ol>
<p>For some reason we need <strong>both</strong> the environment variable path, and the global option to get this to work.</p>
<p>If you forget one or the other, you will see error messages concerning python.h</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Compiling {Against} {Python.h}},
  date = {2022-06-22},
  url = {https://rmflight.github.io/posts/2022-06-22-compiling-against-pythonh},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Compiling Against Python.h.”</span> June
22, 2022. <a href="https://rmflight.github.io/posts/2022-06-22-compiling-against-pythonh">https://rmflight.github.io/posts/2022-06-22-compiling-against-pythonh</a>.
</div></div></section></div> ]]></description>
  <category>python</category>
  <category>cython</category>
  <category>random-code-snippets</category>
  <guid>https://rmflight.github.io/posts/2022-06-22-compiling-against-pythonh/index.html</guid>
  <pubDate>Wed, 22 Jun 2022 04:00:00 GMT</pubDate>
</item>
<item>
  <title>Project Consultation Template</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-02-08-project-consultation-template/index.html</link>
  <description><![CDATA[ 




<section id="motivating-tweet" class="level2">
<h2 class="anchored" data-anchor-id="motivating-tweet">Motivating Tweet</h2>
<p>A little while ago, I was tweeting about the joy of collaborating with people who haven’t included you in their experimental design. One of the <a href="https://twitter.com/rmflight/status/1490155702438219777?s=20&amp;t=W4cx7JY3qDHEaJUpKjehyw">tweets</a> was this:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rmflight.github.io/posts/2022-02-08-project-consultation-template/tweet_about_projects.png" class="img-fluid" style="width:80.0%"></p>
</div>
</div>
<p>I decided that I should follow up with our actual project consultation template.</p>
</section>
<section id="consultations" class="level2">
<h2 class="anchored" data-anchor-id="consultations">Consultations?</h2>
<p>A large part of my work is collaborative projects where I do various -omics analyses for members of the cancer center I’m part of. As I’m sure many of you know, it’s very important for us to capture the details of the experiments so we can figure out what actually needs to be done, and the most appropriate method.</p>
<p>Internally, we use a self-hosted foswiki instance to keep lists of what needs to be done, document SOPs, and capture experimental details from collaborators.</p>
<p>With every project we get asked to work on, we have a meeting, and who is at that meeting is usually determined by what kind of analysis the potential collaborator has asked for.</p>
</section>
<section id="template" class="level2">
<h2 class="anchored" data-anchor-id="template">Template</h2>
<p>During that meeting, we fill in all the details of this template (which I translated to markdown from foswiki). Obviously, not all of the fields necessarily get filled out for each project, and sometimes other custom fields will get added. This template helps us capture the minimum information needed.</p>
<pre><code>## Meeting Description
  * Date/Time: 
  * Length: 1 hour

### Attendance
  * 
  * 

### Meeting Purpose

## Project Description

### Overall Purpose

### Implementation Timeline
  * Design/Conceptualization:
  * Experiment: 
    * Start:  ; End:
  * Sample Collection and Preparation:
  * Data Collection:
  * Data Analysis:

### Experimental Design

### Specific Data Analysis Questions

## Conclusions

### TODO
</code></pre>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Project {Consultation} {Template}},
  date = {2022-02-08},
  url = {https://rmflight.github.io/posts/2022-02-08-project-consultation-template},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Project Consultation Template.”</span>
February 8, 2022. <a href="https://rmflight.github.io/posts/2022-02-08-project-consultation-template">https://rmflight.github.io/posts/2022-02-08-project-consultation-template</a>.
</div></div></section></div> ]]></description>
  <category>research</category>
  <guid>https://rmflight.github.io/posts/2022-02-08-project-consultation-template/index.html</guid>
  <pubDate>Tue, 08 Feb 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Heatmap Colormaps!</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-01-31-heatmap-colormaps/index.html</link>
  <description><![CDATA[ 




<section id="normal-incrementing-data" class="level2">
<h2 class="anchored" data-anchor-id="normal-incrementing-data">Normal Incrementing Data</h2>
<p>Nine times out of ten, you probably need just one of the <code>{viridis}</code> colormaps for values that are increasing in one direction. For example, correlation values that are all positive, or abundances from RNA-Seq, etc. If you want to use them with <code>{ComplexHeatmap}</code>, you do so like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;"># correlation example for 0 - 1</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;"># imagine cor_vals is a set of correlation values</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(ComplexHeatmap)</span>
<span id="cb1-4">cor_start <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb1-5">cor_end <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb1-6">n_break <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">20</span></span>
<span id="cb1-7">viridis_map <span class="ot" style="color: #003B4F;">=</span> circlize<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">colorRamp2</span>(<span class="fu" style="color: #4758AB;">seq</span>(cor_start, </span>
<span id="cb1-8">                                       cor_end, </span>
<span id="cb1-9">                                       <span class="at" style="color: #657422;">length.out =</span> n_break),</span>
<span id="cb1-10">                                   viridis<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">viridis</span>(n_break))</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;">Heatmap</span>(cor_vals, </span>
<span id="cb1-13">        <span class="at" style="color: #657422;">col =</span> viridis_map, </span>
<span id="cb1-14">        ...)</span></code></pre></div>
</div>
</section>
<section id="divergent-data" class="level2">
<h2 class="anchored" data-anchor-id="divergent-data">Divergent Data</h2>
<p>In this case, you have values where a <strong>central</strong> value is a natural point that you want to highlight things <strong>above</strong> and <strong>below</strong> that value. Examples include correlations that include negative and positive correlations, log-fold-changes above and below zero. In this case, I prefer the <code>{scico}</code> package with the <code>vik</code> colormap.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">cor_start <span class="ot" style="color: #003B4F;">=</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb2-2">cor_end <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb2-3">n_break <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">20</span></span>
<span id="cb2-4"></span>
<span id="cb2-5">scico_map <span class="ot" style="color: #003B4F;">=</span> circlize<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">colorRamp2</span>(<span class="fu" style="color: #4758AB;">seq</span>(cor_start</span>
<span id="cb2-6">                                     cor_end,</span>
<span id="cb2-7">                                     <span class="at" style="color: #657422;">length.out =</span> n_break),</span>
<span id="cb2-8">                                 scico<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">scico</span>(n_break, </span>
<span id="cb2-9">                                              <span class="at" style="color: #657422;">palette =</span> <span class="st" style="color: #20794D;">"vik"</span>))</span>
<span id="cb2-10"></span>
<span id="cb2-11"><span class="fu" style="color: #4758AB;">Heatmap</span>(cor_vals, </span>
<span id="cb2-12">        <span class="at" style="color: #657422;">col =</span> scico_map,</span>
<span id="cb2-13">        ...)</span></code></pre></div>
</div>
</section>
<section id="other-colormaps" class="level2">
<h2 class="anchored" data-anchor-id="other-colormaps">Other Colormaps?</h2>
<p>Do you have other suggestions for colormaps, both incremental and divergent? Please let me know in the comments!</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Heatmap {Colormaps!}},
  date = {2022-01-31},
  url = {https://rmflight.github.io/posts/2022-01-31-heatmap-colormaps},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Heatmap Colormaps!”</span> January 31,
2022. <a href="https://rmflight.github.io/posts/2022-01-31-heatmap-colormaps">https://rmflight.github.io/posts/2022-01-31-heatmap-colormaps</a>.
</div></div></section></div> ]]></description>
  <category>colormaps</category>
  <category>visualization</category>
  <category>heatmap</category>
  <category>random-code-snippets</category>
  <guid>https://rmflight.github.io/posts/2022-01-31-heatmap-colormaps/index.html</guid>
  <pubDate>Mon, 31 Jan 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Recreating Correlation Values from Another Manuscript</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-01-15-recreating-correlation-values-from-another-manuscript/index.html</link>
  <description><![CDATA[ 




<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>I’ve been working on a manuscript for our newish correlation method, information-content-informed Kendall-tau (ICI-Kendalltau, package currently at <span class="citation" data-cites="icikendalltau">(Flight and Moseley 2021)</span>). As part of that manuscript, we wanted to highlight how well the correlation measure detects outlier samples. Two datasets we are using for that aspect are public, one from The Cancer Genome Atlas and the other from the Barton group. The Barton group and collaborators produced a highly replicated RNAseq yeast dataset, 48 replicates in two conditions, and have used it in various analyses <span class="citation" data-cites="Gierlinski2015 Schurch2016">(Gierliński et al. 2015; Schurch et al. 2016)</span>.</p>
</section>
<section id="so-what" class="level2">
<h2 class="anchored" data-anchor-id="so-what">So What</h2>
<p>For my manuscript, ideally I want to be able to comment on the outliers found in one of the Barton group manuscripts <span class="citation" data-cites="Gierlinski2015">(Gierliński et al. 2015)</span>. To do that, I need access to one of:</p>
<ul>
<li>the sample-sample correlations themselves,</li>
<li>the counts from each sample</li>
<li>or be able to recreate counts from each sample.</li>
</ul>
<p>Several years ago I was asking about this dataset on twitter when I was using it for another project, because the project ID in the SRA didn’t have a mapping to condition. Dr.&nbsp;Geoff Barton pointed me to a metadata file available on figshare <span class="citation" data-cites="Barton2015">(Barton, Blaxter, Cole, Gharbi, Gierliński, Owen-Hughes, et al. 2015)</span>. This allowed me to generate read counts across biological replicates (which is what I was interested in at the time). However, if I had poked around the figshare project a bit more, I would have likely seen both of the files with read counts for each replicate already available <span class="citation" data-cites="SNF2Barton2015 WTBarton2015">(Barton, Blaxter, Cole, Gharbi, Gierliński, Schofield, et al. 2015a, 2015b)</span>. It really sucks that I hadn’t noticed these other files years ago, it would have saved me the effort in remapping and generating gene counts myself, as well as getting really weird correlation values compared to <span class="citation" data-cites="Gierlinski2015">(Gierliński et al. 2015)</span>.</p>
</section>
<section id="my-correlations" class="level2">
<h2 class="anchored" data-anchor-id="my-correlations">My Correlations</h2>
<p>From the demultiplexed read data and the metadata file I found several years ago, I had run RNA-seq mapping software to generate read counts for each sample in each lane, and summed them across lanes. I know how to do these kinds of things, even though I will be the first to admit it is <strong>not</strong> my personal bread and butter analysis (I normally get involved after count generation). With the (few) hints from the manuscript about how <span class="citation" data-cites="Gierlinski2015">(Gierliński et al. 2015)</span> did the correlation calculation (see more below), I don’t get anything close to the range of median correlation values within each class of samples. Which I thought was very, very weird. I implemented a variety of transformation methods and inclusion of missing values for my correlation calculations:</p>
<ul>
<li>logged values (log and log1p)</li>
<li>raw values</li>
<li>removal and inclusion of missing (0) values</li>
</ul>
<p>Even with all of these variations, I could not come close to the same values I found presented in their manuscript. Here, in panel (a) of Figure 2 from <span class="citation" data-cites="Gierlinski2015">(Gierliński et al. 2015)</span>, the median correlations range from 0.7 to 1.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-01-15-recreating-correlation-values-from-another-manuscript/gierlinski_2015_fig2_cropped.png" class="external img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure 2(a) from <span class="citation" data-cites="Gierlinski2015">(Gierliński et al. 2015)</span>. Identifying bad RNA-seq replicates in the WT (left) and Δsnf2 (right) data. The top three panels (a–c) show individual criteria for identifying ‘bad’ replicates which are combined into a quality score (d) in order to identify ‘bad’ replicates in each condition. The identified ‘bad’ replicates are shown as numbered points in each panel. The individual criteria are (a) median correlation coefficient, ri∼⁠, for each replicate i against all other replicates, (b) outlier fraction, fi⁠, calculated as a fraction of genes where the given replicate is more than five-trimmed standard deviations from the trimmed mean and (c) median reduced χ2 of pileup depth, χ∼2i⁠, as a measure of the non-uniformity of read distribution within genes (see also Fig. 3)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>My ranges, however, were much different.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(dplyr)</span>
<span id="cb1-2">out_ranges <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">readRDS</span>(here<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">here</span>(<span class="st" style="color: #20794D;">"data_files"</span>, <span class="st" style="color: #20794D;">"ranges.rds"</span>))</span>
<span id="cb1-3">knitr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">kable</span>(out_ranges<span class="sc" style="color: #5E5E5E;">$</span>rmf_ranges, <span class="at" style="color: #657422;">digits =</span> <span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">caption =</span> <span class="st" style="color: #20794D;">'RMF median correlation ranges. Which is "which" method was used to calculate the correlations.'</span>)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>RMF median correlation ranges. Which is “which” method was used to calculate the correlations.</caption>
<thead>
<tr class="header">
<th style="text-align: left;">which</th>
<th style="text-align: left;">sample_class</th>
<th style="text-align: right;">high</th>
<th style="text-align: right;">low</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">log</td>
<td style="text-align: left;">SNF2</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">0.96</td>
</tr>
<tr class="even">
<td style="text-align: left;">log</td>
<td style="text-align: left;">WT</td>
<td style="text-align: right;">0.97</td>
<td style="text-align: right;">0.89</td>
</tr>
<tr class="odd">
<td style="text-align: left;">log_no0</td>
<td style="text-align: left;">SNF2</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">0.95</td>
</tr>
<tr class="even">
<td style="text-align: left;">log_no0</td>
<td style="text-align: left;">WT</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">0.87</td>
</tr>
<tr class="odd">
<td style="text-align: left;">raw</td>
<td style="text-align: left;">SNF2</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">0.96</td>
</tr>
<tr class="even">
<td style="text-align: left;">raw</td>
<td style="text-align: left;">WT</td>
<td style="text-align: right;">0.97</td>
<td style="text-align: right;">0.67</td>
</tr>
<tr class="odd">
<td style="text-align: left;">raw_no0</td>
<td style="text-align: left;">SNF2</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">0.96</td>
</tr>
<tr class="even">
<td style="text-align: left;">raw_no0</td>
<td style="text-align: left;">WT</td>
<td style="text-align: right;">0.97</td>
<td style="text-align: right;">0.67</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can see in this table, that my median correlation ranges are not even close to what we can see in the figure.</p>
<p>And the lowest values and samples didn’t seem to be right either.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">out_ranges<span class="sc" style="color: #5E5E5E;">$</span>rmf_medians <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb2-2">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">filter</span>(which <span class="sc" style="color: #5E5E5E;">%in%</span> <span class="st" style="color: #20794D;">"raw_no0"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb2-3">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">group_by</span>(sample_class) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb2-4">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">arrange</span>(med_cor) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb2-5">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">slice_head</span>(<span class="at" style="color: #657422;">n =</span> <span class="dv" style="color: #AD0000;">6</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb2-6">  knitr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">kable</span>(., <span class="at" style="color: #657422;">digits =</span> <span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">caption =</span> <span class="st" style="color: #20794D;">"Lowest median correlation values using my own counts."</span>)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Lowest median correlation values using my own counts.</caption>
<thead>
<tr class="header">
<th style="text-align: left;">sample_id</th>
<th style="text-align: right;">med_cor</th>
<th style="text-align: left;">sample_class</th>
<th style="text-align: left;">which</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">SNF2.7</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: left;">SNF2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">SNF2.33</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: left;">SNF2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SNF2.27</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: left;">SNF2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">SNF2.8</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: left;">SNF2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SNF2.48</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: left;">SNF2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">SNF2.23</td>
<td style="text-align: right;">0.97</td>
<td style="text-align: left;">SNF2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">WT.32</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">WT.14</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">WT.11</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">WT.13</td>
<td style="text-align: right;">0.83</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">WT.16</td>
<td style="text-align: right;">0.87</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">WT.12</td>
<td style="text-align: right;">0.91</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="finding-the-data" class="level2">
<h2 class="anchored" data-anchor-id="finding-the-data">Finding the Data</h2>
<p>Finally, during the week of 2021-11-25, I happened across another manuscript on this dataset from 2016 <span class="citation" data-cites="Schurch2016">(Schurch et al. 2016)</span>, that mentions a GitHub repo that lo and behold had copies of the preprocessed data to the level of gene counts per biological replicate <span class="citation" data-cites="bartongithub2015">(Cole et al. 2015)</span>. Awesome!</p>
</section>
<section id="new-correlation" class="level2">
<h2 class="anchored" data-anchor-id="new-correlation">New Correlation</h2>
<p>Using that preprocessed data, I was finally able to get what amounted to identical values of correlation, based on comparing the lowest correlation values with the figure. Great.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">knitr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">kable</span>(out_ranges<span class="sc" style="color: #5E5E5E;">$</span>barton, <span class="at" style="color: #657422;">digits =</span> <span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">caption =</span> <span class="st" style="color: #20794D;">'Barton median correlation ranges. Which is "which" method was used to calculate the correlations.'</span>)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Barton median correlation ranges. Which is “which” method was used to calculate the correlations.</caption>
<thead>
<tr class="header">
<th style="text-align: left;">which</th>
<th style="text-align: left;">sample_class</th>
<th style="text-align: right;">high</th>
<th style="text-align: right;">low</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">log</td>
<td style="text-align: left;">Snf2</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">0.95</td>
</tr>
<tr class="even">
<td style="text-align: left;">log</td>
<td style="text-align: left;">WT</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">0.97</td>
</tr>
<tr class="odd">
<td style="text-align: left;">log_no0</td>
<td style="text-align: left;">Snf2</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">0.91</td>
</tr>
<tr class="even">
<td style="text-align: left;">log_no0</td>
<td style="text-align: left;">WT</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">0.94</td>
</tr>
<tr class="odd">
<td style="text-align: left;">raw</td>
<td style="text-align: left;">Snf2</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.71</td>
</tr>
<tr class="even">
<td style="text-align: left;">raw</td>
<td style="text-align: left;">WT</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">0.77</td>
</tr>
<tr class="odd">
<td style="text-align: left;">raw_no0</td>
<td style="text-align: left;">Snf2</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.71</td>
</tr>
<tr class="even">
<td style="text-align: left;">raw_no0</td>
<td style="text-align: left;">WT</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">0.77</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In this table, for the <strong>raw</strong> correlations, we finally see median correlation ranges that match what is observed in the figure, especially at the low end. Importantly, the Snf2 lowest value is lower than the WT lowest value. So I’m pretty sure I’m getting the correct sample-sample correlations now.</p>
<p>As well, if I look at the lowest sample - sample correlations in each class, the sample IDs match what is in the figure as well, and so do the median sample-sample correlations for those samples!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">out_ranges<span class="sc" style="color: #5E5E5E;">$</span>barton_medians <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-2">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">filter</span>(which <span class="sc" style="color: #5E5E5E;">%in%</span> <span class="st" style="color: #20794D;">"raw_no0"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-3">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">group_by</span>(sample_class) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-4">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">arrange</span>(med_cor) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-5">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">slice_head</span>(<span class="at" style="color: #657422;">n =</span> <span class="dv" style="color: #AD0000;">6</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-6">  knitr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">kable</span>(., <span class="at" style="color: #657422;">digits =</span> <span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">caption =</span> <span class="st" style="color: #20794D;">"Lowest median correlation values using Barton counts."</span>)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Lowest median correlation values using Barton counts.</caption>
<thead>
<tr class="header">
<th style="text-align: left;">sample_id</th>
<th style="text-align: right;">med_cor</th>
<th style="text-align: left;">sample_class</th>
<th style="text-align: left;">which</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Snf2.06</td>
<td style="text-align: right;">0.71</td>
<td style="text-align: left;">Snf2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Snf2.13</td>
<td style="text-align: right;">0.83</td>
<td style="text-align: left;">Snf2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Snf2.35</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: left;">Snf2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Snf2.10</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: left;">Snf2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Snf2.25</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: left;">Snf2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Snf2.24</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: left;">Snf2</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">WT.21</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">WT.25</td>
<td style="text-align: right;">0.86</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">WT.28</td>
<td style="text-align: right;">0.89</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">WT.22</td>
<td style="text-align: right;">0.94</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">WT.17</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
<tr class="even">
<td style="text-align: left;">WT.36</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: left;">WT</td>
<td style="text-align: left;">raw_no0</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="why-no-log-transformation" class="level2">
<h2 class="anchored" data-anchor-id="why-no-log-transformation">Why No Log-Transformation?</h2>
<p>One interesting thing about having the correct correlations is discovering that Gierlinski et al didn’t use log-transformed data in their Pearson correlation calculations. This seems unusual to me. All my career in -omics, the one thing I’ve had drilled into me is that doing a linear correlation on data that has proportional error component or variance is a <strong>very bad</strong> idea. Proportional error or variance means the variance increases with increasing mean values, which is definitely true of these count data.</p>
<p>If I had to guess <strong>why</strong> log-transformed values weren’t used, I think it is because of the analysis in the replicate paper about how well the un-transformed values fit a normal distribution vs a log-normal distribution. That figure and caption are provided here for reference.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rmflight.github.io/posts/2022-01-15-recreating-correlation-values-from-another-manuscript/gierlinski_2015_fig5.jpeg" class="external img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure 5 from <span class="citation" data-cites="Gierlinski2015">(Gierliński et al. 2015)</span>. Goodness-of-fit test results for normal (top panels), log-normal (middle panels) and negative binomial (bottom panels) distributions. Each panel shows the test P-value versus the mean count across replicates. Each dot represents equal-count normalized data from one gene. Panels on the left (a, b, e, f, i, j) show clean data with bad replicates rejected (42 and 44 replicates remaining in WT and Δsnf2, respectively). Panels on the right (c, d, g, h, k, l) show all available data (48 replicates in each condition). Due to the number of bootstraps performed, P-values for the negative-binomial test are limited to ∼10−2. Due to numerical precision of the software library used, P-values from the normal and log-normal tests are limited to ∼10−16. Below these limits data points are marked in orange (light gray in black and white) at the bottom of each panel. Horizontal lines show the Benjamini–Hochberg limit corresponding to the significance of 0.05 for the given dataset. The numbers in the right bottom corner of each panel indicate the number of genes with P-values below the significance limit and the total number of genes</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Just so you can see the difference using raw and log-space makes (besides the values in the above table), here are two of the replicate samples plotted against each other in raw and log-transformed values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">library</span>(patchwork)</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;">library</span>(ggplot2)</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;">theme_set</span>(cowplot<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">theme_cowplot</span>())</span>
<span id="cb5-4"></span>
<span id="cb5-5">raw_plot <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">readRDS</span>(here<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">here</span>(<span class="st" style="color: #20794D;">"data_files"</span>, <span class="st" style="color: #20794D;">"raw_plot.rds"</span>))</span>
<span id="cb5-6">raw_p2 <span class="ot" style="color: #003B4F;">=</span> raw_plot <span class="sc" style="color: #5E5E5E;">+</span> </span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;">coord_equal</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-8">  <span class="fu" style="color: #4758AB;">geom_abline</span>(<span class="at" style="color: #657422;">slope =</span> <span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"red"</span>)</span>
<span id="cb5-9">log_plot <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">readRDS</span>(here<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">here</span>(<span class="st" style="color: #20794D;">"data_files"</span>, <span class="st" style="color: #20794D;">"log_plot.rds"</span>))</span>
<span id="cb5-10">log_p2 <span class="ot" style="color: #003B4F;">=</span> log_plot <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-11">  <span class="fu" style="color: #4758AB;">coord_equal</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-12">  <span class="fu" style="color: #4758AB;">geom_abline</span>(<span class="at" style="color: #657422;">slope =</span> <span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"red"</span>)</span>
<span id="cb5-13">raw_p2 <span class="sc" style="color: #5E5E5E;">+</span> log_p2</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://rmflight.github.io/posts/2022-01-15-recreating-correlation-values-from-another-manuscript/index_files/figure-html/raw_log-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can summarize this behavior across <strong>all</strong> the replicate samples, looking at standard deviation (SD) and relative standard deviation (RSD, SD / mean). I took the counts from Barton group after removing outliers based on median correlations, and then calculate the mean, SD, and RSD across all replicates in each of Snf2 and WT.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">data_summary <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">readRDS</span>(here<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">here</span>(<span class="st" style="color: #20794D;">"data_files"</span>, <span class="st" style="color: #20794D;">"summary.rds"</span>))</span>
<span id="cb6-2"></span>
<span id="cb6-3">data_summary <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-4">  dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">filter</span>(<span class="sc" style="color: #5E5E5E;">!</span>(type <span class="sc" style="color: #5E5E5E;">%in%</span> <span class="st" style="color: #20794D;">"diff"</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> mean, <span class="at" style="color: #657422;">y =</span> var)) <span class="sc" style="color: #5E5E5E;">+</span> </span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;">geom_point</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;">~</span> type, <span class="at" style="color: #657422;">ncol =</span> <span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">scales =</span> <span class="st" style="color: #20794D;">"free_y"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 494 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="https://rmflight.github.io/posts/2022-01-15-recreating-correlation-values-from-another-manuscript/index_files/figure-html/sd_rsd-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>As we can see in the above figure, SD increases with increasing mean. Which is basically what we observe in the pairwise plot above. I’m pretty sure I’ve been taught <strong>not</strong> to do Pearson correlation on data with this structure. Interestingly, the RSD does become rather constant after a certain value in mean expression.</p>
</section>
<section id="how-did-i-miss-the-original-data" class="level2">
<h2 class="anchored" data-anchor-id="how-did-i-miss-the-original-data">How Did I Miss the Original Data?</h2>
<p>Back to the question of finding the original data, it turns out I just didn’t look hard enough at the first place that Geoff Barton sent me to. When I started poking around the figshare repo’s from Geoff and others in the group and following links, it was easy to find a copy of the preprocessed data from each condition.</p>
</section>
<section id="why-was-it-so-hard-to-reproduce-values" class="level2">
<h2 class="anchored" data-anchor-id="why-was-it-so-hard-to-reproduce-values">Why Was it So Hard to Reproduce Values?</h2>
<p>Another interesting thing about this endeavor was just how hard it was to reproduce the correlations. <span class="citation" data-cites="Gierlinski2015">(Gierliński et al. 2015)</span> was actually light on details of how the data was processed, and how the correlation was done. For example, the manuscript just says “Pearson correlation”, with basically no other details. Were raw counts used or log-transformed? Were missing (count of 0) values in either sample removed prior to correlation? It was only when I finally happened across the GitHub repo that I finally got the answers I really needed. And for some reason, that manuscript doesn’t mention the GitHub repo, or the data available on figshare. This points to the importance of citing and linking all the resources for a manuscript (or even a blog post!). And I’m not trying to knock on Marek, or Geoff, or Nick on this. In my experience, they post open things, and provide lots of data. But this highlights just how hard it becomes to recreate something if even a little piece of the data is missing.</p>
</section>
<section id="data-files-and-scripts" class="level2">
<h2 class="anchored" data-anchor-id="data-files-and-scripts">Data Files and Scripts</h2>
<p>The rds files and a processing script to calculate the correlations and generate the plots are all available on the blog directory on GitHub <span class="citation" data-cites="flight_post">(Flight 2022)</span>.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Barton2015" class="csl-entry">
Barton, Geoffrey, Mark Blaxter, Christian Cole, Karim Gharbi, Marek Gierliński, Tom Owen-Hughes, Pieta Schofield, et al. 2015. <span>“<span class="nocase">Metadata for a highly replicated two-condition yeast RNAseq experiment.</span>”</span> July. <a href="https://doi.org/10.6084/m9.figshare.1416210.v3">https://doi.org/10.6084/m9.figshare.1416210.v3</a>.
</div>
<div id="ref-SNF2Barton2015" class="csl-entry">
Barton, Geoffrey, Mark Blaxter, Christian Cole, Karim Gharbi, Marek Gierliński, Pieta Schofield, Nick Schurch, Vijender Singh, and Nicola Wrobel. 2015a. <span>“<span class="nocase">SNF2 knock-out yeast gene read counts from a 48 replicate experiment</span>,”</span> May. <a href="https://doi.org/10.6084/m9.figshare.1425502.v1">https://doi.org/10.6084/m9.figshare.1425502.v1</a>.
</div>
<div id="ref-WTBarton2015" class="csl-entry">
———. 2015b. <span>“<span class="nocase">Wild-type yeast gene read counts from 48 replicate experiment</span>,”</span> May. <a href="https://doi.org/10.6084/m9.figshare.1425503.v1">https://doi.org/10.6084/m9.figshare.1425503.v1</a>.
</div>
<div id="ref-bartongithub2015" class="csl-entry">
Cole, Chris, Nick Schurch, Rayna M Harris, and Marek Gierliński. 2015. <span>“profDGE48.”</span> <a href="https://github.com/bartongroup/profDGE48">https://github.com/bartongroup/profDGE48</a>.
</div>
<div id="ref-flight_post" class="csl-entry">
Flight, Robert M. 2022. <span>“Post Files.”</span> <a href="https://github.com/rmflight/researchBlog_distill/tree/main/_posts/2022-01-15-recreating-correlation-values-from-another-manuscript">https://github.com/rmflight/researchBlog_distill/tree/main/_posts/2022-01-15-recreating-correlation-values-from-another-manuscript</a>.
</div>
<div id="ref-icikendalltau" class="csl-entry">
Flight, Robert M, and Hunter NB Moseley. 2021. <span>“ICIKendallTau.”</span> <a href="https://github.com/MoseleyBioinformaticsLab/ICIKendallTau">https://github.com/MoseleyBioinformaticsLab/ICIKendallTau</a>.
</div>
<div id="ref-Gierlinski2015" class="csl-entry">
Gierliński, Marek, Christian Cole, Pietà Schofield, Nicholas J. Schurch, Alexander Sherstnev, Vijender Singh, Nicola Wrobel, et al. 2015. <span>“<span class="nocase">Statistical models for RNA-seq data derived from a two-condition 48-replicate experiment</span>.”</span> <em>Bioinformatics</em> 31 (22): 3625–30. <a href="https://doi.org/10.1093/bioinformatics/btv425">https://doi.org/10.1093/bioinformatics/btv425</a>.
</div>
<div id="ref-Schurch2016" class="csl-entry">
Schurch, Nicholas J., Pietá Schofield, Marek Gierliński, Christian Cole, Alexander Sherstnev, Vijender Singh, Nicola Wrobel, et al. 2016. <span>“How Many Biological Replicates Are Needed in an RNA-Seq Experiment and Which Differential Expression Tool Should You Use?”</span> <em>RNA</em> 22 (6): 839–51. <a href="https://doi.org/10.1261/rna.053959.115">https://doi.org/10.1261/rna.053959.115</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Recreating {Correlation} {Values} from {Another}
    {Manuscript}},
  date = {2022-01-15},
  url = {https://rmflight.github.io/posts/2022-01-15-recreating-correlation-values-from-another-manuscript},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Recreating Correlation Values from Another
Manuscript.”</span> January 15, 2022. <a href="https://rmflight.github.io/posts/2022-01-15-recreating-correlation-values-from-another-manuscript">https://rmflight.github.io/posts/2022-01-15-recreating-correlation-values-from-another-manuscript</a>.
</div></div></section></div> ]]></description>
  <category>reproducibility</category>
  <category>correlation</category>
  <guid>https://rmflight.github.io/posts/2022-01-15-recreating-correlation-values-from-another-manuscript/index.html</guid>
  <pubDate>Sat, 15 Jan 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Cairo and XQuartz in Mac GitHub Actions</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-01-06-cairo-and-xquartz-in-mac-github-actions/index.html</link>
  <description><![CDATA[ 




<p>I’ve been using GitHub actions to check and test some of my R packages on multiple architectures, which is nice because I work primarily on Linux.</p>
<p>One recent package uses the <code>{Cairo}</code> package to generate images that are subsequently used for visualization <span class="citation" data-cites="cairopackage">(Urbanek and Horner 2020)</span>.</p>
<p>Interestingly, <code>{Cairo}</code> will install fine on MacOS, and then fail as soon as you do <code>library(Cairo)</code>, complaining about not being able to load the {cairo.so} file.</p>
<p>Thankfully, it seems that the GitHub actions MacOS VMs have homebrew <span class="citation" data-cites="homebrew">(<span>“Homebrew”</span> 2022)</span> installed, which means we can use the xquartz brew <span class="citation" data-cites="xquartzbrew">(<span>“Xquartz Homebrew Formulae”</span> 2022)</span> to install it, and have {cairo.so} available.</p>
<p>To add this to your GitHub actions yml, you should add these lines, and double check the brew syntax with the official docs.</p>
<pre><code>    steps:
      - name: Install X11 dependencies on MacOS
        if: runner.os == 'macOS'
        run: |
          brew install --cask xquartz</code></pre>




<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-homebrew" class="csl-entry">
<span>“Homebrew.”</span> 2022. <a href="https://brew.sh/">https://brew.sh/</a>.
</div>
<div id="ref-cairopackage" class="csl-entry">
Urbanek, Simon, and Jeffrey Horner. 2020. <em>Cairo: R Graphics Device Using Cairo Graphics Library for Creating High-Quality Bitmap (PNG, JPEG, TIFF), Vector (PDF, SVG, PostScript) and Display (X11 and Win32) Output</em>. <a href="https://CRAN.R-project.org/package=Cairo">https://CRAN.R-project.org/package=Cairo</a>.
</div>
<div id="ref-xquartzbrew" class="csl-entry">
<span>“Xquartz Homebrew Formulae.”</span> 2022. <a href="https://formulae.brew.sh/cask/xquartz#default">https://formulae.brew.sh/cask/xquartz#default</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Cairo and {XQuartz} in {Mac} {GitHub} {Actions}},
  date = {2022-01-06},
  url = {https://rmflight.github.io/posts/2022-01-06-cairo-and-xquartz-in-mac-github-actions},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Cairo and XQuartz in Mac GitHub
Actions.”</span> January 6, 2022. <a href="https://rmflight.github.io/posts/2022-01-06-cairo-and-xquartz-in-mac-github-actions">https://rmflight.github.io/posts/2022-01-06-cairo-and-xquartz-in-mac-github-actions</a>.
</div></div></section></div> ]]></description>
  <category>random-code-snippets</category>
  <category>cairo</category>
  <category>xquartz</category>
  <category>development</category>
  <category>github</category>
  <category>R</category>
  <guid>https://rmflight.github.io/posts/2022-01-06-cairo-and-xquartz-in-mac-github-actions/index.html</guid>
  <pubDate>Thu, 06 Jan 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Dplyr in Packages and Global Variables</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-01-06-dplyr-in-packages-and-global-variables/index.html</link>
  <description><![CDATA[ 




<p>I was recently cleaning up a development package so it would actually pass checks so it could be hosted on our labs new r-universe <span class="citation" data-cites="moseleyruniverse">(<span>“The ’Moseleybioinformaticslab’ Universe,”</span> n.d.)</span>, and was getting warnings about global variables due to using <code>{dplyr}</code> operations, without {enquoting} variables.</p>
<p>There are a few approaches to handling this.</p>
<ol type="1">
<li>Using {utils::globalvariables} in an R file somewhere.</li>
<li>Using {rlang::.data} and importing it into the package.</li>
</ol>
<p>I went with option <strong>2</strong>, see <span class="citation" data-cites="nobindingsolution">(<span>“How to Solve ’No Visible Binding for Global Variables’,”</span> n.d.)</span>.</p>
<p>In the original version of <code>{dplyr}</code> and other packages like {ggplot2}, there was an option to use “string” arguments, normally by calling the {*_str} or {*_} version of a function name.</p>
<p>That has gone out of fashion, and the way to do it now is to use the .data pronoun <span class="citation" data-cites="dplyrvignette">(<span>“Programming with Dplyr,”</span> n.d.)</span>.</p>
<p>So now the code looks like this:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;"># an example filtering operation</span></span>
<span id="cb1-2">dplyr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">filter</span>(.data<span class="sc" style="color: #5E5E5E;">$</span>varname <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"value"</span>)</span></code></pre></div>
<p>The easiest way to include this correctly in your package, is by importing the {rlang::.data}.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;">#' @importFrom rlang .data</span></span></code></pre></div>
<p>And all the warnings should go away during package checking.</p>




<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-nobindingsolution" class="csl-entry">
<span>“How to Solve ’No Visible Binding for Global Variables’.”</span> n.d. <a href="https://community.rstudio.com/t/how-to-solve-no-visible-binding-for-global-variable-note/28887/3">https://community.rstudio.com/t/how-to-solve-no-visible-binding-for-global-variable-note/28887/3</a>.
</div>
<div id="ref-dplyrvignette" class="csl-entry">
<span>“Programming with Dplyr.”</span> n.d. <a href="https://cran.r-project.org/web/packages/dplyr/vignettes/programming.html">https://cran.r-project.org/web/packages/dplyr/vignettes/programming.html</a>.
</div>
<div id="ref-moseleyruniverse" class="csl-entry">
<span>“The ’Moseleybioinformaticslab’ Universe.”</span> n.d. <a href="https://moseleybioinformaticslab.r-universe.dev/ui#builds">https://moseleybioinformaticslab.r-universe.dev/ui#builds</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Dplyr in {Packages} and {Global} {Variables}},
  date = {2022-01-06},
  url = {https://rmflight.github.io/posts/2022-01-06-dplyr-in-packages-and-global-variables},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Dplyr in Packages and Global
Variables.”</span> January 6, 2022. <a href="https://rmflight.github.io/posts/2022-01-06-dplyr-in-packages-and-global-variables">https://rmflight.github.io/posts/2022-01-06-dplyr-in-packages-and-global-variables</a>.
</div></div></section></div> ]]></description>
  <category>random-code-snippets</category>
  <category>packages</category>
  <category>dplyr</category>
  <category>rlang</category>
  <category>R</category>
  <category>development</category>
  <guid>https://rmflight.github.io/posts/2022-01-06-dplyr-in-packages-and-global-variables/index.html</guid>
  <pubDate>Thu, 06 Jan 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Pie Charts in RCy3</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2022-01-06-pie-charts-in-rcy3/index.html</link>
  <description><![CDATA[ 




<p>I have a package, <code>{categoryCompare2}</code> <span class="citation" data-cites="categorycompare2">(Flight 2022)</span> that I’ve been working on for a while, and recently wanted to make available on our labs r-universe <span class="citation" data-cites="moseleyruniverse">(<span>“The ’Moseleybioinformaticslab’ Universe,”</span> n.d.)</span>.</p>
<p>For some of the <strong>current</strong> visualization, we use Cytoscape to examine annotation similarity graphs, coupling the R together with Cytoscape via <code>{RCy3}</code> <span class="citation" data-cites="rcy3">(Gustavsen et al. 2019)</span>. In the previous iteration, we had used actual piechart images generated by R, and then used <code>setNodeImageDirect</code> to point the node images to local image files.</p>
<p>However, the latest iteration of <code>{RCy3}</code> has essentially lost that functionality. However, there is a new visualization plugin that can do similar things, enhancedGraphics <span class="citation" data-cites="enhancedGraphics">(Morris JH 2014)</span>.</p>
<p>Alexander Pico, one of the primary <code>{RCy3}</code> developers, provided me with the guidance for a code solution <span class="citation" data-cites="piechartissue">(Pico 2022)</span>, which I’ve adapted below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">grp_matrix <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">matrix</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb1-2">                      <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>), <span class="at" style="color: #657422;">nrow =</span> <span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">ncol =</span> <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb1-3">n_grp <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">nrow</span>(grp_matrix)</span>
<span id="cb1-4">use_color <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rainbow_hcl</span>(<span class="fu" style="color: #4758AB;">ncol</span>(grp_matrix), <span class="at" style="color: #657422;">c =</span> <span class="dv" style="color: #AD0000;">100</span>)</span>
<span id="cb1-5">n_color <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">length</span>(use_color)</span>
<span id="cb1-6">use_color <span class="ot" style="color: #003B4F;">=</span> color</span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;"># defines how many pie segments are needed, common to all the pie-charts</span></span>
<span id="cb1-8">pie_area <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">/</span> n_color, n_color)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;">names</span>(pie_area) <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="st" style="color: #20794D;">""</span>, n_color)</span>
<span id="cb1-10"></span>
<span id="cb1-11"></span>
<span id="cb1-12">desat_color <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">desaturate</span>(use_color)</span>
<span id="cb1-13"><span class="fu" style="color: #4758AB;">names</span>(desat_color) <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">names</span>(use_color)</span>
<span id="cb1-14">piechart_strings <span class="ot" style="color: #003B4F;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map_dfr</span>(<span class="fu" style="color: #4758AB;">rownames</span>(grp_matrix), <span class="cf" style="color: #003B4F;">function</span>(i_grp){</span>
<span id="cb1-15">  tmp_logical <span class="ot" style="color: #003B4F;">&lt;-</span> grp_matrix[i_grp, ]</span>
<span id="cb1-16">  tmp_color <span class="ot" style="color: #003B4F;">&lt;-</span> use_color</span>
<span id="cb1-17">    </span>
<span id="cb1-18">  <span class="co" style="color: #5E5E5E;"># add the proper desaturated versions of the colors</span></span>
<span id="cb1-19">  tmp_color[<span class="sc" style="color: #5E5E5E;">!</span>tmp_logical] <span class="ot" style="color: #003B4F;">&lt;-</span> desat_color[<span class="sc" style="color: #5E5E5E;">!</span>tmp_logical]</span>
<span id="cb1-20">    </span>
<span id="cb1-21">  out_str <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">'piechart: attributelist="'</span>,</span>
<span id="cb1-22">                   <span class="fu" style="color: #4758AB;">paste</span>(<span class="fu" style="color: #4758AB;">colnames</span>(grp_matrix), <span class="at" style="color: #657422;">collapse =</span> <span class="st" style="color: #20794D;">','</span>),</span>
<span id="cb1-23">                   <span class="st" style="color: #20794D;">'" '</span>,</span>
<span id="cb1-24">                   <span class="st" style="color: #20794D;">'colorlist="'</span>,</span>
<span id="cb1-25">                   <span class="fu" style="color: #4758AB;">paste</span>(tmp_color, <span class="at" style="color: #657422;">collapse =</span> <span class="st" style="color: #20794D;">','</span>),</span>
<span id="cb1-26">                   <span class="st" style="color: #20794D;">'" '</span>,</span>
<span id="cb1-27">                   <span class="st" style="color: #20794D;">'arcstart=-90 showlabels=false'</span>)</span>
<span id="cb1-28">  <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">colorlist =</span> out_str)</span>
<span id="cb1-29">})</span>
<span id="cb1-30"></span>
<span id="cb1-31">tmp_matrix <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">as.data.frame</span>(<span class="fu" style="color: #4758AB;">matrix</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">nrow =</span> <span class="fu" style="color: #4758AB;">nrow</span>(piechart_strings),</span>
<span id="cb1-32">                      <span class="at" style="color: #657422;">ncol =</span> <span class="fu" style="color: #4758AB;">ncol</span>(grp_matrix)))</span>
<span id="cb1-33"><span class="fu" style="color: #4758AB;">names</span>(tmp_matrix) <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">colnames</span>(grp_matrix) </span>
<span id="cb1-34">piechart_df <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">cbind</span>(tmp_matrix, piechart_strings)</span>
<span id="cb1-35"></span>
<span id="cb1-36"><span class="co" style="color: #5E5E5E;"># after merging this with the node information to</span></span>
<span id="cb1-37"><span class="co" style="color: #5E5E5E;"># put the right things with the right node</span></span>
<span id="cb1-38"><span class="co" style="color: #5E5E5E;"># this gives **node_vis_df** below</span></span>
<span id="cb1-39">RCy3<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">setNodeShapeDefault</span>(<span class="st" style="color: #20794D;">"ELLIPSE"</span>)</span>
<span id="cb1-40">RCy3<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">setNodeSizeDefault</span>(<span class="dv" style="color: #AD0000;">35</span>)</span>
<span id="cb1-41">RCy3<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">loadTableData</span>(node_vis_df, <span class="at" style="color: #657422;">data.key.column =</span> <span class="st" style="color: #20794D;">"name"</span>, <span class="at" style="color: #657422;">table =</span> <span class="st" style="color: #20794D;">"node"</span>, <span class="at" style="color: #657422;">table.key.column =</span> <span class="st" style="color: #20794D;">"name"</span>)</span>
<span id="cb1-42">RCy3<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">updateStyleMapping</span>(<span class="st" style="color: #20794D;">"default"</span>,</span>
<span id="cb1-43">   RCy3<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">mapVisualProperty</span>(<span class="st" style="color: #20794D;">"NODE_CUSTOMGRAPHICS_1"</span>, <span class="st" style="color: #20794D;">"colorlist"</span>, <span class="st" style="color: #20794D;">"p"</span>))</span></code></pre></div>
</div>




<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-categorycompare2" class="csl-entry">
Flight, Robert M. 2022. <span>“categoryCompare2.”</span> <a href="https://github.com/MoseleyBioinformaticsLab/categoryCompare2">https://github.com/MoseleyBioinformaticsLab/categoryCompare2</a>.
</div>
<div id="ref-rcy3" class="csl-entry">
Gustavsen, Julia A., Pai, Shraddha, Isserlin, Ruth, Demchak, Barry, Pico, and Alexander R. 2019. <span>“RCy3: Network Biology Using Cytoscape from Within r.”</span> <em>F1000Research</em>. <a href="https://doi.org/10.12688/f1000research.20887.3">https://doi.org/10.12688/f1000research.20887.3</a>.
</div>
<div id="ref-enhancedGraphics" class="csl-entry">
Morris JH, Ferrin TE, Kuchinsky A. 2014. <span>“enhancedGraphics: A Cytoscape App for Enhanced Node Graphics.”</span> <em>F1000Research</em>. <a href="https://doi.org/10.12688/f1000research.4460.1">https://doi.org/10.12688/f1000research.4460.1</a>.
</div>
<div id="ref-piechartissue" class="csl-entry">
Pico, Alexander. 2022. <span>“RCy3 GitHub Issue: Equivalent of setNodeImageDirect.”</span> <a href="https://github.com/cytoscape/RCy3/issues/167#issuecomment-1004467137">https://github.com/cytoscape/RCy3/issues/167#issuecomment-1004467137</a>.
</div>
<div id="ref-moseleyruniverse" class="csl-entry">
<span>“The ’Moseleybioinformaticslab’ Universe.”</span> n.d. <a href="https://moseleybioinformaticslab.r-universe.dev/ui#builds">https://moseleybioinformaticslab.r-universe.dev/ui#builds</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2022,
  author = {Robert M Flight},
  title = {Pie {Charts} in {RCy3}},
  date = {2022-01-06},
  url = {https://rmflight.github.io/posts/2022-01-06-pie-charts-in-rcy3},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2022" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2022. <span>“Pie Charts in RCy3.”</span> January 6,
2022. <a href="https://rmflight.github.io/posts/2022-01-06-pie-charts-in-rcy3">https://rmflight.github.io/posts/2022-01-06-pie-charts-in-rcy3</a>.
</div></div></section></div> ]]></description>
  <category>random-code-snippets</category>
  <category>rcy3</category>
  <category>cytoscape</category>
  <category>R</category>
  <guid>https://rmflight.github.io/posts/2022-01-06-pie-charts-in-rcy3/index.html</guid>
  <pubDate>Thu, 06 Jan 2022 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Reusing ggplot2 Colors</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2021-12-21-reusing-ggplot2-colors/index.html</link>
  <description><![CDATA[ 




<p>If you are using {ggplot2} a lot in your code, and don’t want to bother with a custom color scheme (I mean, there are lots of good options), but you are also using non-ggplot2 type plots, and want to reuse the colors.</p>
<p>I frequently encounter this when I’m doing principal component analysis (PCA) <strong>combined</strong> with heatmaps plotted by <code>{ComplexHeatmap}</code>. I’ve colored sample groups in the PCA using <code>{ggplot2}</code> defaults, and now I want those same colors in the <code>{ComplexHeatmap}</code> row or column annotations.</p>
<p>The trick to this is extracting the <code>palette</code> from the color definition you want. For example, very commonly (in biology at least) we might have 2 classes of samples, cases and controls. So we need 2 colors.</p>
<p>When we generated the {ggplot2} plot, we would do something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">ggplot</span>(data_frame, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> var1, <span class="at" style="color: #657422;">y =</span> var2, <span class="at" style="color: #657422;">color =</span> groups))</span></code></pre></div>
</div>
<p>To generate the matching colors for something else, we can do:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">g_colors <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">scale_color_discrete</span>()<span class="sc" style="color: #5E5E5E;">$</span><span class="fu" style="color: #4758AB;">palette</span>(<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
</div>



<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2021,
  author = {Robert M Flight},
  title = {Reusing Ggplot2 {Colors}},
  date = {2021-12-21},
  url = {https://rmflight.github.io/posts/2021-12-21-reusing-ggplot2-colors},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2021" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2021. <span>“Reusing Ggplot2 Colors.”</span> December
21, 2021. <a href="https://rmflight.github.io/posts/2021-12-21-reusing-ggplot2-colors">https://rmflight.github.io/posts/2021-12-21-reusing-ggplot2-colors</a>.
</div></div></section></div> ]]></description>
  <category>random-code-snippets</category>
  <category>ggplot2</category>
  <category>visualization</category>
  <guid>https://rmflight.github.io/posts/2021-12-21-reusing-ggplot2-colors/index.html</guid>
  <pubDate>Tue, 21 Dec 2021 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Migrating Self-Hosted GitLab Projects to GitHub</title>
  <dc:creator>Robert M Flight</dc:creator>
  <link>https://rmflight.github.io/posts/2021-11-25-migrating-self-hosted-gitlab-projects-to-github/index.html</link>
  <description><![CDATA[ 




<section id="moving-to-github" class="level2">
<h2 class="anchored" data-anchor-id="moving-to-github">Moving to GitHub</h2>
<p>Six years ago, we didn’t really look into what the free academic version of GitHub teams provided for private repositories, and instead decided that we should have a self-hosted GitLab instance. Outside of some weird issues around SSL certificates and reverse proxies (i.e.&nbsp;how our web-hosting worked), this actually worked pretty well. However, instead of making our internal projects public, we would frequently move them over to GitHub. I think this is partly because GitHub has become the de-facto location for open-source tool development. However, it seemed to cause some friction to push things between the two platforms. This may be due to our lab not using git as much as we should be, especially the collaborative aspects in issues and pull requests.</p>
<p>After six years, our PI decided to look into the costs for GitHub teams, and discovered that academic teams get free private repos with rather generous amounts of storage and actions minutes. Therefore, we decided it was time to migrate our projects over to GitHub. The PI delegated this task to yours truly.</p>
</section>
<section id="getting-the-list-of-projects" class="level2">
<h2 class="anchored" data-anchor-id="getting-the-list-of-projects">Getting the List of Projects</h2>
<p>To get the list of projects to migrate, I actually copied the project lists from the web interface. If I was doing this again, I would have just asked for the backup locations of our GitLab projects and used those to get the paths for each project. Some projects had changed their names over time and not updated the corresponding path in the database.</p>
</section>
<section id="users-to-ids" class="level2">
<h2 class="anchored" data-anchor-id="users-to-ids">Users to IDs</h2>
<p>Because I used lists from the web interface, I also had to convert the users to actual IDs that define the paths to each project. These weren’t too hard to look up.</p>
</section>
<section id="local-clones" class="level2">
<h2 class="anchored" data-anchor-id="local-clones">Local Clones</h2>
<p>With a full list of projects as “User Name / Project”, and users to IDs, I could easily script converting users to IDs and the full project path, and then system calls to <code>GIT_SSL_NO_VERIFY=TRUE git clone --mirror gitlab_url</code> to make mirror clones of each project. <code>GIT_SSL_NO_VERIFY=TRUE</code> deals with our labs weird SSL certificate issues, while using <code>--mirror</code> means all the branches are pulled, not just the default branch. This is useful to maintain a history of branches over the course of the project development.</p>
<p>Note that this means you get a directory with “projectName.git”, not just “projectName”. If you look inside the “projectName.git” folder, it’s actually all of the git contents, not the usual files you would see for a normal clone operation.</p>
</section>
<section id="duplicate-projects" class="level2">
<h2 class="anchored" data-anchor-id="duplicate-projects">Duplicate Projects</h2>
<p>One thing I didn’t think about when doing this is that users on GitLab can fork each others projects, resulting in duplicate projects. If I had been smart, I would have cloned the projects into user specific directories. Thankfully, we only had a few duplicate projects where I had to do a second clone to a user specific directory.</p>
</section>
<section id="empty-projects" class="level2">
<h2 class="anchored" data-anchor-id="empty-projects">Empty Projects</h2>
<p>Some of the projects are actually empty, either because we thought we were going to do something and didn’t, or someone just wanted issue tracking (that would be me). These we don’t want to push back up to GitHub. However, empty projects with no commits appear to have less than <strong>two</strong> files in the <code>objects</code> directory, and <strong>zero</strong> files in the <code>objects/pack</code> directory.</p>
</section>
<section id="creating-github-repos" class="level2">
<h2 class="anchored" data-anchor-id="creating-github-repos">Creating GitHub Repos</h2>
<p>I used the GitHub command-line-interface tools (<code>gh</code>) to interface with our GitHub organization. After authorizing the <code>gh</code> tools, for each GitLab project I created a corresponding GitHub project, and then moved to the local clone, and did</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">github_locs <span class="ot" style="color: #003B4F;">=</span> <span class="st" style="color: #20794D;">"/path/to/github/repos"</span></span>
<span id="cb1-2">purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">walk</span>(gitlab_project_dirs, <span class="cf" style="color: #003B4F;">function</span>(in_dir){</span>
<span id="cb1-3">  proj_name <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">basename</span>(in_dir)</span>
<span id="cb1-4">  <span class="fu" style="color: #4758AB;">setwd</span>(github_locs)</span>
<span id="cb1-5">  gh_command <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"gh repo create --confirm --private orgName/"</span>, proj_name)</span>
<span id="cb1-6">  <span class="fu" style="color: #4758AB;">system</span>(gh_command)</span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;">setwd</span>(in_dir)</span>
<span id="cb1-8">  gh_loc <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"git@github.com/orgName/"</span>, proj_name)</span>
<span id="cb1-9">  git_push <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"git push --mirror "</span>, gh_loc)</span>
<span id="cb1-10">  <span class="fu" style="color: #4758AB;">system</span>(git_push)</span>
<span id="cb1-11">})</span></code></pre></div>
<p>You can see here I move back and forth between directories a lot, and used system to run <code>gh</code> and <code>git push</code>. It feels a little hacky, but it worked just fine.</p>
</section>
<section id="repos-later" class="level2">
<h2 class="anchored" data-anchor-id="repos-later">190 Repos Later</h2>
<p>I moved over 180 GitLab projects to GitHub repos. With the projects that already had GitHub repos, that means we have over 190 lab repos. That doesn’t count the stuff we left related to testing CI/CD, people learning how to work with GitLab, and 20 copies of the code we use for sys-admin. There were a subset I had to do by hand because of replication issues and not using user directories. I also discovered some missing repos due to a missed letter when copying one lab members user ID.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2021,
  author = {Robert M Flight},
  title = {Migrating {Self-Hosted} {GitLab} {Projects} to {GitHub}},
  date = {2021-11-25},
  url = {https://rmflight.github.io/posts/2021-11-25-migrating-self-hosted-gitlab-projects-to-github},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2021" class="csl-entry quarto-appendix-citeas">
Robert M Flight. 2021. <span>“Migrating Self-Hosted GitLab Projects to
GitHub.”</span> November 25, 2021. <a href="https://rmflight.github.io/posts/2021-11-25-migrating-self-hosted-gitlab-projects-to-github">https://rmflight.github.io/posts/2021-11-25-migrating-self-hosted-gitlab-projects-to-github</a>.
</div></div></section></div> ]]></description>
  <category>version-control</category>
  <category>github</category>
  <category>gitlab</category>
  <guid>https://rmflight.github.io/posts/2021-11-25-migrating-self-hosted-gitlab-projects-to-github/index.html</guid>
  <pubDate>Thu, 25 Nov 2021 05:00:00 GMT</pubDate>
</item>
</channel>
</rss>
