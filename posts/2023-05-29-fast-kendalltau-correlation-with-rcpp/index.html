<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Robert M Flight">
<meta name="dcterms.date" content="2023-05-29">

<title>Deciphering Life: One Bit at a Time - Fast Kendall-tau Correlation with Rcpp</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../static/img/robertmflight_square.jpg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/size.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Deciphering Life: One Bit at a Time</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://docs.google.com/forms/d/e/1FAIpQLSfCHWeFjznvcoPs_zge3fPO3AaRs1WgmyDwi9lREGNSBybWhA/viewform?usp=sf_link">
 <span class="menu-text">Subscribe</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://rmflight.github.io/#category=random-code-snippets">
 <span class="menu-text">RCS</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rmflight"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://orcid.org/0000-0001-8141-7788">
 <span class="menu-text"><i class="ai  ai-orcid" title="" style="color:"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://mastodon.social/@rmflight"><i class="bi bi-mastodon" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Fast Kendall-tau Correlation with Rcpp</h1>
            <p class="subtitle lead"></p><p>How we created a fast implementation of Kendall-tau using Rcpp</p><p></p>
                                <div class="quarto-categories">
                <div class="quarto-category">c++</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">packages</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Robert M Flight <a href="https://orcid.org/0000-0001-8141-7788" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 29, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#tldr" id="toc-tldr" class="nav-link active" data-scroll-target="#tldr">TL;DR</a></li>
  <li><a href="#kendall-tau" id="toc-kendall-tau" class="nav-link" data-scroll-target="#kendall-tau">Kendall Tau??</a></li>
  <li><a href="#need-for-speed" id="toc-need-for-speed" class="nav-link" data-scroll-target="#need-for-speed">Need for Speed!</a></li>
  <li><a href="#differences-of-signs" id="toc-differences-of-signs" class="nav-link" data-scroll-target="#differences-of-signs">Differences of Signs</a>
  <ul class="collapse">
  <li><a href="#r-based-copy-all-pairs" id="toc-r-based-copy-all-pairs" class="nav-link" data-scroll-target="#r-based-copy-all-pairs">R Based, Copy All Pairs</a></li>
  <li><a href="#r-based-increment-count" id="toc-r-based-increment-count" class="nav-link" data-scroll-target="#r-based-increment-count">R Based, Increment Count</a></li>
  <li><a href="#r-based-sort" id="toc-r-based-sort" class="nav-link" data-scroll-target="#r-based-sort">R Based, Sort</a></li>
  <li><a href="#c-based-differences" id="toc-c-based-differences" class="nav-link" data-scroll-target="#c-based-differences">C++ Based, Differences</a></li>
  <li><a href="#c-based-sort" id="toc-c-based-sort" class="nav-link" data-scroll-target="#c-based-sort">C++ Based, Sort</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TL;DR</h2>
<p>Check out our <code>{ICIKendallTau}</code> R package if you want access to a fast version of Kendall-tau correlation in R <span class="citation" data-cites="iciktflight">(<a href="#ref-iciktflight" role="doc-biblioref">Robert M. Flight and Moseley 2022b</a>)</span> with only a few dependencies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_github("moseleybioinformaticslab/icikendalltau)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("microbenchmark")</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ICIKendallTau)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="kendall-tau" class="level2">
<h2 class="anchored" data-anchor-id="kendall-tau">Kendall Tau??</h2>
<p>Yes, Kendall-tau correlation! It is a rank based correlation based on the number of concordant and discordant <strong>pairs</strong> of points. This graphic from Wikipedia explains it really well <span class="citation" data-cites="kendallwikipedia">(<a href="#ref-kendallwikipedia" role="doc-biblioref">Wikipedia, n.d.</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Concordant_Points_Kendall_Correlation.svg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-wikipedia-points" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Concordant_Points_Kendall_Correlation.svg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: All points in the gray area are concordant and all points in the white area are discordant with respect to point X1, Y1. With n = 30 points, there are a total of 435 possible point pairs. In this example there are 395 concordant point pairs and 40 discordant point pairs, leading to a Kendall rank correlation coefficient of 0.816. <span class="citation" data-cites="kendallfigure">(<a href="#ref-kendallfigure" role="doc-biblioref">Retodomax 2021</a>)</span></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>This is a really useful correlation to use if you don’t want to have to worry about how linearly related things are, just whether the points from two samples go in the same direction or not. In addition, we think there is a neat variant we can make to incorporate the presence of missing values when they are missing not at random, and we have a preprint on that that I am working on revising <span class="citation" data-cites="flightInformationContentInformedKendalltauCorrelation2022a">(<a href="#ref-flightInformationContentInformedKendalltauCorrelation2022a" role="doc-biblioref">Robert M. Flight, Bhatt, and Moseley 2022</a>)</span>.</p>
</section>
<section id="need-for-speed" class="level2">
<h2 class="anchored" data-anchor-id="need-for-speed">Need for Speed!</h2>
<p>However, there is an issue with the basic Kendall-tau algorithm. It is slower than molasses going uphill in January (as my parents used to say). Especially as we increase to correlations calculated using tens of thousands of features in both <em>x</em> and <em>y</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>x_large <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">10000</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>y_large <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">10000</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(<span class="fu">cor</span>(x_large, y_large, <span class="at">method =</span> <span class="st">"kendall"</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">times =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: seconds
                                      expr      min       lq     mean   median
 cor(x_large, y_large, method = "kendall") 1.086599 1.104935 1.146724 1.127946
       uq      max neval
 1.137544 1.417044    20</code></pre>
</div>
</div>
<p>That took a full second! And the size of things we frequently want to calculate for eukaryotic based transcriptomics are 2X - 4X that size, and across many, many samples.</p>
<p>So if we can speed it up, that would be awesome.</p>
<p>I will note through all of this work, that I’ve already been through this once in the development of our <code>{ICIKendallTau}</code> package, so I already know the answer. However, I felt it would be useful to work through all of this again to help others who might be looking at similar types of problems. And yes, some of the below code seems silly, but they are first stabs at an implementation.</p>
</section>
<section id="differences-of-signs" class="level2">
<h2 class="anchored" data-anchor-id="differences-of-signs">Differences of Signs</h2>
<p>The simplest way to find the concordant and discordant pairs is to generate all the possible pair indices of the points, and then compare their directions; the same direction of a pair in both X and Y means they are concordant, and different directions means they are discordant.</p>
<p>And in fact, that is exactly what is happening in the C code for R’s covariance / correlation code, iterating over each pair of points (<code>k</code> and <code>n1</code>; snippet shown here from lines 108 - 118 of file src/library/stats/src/cov.c in R-4.3.0).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> <span class="op">{</span> <span class="co">/* Kendall's tau */</span>                      \</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>n1<span class="op">=</span><span class="dv">0</span> <span class="op">;</span> n1 <span class="op">&lt;</span> k <span class="op">;</span> n1<span class="op">++)</span>                   \</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!(</span>ISNAN<span class="op">(</span>xx<span class="op">[</span>n1<span class="op">])</span> <span class="op">||</span> ISNAN<span class="op">(</span>yy<span class="op">[</span>n1<span class="op">])))</span> <span class="op">{</span> \</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>            xm <span class="op">=</span> sign<span class="op">(</span>xx<span class="op">[</span>k<span class="op">]</span> <span class="op">-</span> xx<span class="op">[</span>n1<span class="op">]);</span>          \</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>            ym <span class="op">=</span> sign<span class="op">(</span>yy<span class="op">[</span>k<span class="op">]</span> <span class="op">-</span> yy<span class="op">[</span>n1<span class="op">]);</span>          \</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                                                \</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>            COV_SUM_UPDATE                      \</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>                                       \</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>                                               \</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="r-based-copy-all-pairs" class="level3">
<h3 class="anchored" data-anchor-id="r-based-copy-all-pairs">R Based, Copy All Pairs</h3>
<p>What can we do in R that is similar? We can generate all the pairwise indices, create actual vectors, and then get the signs of the differences maybe?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>reference_ici <span class="ot">=</span> <span class="cf">function</span>(x, y)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  n_x <span class="ot">=</span> <span class="fu">length</span>(x)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  n_y <span class="ot">=</span> <span class="fu">length</span>(y)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  pairs <span class="ot">=</span> <span class="fu">combn</span>(n_x, <span class="dv">2</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  x_pairs <span class="ot">=</span> <span class="fu">rbind</span>(x[pairs[<span class="dv">1</span>, ]],</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                  x[pairs[<span class="dv">2</span>, ]])</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  y_pairs <span class="ot">=</span> <span class="fu">rbind</span>(y[pairs[<span class="dv">1</span>, ]],</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                  y[pairs[<span class="dv">2</span>, ]])</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  x_sign <span class="ot">=</span> <span class="fu">sign</span>(x_pairs[<span class="dv">1</span>, ] <span class="sc">-</span> x_pairs[<span class="dv">2</span>, ])</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  y_sign <span class="ot">=</span> <span class="fu">sign</span>(y_pairs[<span class="dv">1</span>, ] <span class="sc">-</span> y_pairs[<span class="dv">2</span>, ])</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  x_y_sign <span class="ot">=</span> x_sign <span class="sc">*</span> y_sign</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  sum_concordant <span class="ot">=</span> <span class="fu">sum</span>(x_y_sign <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  sum_discordant <span class="ot">=</span> <span class="fu">sum</span>(x_y_sign <span class="sc">&lt;</span> <span class="dv">0</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  x_is_dup <span class="ot">=</span> <span class="fu">duplicated</span>(x)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  x_dup <span class="ot">=</span> x[x_is_dup]</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  x_tied_values_t1 <span class="ot">=</span> <span class="fu">table</span>(x_dup) <span class="sc">+</span> <span class="dv">1</span>;</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  y_is_dup <span class="ot">=</span> <span class="fu">duplicated</span>(y)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  y_dup <span class="ot">=</span> y[y_is_dup]</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  y_tied_values_t2 <span class="ot">=</span> <span class="fu">table</span>(y_dup) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  x_tied_sum_t1 <span class="ot">=</span> <span class="fu">sum</span>(x_tied_values_t1 <span class="sc">*</span> (x_tied_values_t1 <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  y_tied_sum_t2 <span class="ot">=</span> <span class="fu">sum</span>(y_tied_values_t2 <span class="sc">*</span> (y_tied_values_t2 <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  t_0 <span class="ot">=</span> n_x <span class="sc">*</span> (n_x <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  k_denominator <span class="ot">=</span> <span class="fu">sqrt</span>((t_0 <span class="sc">-</span> x_tied_sum_t1) <span class="sc">*</span> (t_0 <span class="sc">-</span> y_tied_sum_t2))</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  k_numerator <span class="ot">=</span> sum_concordant <span class="sc">-</span> sum_discordant</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  k_tau <span class="ot">=</span> k_numerator <span class="sc">/</span> k_denominator</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  k_tau</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see how long this takes as a baseline, and how it compares to the <code>{stats::cor}</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(<span class="fu">cor</span>(x, y, <span class="at">method =</span> <span class="st">"kendall"</span>),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">reference_ici</span>(x, y),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">times =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                          expr       min        lq      mean    median
 cor(x, y, method = "kendall")  11.44744  12.47315  12.84324  13.07735
           reference_ici(x, y) 351.74901 368.20867 392.19704 387.35215
        uq       max neval
  13.28316  13.63687    20
 417.69942 432.55782    20</code></pre>
</div>
</div>
<p>Not so great. Not that surprising, given the main correlation algorithm in R is written in C. Let’s see if we can speed that up. Although our code <strong>seems</strong> vectorized here, there is significant time taken in creating the large matrices to hold the pair indices, and then create the pairs themselves. Therefore, if we can avoid the creation of those large matrices, we can probably improve the speed.</p>
</section>
<section id="r-based-increment-count" class="level3">
<h3 class="anchored" data-anchor-id="r-based-increment-count">R Based, Increment Count</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>iterators_ici <span class="ot">=</span> <span class="cf">function</span>(x, y)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  n_entry <span class="ot">=</span> <span class="fu">length</span>(x)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  sum_concordant <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  sum_discordant <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, n_entry <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq</span>(i <span class="sc">+</span> <span class="dv">1</span>, n_entry)) {</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      sum_concordant <span class="ot">=</span> sum_concordant <span class="sc">+</span>  ((<span class="fu">sign</span>(x[i] <span class="sc">-</span> x[j]) <span class="sc">*</span> <span class="fu">sign</span>(y[i] <span class="sc">-</span> y[j])) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>      sum_discordant <span class="ot">=</span> sum_discordant <span class="sc">+</span> ((<span class="fu">sign</span>(x[i] <span class="sc">-</span> x[j]) <span class="sc">*</span> <span class="fu">sign</span>(y[i] <span class="sc">-</span> y[j])) <span class="sc">&lt;</span> <span class="dv">0</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  k_numerator <span class="ot">=</span> sum_concordant <span class="sc">-</span> sum_discordant</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  x_is_dup <span class="ot">=</span> <span class="fu">duplicated</span>(x)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  x_dup <span class="ot">=</span> x[x_is_dup]</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  x_tied_values_t1 <span class="ot">=</span> <span class="fu">table</span>(x_dup) <span class="sc">+</span> <span class="dv">1</span>;</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  y_is_dup <span class="ot">=</span> <span class="fu">duplicated</span>(y)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  y_dup <span class="ot">=</span> y[y_is_dup]</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  y_tied_values_t2 <span class="ot">=</span> <span class="fu">table</span>(y_dup) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  x_tied_sum_t1 <span class="ot">=</span> <span class="fu">sum</span>(x_tied_values_t1 <span class="sc">*</span> (x_tied_values_t1 <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  y_tied_sum_t2 <span class="ot">=</span> <span class="fu">sum</span>(y_tied_values_t2 <span class="sc">*</span> (y_tied_values_t2 <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  t_0 <span class="ot">=</span> n_entry <span class="sc">*</span> (n_entry <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  k_denominator <span class="ot">=</span> <span class="fu">sqrt</span>((t_0 <span class="sc">-</span> x_tied_sum_t1) <span class="sc">*</span> (t_0 <span class="sc">-</span> y_tied_sum_t2))</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  k_numerator <span class="ot">=</span> sum_concordant <span class="sc">-</span> sum_discordant</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  k_tau <span class="ot">=</span> k_numerator <span class="sc">/</span> k_denominator</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  k_tau</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(<span class="fu">cor</span>(x, y, <span class="at">method =</span> <span class="st">"kendall"</span>),</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">reference_ici</span>(x, y),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">iterators_ici</span>(x, y),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">times =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                          expr       min        lq      mean    median
 cor(x, y, method = "kendall")  11.55812  12.49837  12.83441  12.69495
           reference_ici(x, y) 357.29120 371.24522 387.07048 378.65192
           iterators_ici(x, y) 279.28479 283.04712 289.51380 284.79317
        uq       max neval
  13.19846  14.45556    20
 403.50524 438.96896    20
 290.43204 335.47143    20</code></pre>
</div>
</div>
<p>Allright! We’ve got some decent improvement over our base attempt. We also know, thanks to the SciPy project, that there is a better way to do get the number of concordant and discordant pairs (which is what we use in <code>{ICIKendallTau}</code>). Let’s see if we can manage that in pure R, and see if it helps us out any.</p>
</section>
<section id="r-based-sort" class="level3">
<h3 class="anchored" data-anchor-id="r-based-sort">R Based, Sort</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>sort_ici <span class="ot">=</span> <span class="cf">function</span>(x, y)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  get_sort <span class="ot">=</span> <span class="cf">function</span>(values)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    value_order <span class="ot">=</span> <span class="fu">order</span>(values, <span class="at">method =</span> <span class="st">"radix"</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  compare_self <span class="ot">=</span> <span class="cf">function</span>(x){</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    n_entry <span class="ot">=</span> <span class="fu">length</span>(x)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    match_self <span class="ot">=</span> <span class="fu">vector</span>(<span class="st">"integer"</span>, n_entry)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    match_self[<span class="dv">1</span>] <span class="ot">=</span> 1L</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">2</span>, n_entry)) {</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (x[i] <span class="sc">!=</span> x[(i <span class="sc">-</span> <span class="dv">1</span>)]) {</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        match_self[idx] <span class="ot">=</span> 1L;</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        match_self[idx] <span class="ot">=</span> 0L;</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>      idx <span class="ot">=</span> idx <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(match_self)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  compare_both <span class="ot">=</span> <span class="cf">function</span>(x, y)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    n_entry <span class="ot">=</span> <span class="fu">length</span>(x)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    match_self <span class="ot">=</span> <span class="fu">vector</span>(<span class="st">"integer"</span>, n_entry <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    match_self[<span class="dv">1</span>] <span class="ot">=</span> 1L</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">2</span>, n_entry)) {</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> ((x[i] <span class="sc">!=</span> x[(i <span class="sc">-</span> <span class="dv">1</span>)]) <span class="sc">||</span> (y[i] <span class="sc">!=</span> y[(i <span class="sc">-</span> <span class="dv">1</span>)])) {</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        match_self[idx] <span class="ot">=</span> 1L</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        match_self[idx] <span class="ot">=</span> 0L</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>      idx <span class="ot">=</span> idx <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    match_self[n_entry <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(match_self)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>  count_rank_tie <span class="ot">=</span> <span class="cf">function</span>(ranks)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    dup_ranks <span class="ot">=</span> <span class="fu">duplicated</span>(ranks)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    ranks2 <span class="ot">=</span> ranks[dup_ranks]</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>    number_tied <span class="ot">=</span> <span class="fu">table</span>(ranks2) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">ntie =</span> <span class="fu">sum</span>(number_tied <span class="sc">*</span> (number_tied <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>                <span class="at">t0 =</span> <span class="fu">sum</span>(number_tied <span class="sc">*</span> (number_tied <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> (number_tied <span class="sc">-</span> <span class="dv">2</span>)) <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>                <span class="at">t1 =</span> <span class="fu">sum</span>(number_tied <span class="sc">*</span> (number_tied <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> (<span class="dv">2</span> <span class="sc">*</span> number_tied <span class="sc">+</span> <span class="dv">5</span>))))</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>  which_notzero <span class="ot">=</span> <span class="cf">function</span>(x){</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    notzero <span class="ot">=</span> <span class="fu">vector</span>(<span class="st">"integer"</span>, <span class="fu">length</span>(x))</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">=</span> 1L</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(x))) {</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (x[i] <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>        notzero[idx] <span class="ot">=</span> i <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>        idx <span class="ot">=</span> idx <span class="sc">+</span> 1L</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>    keep_loc <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span>, idx <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>    notzero <span class="ot">=</span> notzero[keep_loc]</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(notzero)</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>  kendall_discordant <span class="ot">=</span> <span class="cf">function</span>(x, y){</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">#x = x4</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">#y = y4</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>    sup <span class="ot">=</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">max</span>(y)</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>    arr <span class="ot">=</span> <span class="fu">vector</span>(<span class="st">"integer"</span>, sup)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">=</span> <span class="fu">length</span>(x)</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">=</span> 1L</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>    dis <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (i <span class="sc">&lt;</span> n) {</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> ((k <span class="sc">&lt;</span> n) <span class="sc">&amp;&amp;</span> (x[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">==</span> x[k <span class="sc">+</span> <span class="dv">1</span>])) {</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>        dis <span class="ot">=</span> dis <span class="sc">+</span> i</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>        idx <span class="ot">=</span> y[k <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> (idx <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>          dis <span class="ot">=</span> dis <span class="sc">-</span> arr[idx <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>          idx <span class="ot">=</span> <span class="fu">bitwAnd</span>(idx, idx <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>        k <span class="ot">=</span> k <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (i <span class="sc">&lt;</span> k) {</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>        idx <span class="ot">=</span> y[i <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> (idx <span class="sc">&lt;</span> sup) {</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>          arr[idx <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">=</span> arr[idx <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>          idx <span class="ot">=</span> idx <span class="sc">+</span> <span class="fu">bitwAnd</span>(idx, (<span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>idx))</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>        i <span class="ot">=</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>    dis</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>  n_entry <span class="ot">=</span> <span class="fu">length</span>(x)</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>  perm_y <span class="ot">=</span> <span class="fu">get_sort</span>(y)</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">=</span> x[perm_y]</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> y[perm_y]</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a>  y3 <span class="ot">=</span> <span class="fu">compare_self</span>(y)</span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a>  y4 <span class="ot">=</span> <span class="fu">cumsum</span>(y3)</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a>  perm_x <span class="ot">=</span> <span class="fu">get_sort</span>(x);</span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">=</span> x[perm_x]</span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>  y4 <span class="ot">=</span> y4[perm_x]</span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>  x3 <span class="ot">=</span> <span class="fu">compare_self</span>(x)</span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>  x4 <span class="ot">=</span> <span class="fu">cumsum</span>(x3)</span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>  obs <span class="ot">=</span> <span class="fu">compare_both</span>(x4, y4)</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>  sum_obs <span class="ot">=</span> <span class="fu">sum</span>(obs)</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>  cnt <span class="ot">=</span> <span class="fu">diff</span>(<span class="fu">which_notzero</span>(obs))</span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>  dis <span class="ot">=</span> <span class="fu">kendall_discordant</span>(x4, y4)</span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>  ntie <span class="ot">=</span> <span class="fu">sum</span>((cnt <span class="sc">*</span> (cnt <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>  x_counts <span class="ot">=</span> <span class="fu">count_rank_tie</span>(x4)</span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>  xtie <span class="ot">=</span> x_counts[[<span class="dv">1</span>]]</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>  x0 <span class="ot">=</span> x_counts[[<span class="dv">2</span>]]</span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">=</span> x_counts[[<span class="dv">3</span>]]</span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a>  y_counts <span class="ot">=</span> <span class="fu">count_rank_tie</span>(y4)</span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>  ytie <span class="ot">=</span> y_counts[[<span class="dv">1</span>]]</span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a>  y0 <span class="ot">=</span> y_counts[[<span class="dv">2</span>]]</span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">=</span> y_counts[[<span class="dv">3</span>]]</span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>  tot <span class="ot">=</span> (n_entry <span class="sc">*</span> (n_entry <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>  con_minus_dis <span class="ot">=</span> tot <span class="sc">-</span> xtie <span class="sc">-</span> ytie <span class="sc">+</span> ntie <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> dis</span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">=</span> con_minus_dis <span class="sc">/</span> <span class="fu">sqrt</span>((tot <span class="sc">-</span> xtie) <span class="sc">*</span> (tot <span class="sc">-</span> ytie))</span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tau)</span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(<span class="fu">cor</span>(x, y, <span class="at">method =</span> <span class="st">"kendall"</span>),</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">reference_ici</span>(x, y),</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">iterators_ici</span>(x, y),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">sort_ici</span>(x, y),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">times =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                          expr        min        lq      mean     median
 cor(x, y, method = "kendall")  11.709530  12.33871  12.63373  12.488732
           reference_ici(x, y) 355.224637 367.46692 387.70370 374.809739
           iterators_ici(x, y) 273.673038 276.02535 280.80801 281.919287
                sort_ici(x, y)   8.760096   8.98937  13.48845   9.395173
        uq       max neval
  12.87524  14.06242    20
 421.60254 441.29727    20
 283.32639 289.62743    20
  10.02100  87.38422    20</code></pre>
</div>
</div>
<p>So, I thought I could implement the sorting method in R, and it would help. It helps, in that it looks like it gets back to C speed, in R. Which isn’t bad, but still isn’t great. This is more than likely because I don’t actually understand the sort based Kendall-tau algorithm on a theoretical level. I was able to copy it from the Python into <code>{Rcpp}</code>, and use a lot of debugging and test cases to make sure I had it implemented correctly, but there are things it is doing that I don’t understand algorithmically, which means I don’t know the best way to create an R-centric method for them. For this example, I literally just translated my previous <code>{Rcpp}</code> code into R, which of course doesn’t necessarily make for fast code.</p>
</section>
<section id="c-based-differences" class="level3">
<h3 class="anchored" data-anchor-id="c-based-differences">C++ Based, Differences</h3>
<p>As a reference, I also implemented the iterating differences algorithm in <code>{Rcpp}</code>. Note that this is not meant to be called by normal users of <code>{ICIKendallTau}</code>, we have it there as a reference to make sure that everything else is working properly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(<span class="fu">cor</span>(x, y, <span class="at">method =</span> <span class="st">"kendall"</span>),</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">reference_ici</span>(x, y),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">iterators_ici</span>(x, y),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">sort_ici</span>(x, y),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                               ICIKendallTau<span class="sc">:::</span><span class="fu">ici_kt_pairs</span>(x, y),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">times =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                               expr        min         lq       mean     median
      cor(x, y, method = "kendall")  11.829116  12.051790  12.872894  12.815848
                reference_ici(x, y) 347.066153 382.616886 400.650147 395.033647
                iterators_ici(x, y) 271.020774 273.111584 284.668516 274.988955
                     sort_ici(x, y)   8.978789   9.393873  10.498460  10.161402
 ICIKendallTau:::ici_kt_pairs(x, y)   4.336266   4.493440   4.806514   4.771994
         uq        max neval
  13.380157  14.977161    20
 418.945940 465.485468    20
 292.175271 342.778833    20
  11.554007  13.605138    20
   4.891025   6.397218    20</code></pre>
</div>
</div>
<p>We can see that is faster than the C-based <code>cor</code> by maybe 2X for 1000 long vectors. Given that <code>ici_kt_pairs</code> has only the single iterator logic for the one correlation method, that makes sense.</p>
</section>
<section id="c-based-sort" class="level3">
<h3 class="anchored" data-anchor-id="c-based-sort">C++ Based, Sort</h3>
<p>Let’s compare the actual sort-based function that is implemented in the <code>{ICIKendallTau}</code> package (which you can see in <span class="citation" data-cites="iciktcode">(<a href="#ref-iciktcode" role="doc-biblioref">Robert M. Flight and Moseley 2022a</a>)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(<span class="fu">cor</span>(x, y, <span class="at">method =</span> <span class="st">"kendall"</span>),</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">reference_ici</span>(x, y),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">iterators_ici</span>(x, y),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">sort_ici</span>(x, y),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">ici_kt</span>(x, y),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">times =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
                          expr        min          lq        mean     median
 cor(x, y, method = "kendall")  11922.472  12154.2850  12992.5719  12916.488
           reference_ici(x, y) 352612.664 380621.5915 399187.5410 393977.078
           iterators_ici(x, y) 266384.200 270873.1345 286840.9181 273214.937
                sort_ici(x, y)   8862.455   9607.5720  10356.4879  10301.072
                  ici_kt(x, y)    216.761    245.6465    273.3186    265.784
         uq        max neval
  13522.521  16085.135    20
 424152.088 444856.163    20
 289494.598 338773.242    20
  11140.300  12458.339    20
    291.693    367.443    20</code></pre>
</div>
</div>
<p>That’s fast! Notice the time moved from <em>milliseconds</em> to <em>microseconds</em>, and the <code>{ICIKendallTau}</code> version is ~ 50X faster than the base R version. Let’s increase the size of our vectors by 10X and compare the run times again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>x_large <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">10000</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>y_large <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">10000</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(<span class="fu">cor</span>(x, y, <span class="at">method =</span> <span class="st">"kendall"</span>),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">cor</span>(x_large, y_large, <span class="at">method =</span> <span class="st">"kendall"</span>),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">ici_kt</span>(x, y),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">ici_kt</span>(x_large, y_large),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">times =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
                                      expr         min           lq
             cor(x, y, method = "kendall")   11654.425   11757.9275
 cor(x_large, y_large, method = "kendall") 1134471.513 1149212.6425
                              ici_kt(x, y)     211.174     228.8565
                  ici_kt(x_large, y_large)    2341.995    2370.5770
         mean      median          uq         max neval
   12088.3777   11816.745   12018.914   15825.794    20
 1201616.7482 1168728.874 1243587.177 1456530.477    20
     259.2706     247.703     265.988     531.182    20
    2643.4572    2392.539    2453.216    4024.673    20</code></pre>
</div>
</div>
<p>The base R method increases time taken by 100X, but the sort based method of <code>{ICIKendallTau}</code> increases only 10X. This is the advantage of the sort method, it’s complexity is <span class="math inline">\(\mathcal{O}(n\log{}n))\)</span>, <em>vs</em> <span class="math inline">\(\mathcal{O}(n^2)\)</span>.</p>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-flightInformationContentInformedKendalltauCorrelation2022a" class="csl-entry" role="doc-biblioentry">
Flight, Robert M., Praneeth S. Bhatt, and Hunter NB Moseley. 2022. <span>“Information-<span>Content</span>-<span>Informed</span> <span>Kendall</span>-Tau <span>Correlation</span>: <span>Utilizing</span> <span>Missing</span> <span>Values</span>.”</span> <a href="https://doi.org/10.1101/2022.02.24.481854">https://doi.org/10.1101/2022.02.24.481854</a>.
</div>
<div id="ref-iciktcode" class="csl-entry" role="doc-biblioentry">
Flight, Robert M, and Hunter NB Moseley. 2022a. <span>“Ici_kt Code.”</span> <a href="https://github.com/MoseleyBioinformaticsLab/ICIKendallTau/blob/main/src/kendallc.cpp#L131">https://github.com/MoseleyBioinformaticsLab/ICIKendallTau/blob/main/src/kendallc.cpp#L131</a>.
</div>
<div id="ref-iciktflight" class="csl-entry" role="doc-biblioentry">
———. 2022b. <span>“ICI-Kt r Package.”</span> <a href="https://github.com/moseleybioinformaticslab/icikendalltau">https://github.com/moseleybioinformaticslab/icikendalltau</a>.
</div>
<div id="ref-kendallfigure" class="csl-entry" role="doc-biblioentry">
Retodomax. 2021. <span>“Kendall-Tau Example Image.”</span> <a href="https://commons.wikimedia.org/wiki/File:Concordant_Points_Kendall_Correlation.svg">https://commons.wikimedia.org/wiki/File:Concordant_Points_Kendall_Correlation.svg</a>.
</div>
<div id="ref-kendallwikipedia" class="csl-entry" role="doc-biblioentry">
Wikipedia. n.d. <span>“Kendall Rank Correlation Coefficient.”</span> <a href="https://en.wikipedia.org/wiki/Kendall_rank_correlation_coefficient">https://en.wikipedia.org/wiki/Kendall_rank_correlation_coefficient</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{mflight2023,
  author = {Robert M Flight},
  title = {Fast {Kendall-tau} {Correlation} with {Rcpp}},
  date = {2023-05-29},
  url = {https://rmflight.github.io/posts/2023-05-29-fast-kendalltau-correlation-with-rcpp},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-mflight2023" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Robert M Flight. 2023. <span>“Fast Kendall-Tau Correlation with
Rcpp.”</span> May 29, 2023. <a href="https://rmflight.github.io/posts/2023-05-29-fast-kendalltau-correlation-with-rcpp">https://rmflight.github.io/posts/2023-05-29-fast-kendalltau-correlation-with-rcpp</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'alternate';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="rmflight/researchblog" data-repo-id="R_kgDOIjZROQ" data-category="Announcements" data-category-id="DIC_kwDOIjZROc4CS6Xp" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="dark" data-lang="en" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>